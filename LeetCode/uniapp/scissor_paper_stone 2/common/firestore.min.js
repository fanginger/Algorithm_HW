!function(o,r){"object"==typeof exports&&"undefined"!=typeof module?r(require("common/app")):"function"==typeof define&&define.amd?define(["common/app"],r):r((o=o||self).firebase)}(this,function(vo){"use strict";try{(function(){function Ao(o,t){function e(){this.constructor=o}r(o,t),o.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}function No(d,o,a,l){return new(a||(a=Promise))(function(s,c){function t(o){try{e(l.next(o))}catch(e){c(e)}}function n(o){try{e(l.throw(o))}catch(e){c(e)}}function e(o){o.done?s(o.value):new a(function(e){e(o.value)}).then(t,n)}e((l=l.apply(d,o||[])).next())})}function ko(d,n){function r(o){return function(e){return function(o){if(c)throw new TypeError("Generator is already executing.");for(;l;)try{if(c=1,p&&(u=2&o[0]?p.return:o[0]?p.throw||((u=p.return)&&u.call(p),0):p.next)&&!(u=u.call(p,o[1])).done)return u;switch(p=0,u&&(o=[2&o[0],u.value]),o[0]){case 0:case 1:u=o;break;case 4:return l.label++,{value:o[1],done:!1};case 5:l.label++,p=o[1],o=[0];continue;case 7:o=l.ops.pop(),l.trys.pop();continue;default:if(!(u=0<(u=l.trys).length&&u[u.length-1])&&(6===o[0]||2===o[0])){l=0;continue}if(3===o[0]&&(!u||o[1]>u[0]&&o[1]<u[3])){l.label=o[1];break}if(6===o[0]&&l.label<u[1]){l.label=u[1],u=o;break}if(u&&l.label<u[2]){l.label=u[2],l.ops.push(o);break}u[2]&&l.ops.pop(),l.trys.pop();continue;}o=n.call(d,l)}catch(e){o=[6,e],p=0}finally{c=u=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,e])}}var l={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},c,p,u,e;return e={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e}function s(e){return"string"==typeof e}function p(o,r){o=o.split("."),r=r||yd;for(var a=0;a<o.length;a++)if(null==(r=r[o[a]]))return null;return r}function d(){}function m(o){var t=typeof o;if("object"==t){if(!o)return"null";if(o instanceof Array)return"array";if(o instanceof Object)return t;var e=Object.prototype.toString.call(o);if("[object Window]"==e)return"object";if("[object Array]"==e||"number"==typeof o.length&&void 0!==o.splice&&void 0!==o.propertyIsEnumerable&&!o.propertyIsEnumerable("splice"))return"array";if("[object Function]"==e||void 0!==o.call&&void 0!==o.propertyIsEnumerable&&!o.propertyIsEnumerable("call"))return"function"}else if("function"==t&&void 0===o.call)return"object";return t}function y(e){return"array"==m(e)}function h(o){var t=m(o);return"array"==t||"object"==t&&"number"==typeof o.length}function g(o){var t=typeof o;return"object"==t&&null!=o||"function"==t}function f(e){return e.call.apply(e.bind,arguments)}function b(o,e){if(!o)throw Error();if(2<arguments.length){var a=Array.prototype.slice.call(arguments,2);return function(){var r=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(r,a),o.apply(e,r)}}return function(){return o.apply(e,arguments)}}function T(){return(T=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?f:b).apply(null,arguments)}function S(o){var e=Array.prototype.slice.call(arguments,1);return function(){var r=e.slice();return r.push.apply(r,arguments),o.apply(this,r)}}function C(r,a){function t(){}t.prototype=a.prototype,r.S=a.prototype,r.prototype=new t,(r.prototype.constructor=r).re=function(o,t){for(var e=Array(arguments.length-2),r=2;r<arguments.length;r++)e[r-2]=arguments[r];return a.prototype[t].apply(o,e)}}function v(){this.i=this.i,this.j=this.j}function A(){return Array.prototype.concat.apply([],arguments)}function N(o){var t=o.length;if(0<t){for(var e=Array(t),a=0;a<t;a++)e[a]=o[a];return e}return[]}function M(e){return /^[\s\xa0]*$/.test(e)}function _(o,t){return-1!=o.indexOf(t)}function O(o,t){return o<t?-1:t<o?1:0}function x(o,t,e){for(var a in o)t.call(e,o[a],a,o)}function q(o){var t={},r;for(r in o)t[r]=o[r];return t}function B(e){for(var t=1,a,s;t<arguments.length;t++){for(a in s=arguments[t])e[a]=s[a];for(var d=0;d<V.length;d++)a=V[d],Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}}function U(e){return U[" "](e),e}function K(){var e=yd.document;return e?e.documentMode:void 0}function j(d){return o=d,r=function(){for(var s=0,l=R($+"").split("."),e=R(d+"").split("."),n=ld(l.length,e.length),r=0;0==s&&r<n;r++){var c=l[r]||"",p=e[r]||"";do{if(c=/(\d*)(\D*)(.*)/.exec(c)||["","","",""],p=/(\d*)(\D*)(.*)/.exec(p)||["","","",""],0==c[0].length&&0==p[0].length)break;s=O(0==c[1].length?0:parseInt(c[1],10),0==p[1].length?0:parseInt(p[1],10))||O(0==c[2].length,0==p[2].length)||O(c[2],p[2]),c=c[3],p=p[3]}while(0==s)}return 0<=s},a=nt,Object.prototype.hasOwnProperty.call(a,o)?a[o]:a[o]=r(o);var o,r,a}function Z(o,t){this.type=o,this.a=this.target=t,this.b=!1,this.hc=!0}function ot(o,t){Z.call(this,o?o.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.f=null,o&&this.g(o,t)}function lt(o,t,e,a,r){this.listener=o,this.proxy=null,this.src=t,this.type=e,this.capture=!!a,this.ya=r,this.key=++pt,this.ja=this.oa=!1}function mt(e){this.src=e,this.a={},this.b=0}function yt(a,t,e,n){for(var r=0,s;r<a.length;++r)if(s=a[r],!s.ja&&s.listener==t&&s.capture==!!e&&s.ya==n)return r;return-1}function ht(a,t,e,s,r){if(s&&s.once)return function s(t,e,n,d,i){if(y(e)){for(var o=0;o<e.length;o++)s(t,e[o],n,d,i);return null}return n=Dt(n),t&&t[ft]?t.Mb(e,n,g(d)?!!d.capture:!!d,i):gt(t,e,n,!0,d,i)}(a,t,e,s,r);if(y(t)){for(var i=0;i<t.length;i++)ht(a,t[i],e,s,r);return null}return e=Dt(e),a&&a[ft]?a.Lb(t,e,g(s)?!!s.capture:!!s,r):gt(a,t,e,!1,s,r)}function gt(d,t,e,l,p,m){if(!t)throw Error("Invalid event type");var o=g(p)?!!p.capture:!!p;if(o&&!Td)return null;var a=Ct(d),y,h;if(a||(d[Sd]=a=new mt(d)),(e=a.add(t,e,l,o,m)).proxy)return e;if(y=It,l=h=Td?function(e){return y.call(h.src,h.listener,e)}:function(e){if(!(e=y.call(h.src,h.listener,e)))return e},(e.proxy=l).src=d,l.listener=e,d.addEventListener)ut||(p=o),void 0===p&&(p=!1),d.addEventListener(t.toString(),l,p);else if(d.attachEvent)d.attachEvent(St(t.toString()),l);else{if(!d.addListener||!d.removeListener)throw Error("addEventListener and attachEvent are unavailable.");d.addListener(l)}return e}function Et(o){if("number"!=typeof o&&o&&!o.ja){var t=o.src;if(t&&t[ft])t.nc(o);else{var e=o.type,a=o.proxy;t.removeEventListener?t.removeEventListener(e,a,o.capture):t.detachEvent?t.detachEvent(St(e),a):t.addListener&&t.removeListener&&t.removeListener(a),(e=Ct(t))?(e.fc(o),0==e.b&&(e.src=null,t[Sd]=null)):o.a()}}}function St(e){return e in vt?vt[e]:vt[e]="on"+e}function Tt(o,t){var e=o.listener,a=o.ya||o.src;return o.oa&&Et(o),e.call(a,t)}function It(o,t){return!!o.ja||(Td?Tt(o,new ot(t,this)):Tt(o,t=new ot(t||p("window.event"),this)))}function Ct(e){return(e=e[Sd])instanceof mt?e:null}function Dt(o){return"function"==m(o)?o:(o[bt]||(o[bt]=function(e){return o.handleEvent(e)}),o[bt])}function At(){v.call(this),this.c=new mt(this),(this.K=this).F=null}function kt(o,t){this.g=100,this.c=o,this.h=t,this.b=0,this.a=null}function wt(){this.b=this.a=null}function Mt(){this.next=this.b=this.a=null}function _t(e){yd.setTimeout(function(){throw e},0)}function Lt(){for(var e;e=Cd.f();){try{e.a.call(e.b)}catch(e){_t(e)}Cd.g(e)}Id=!1}function xt(o,t){At.call(this),this.b=o||1,this.a=t||yd,this.f=T(this.$d,this),this.g=w()}function Vt(o,r,e){if("function"==m(o))e&&(o=T(o,e));else{if(!o||"function"!=typeof o.handleEvent)throw Error("Invalid listener argument");o=T(o.handleEvent,o)}return 2147483647<+r?-1:yd.setTimeout(o,r||0)}function Bt(o,t,e){v.call(this),this.f=null==e?o:T(o,e),this.c=t,this.b=T(this.Cd,this),this.a=[]}function Ut(e){v.call(this),this.b=e,this.a={}}function Qt(){}function Kt(e){Z.call(this,"serverreachability",e)}function Wt(e){jt.dispatchEvent(new Kt(jt,e))}function zt(e){Z.call(this,"statevent",e)}function Ht(e){jt.dispatchEvent(new zt(jt,e))}function Yt(e){Z.call(this,"timingevent",e)}function Xt(o,t){if("function"!=m(o))throw Error("Fn must not be null and must be a function");return yd.setTimeout(function(){o()},t)}function Jt(){}function ee(){}function ne(){Z.call(this,"d")}function oe(){Z.call(this,"c")}function ae(){}function se(o,r,e){this.g=o,this.da=r,this.ca=e||1,this.I=new Ut(this),this.L=45e3,o=Y?125:void 0,this.T=new xt(o),this.J=null,this.b=!1,this.i=this.C=this.f=this.F=this.u=this.U=this.h=null,this.j=[],this.a=null,this.A=0,this.c=this.v=null,this.o=-1,this.l=!1,this.K=0,this.B=null,this.s=this.Y=this.H=!1}function ue(a,t){if(a.forEach&&"function"==typeof a.forEach)a.forEach(t,void 0);else if(h(a)||s(a))k(a,t,void 0);else{if(a.O&&"function"==typeof a.O)var e=a.O();else if(a.D&&"function"==typeof a.D)e=void 0;else if(h(a)||s(a)){e=[];for(var d=a.length,l=0;l<d;l++)e.push(l)}else for(l in e=[],d=0,a)e[d++]=l;l=(d=function(o){if(o.D&&"function"==typeof o.D)return o.D();if(s(o))return o.split("");if(h(o)){for(var t=[],a=o.length,i=0;i<a;i++)t.push(o[i]);return t}for(i in t=[],a=0,o)t[a++]=o[i];return t}(a)).length;for(var c=0;c<l;c++)t.call(void 0,d[c],e&&e[c],a)}}function le(e){this.b={},this.a=[],this.c=0;var t=arguments.length;if(1<t){if(t%2)throw Error("Uneven number of arguments");for(var o=0;o<t;o+=2)this.set(arguments[o],arguments[o+1])}else e&&this.fd(e)}function fe(o,t){return Object.prototype.hasOwnProperty.call(o,t)}function pe(o,t){var e;this.c=this.i=this.b="",this.h=null,this.j=this.g="",this.f=this.l=!1,o instanceof pe?(this.f=void 0===t?o.f:t,this.ma(o.b),this.$a(o.i),this.ka(o.c),this.la(o.h),this.Ba(o.g),this.Za(o.a.Gb()),this.Ya(o.j)):o&&(e=(o+"").match(he))?(this.f=!!t,this.ma(e[1]||"",!0),this.$a(e[2]||"",!0),this.ka(e[3]||"",!0),this.la(e[4]),this.Ba(e[5]||"",!0),this.Za(e[6]||"",!0),this.Ya(e[7]||"",!0)):(this.f=!!t,this.a=new ve(null,this.f))}function me(o,t){return o?t?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function ye(o,r,e){return s(o)?(o=encodeURI(o).replace(r,ge),e&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function ge(e){return"%"+(15&(e=e.charCodeAt(0))>>4).toString(16)+(15&e).toString(16)}function ve(o,t){this.b=this.a=null,this.c=o||null,this.f=!!t}function Ie(e){this.a=e,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function Ce(){this.a=this.b=null}function De(){this.a=new le}function Ne(o){var t=typeof o;return"object"==t&&o||"function"==t?"o"+(o[l]||(o[l]=++c)):t.charAt(0)+o}function Ae(o,t){this.a=o,this.b=t}function ke(e){this.g=e||Te,e=yd.PerformanceNavigationTiming?0<(e=yd.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(yd.Ja&&yd.Ja.Vb&&yd.Ja.Vb()&&yd.Ja.Vb().te),this.f=e?this.g:1,this.a=null,1<this.f&&(this.a=new De),this.b=null,this.c=[]}function Re(){this.b=this.a=void 0}function _e(){this.f=new Re}function Oe(o,t,e,a,r){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,r(a)}catch(e){}}function Pe(e){At.call(this),this.headers=new le,this.l=e||null,this.b=!1,this.v=this.a=null,this.C="",this.h=0,this.f="",this.g=this.B=this.o=this.A=!1,this.u=0,this.s=null,this.J=Le,this.H=this.L=this.I=!1}function xe(e){return"content-type"==e.toLowerCase()}function Be(o,t){return{type:t,lengthComputable:o.lengthComputable,loaded:o.loaded,total:o.total}}function Ue(a,d,l){t:{for(c in l){var c=!1;break t}c=!0}if(c)return a;var p;if(p="",x(l,function(o,t){p+=t,p+=":",p+=o,p+="\r\n"}),l=p,s(a)){if(d=encodeURIComponent(d+""),d+=l=null==l?"":"="+encodeURIComponent(l+"")){if(0>(l=a.indexOf("#"))&&(l=a.length),0>(c=a.indexOf("?"))||l<c){c=l;var u=""}else u=a.substring(c+1,l);l=(a=[a.substr(0,c),u,a.substr(l)])[1],a[1]=d?l?l+"&"+d:d:l,a=a[0]+(a[1]?"?"+a[1]:"")+a[2]}return a}return a.m(d,l),a}function Qe(e){this.gb=22,this.g=[],this.H=new Ce,this.da=this.fb=this.C=this.Ea=this.a=this.Fa=this.j=this.ca=this.f=this.J=this.h=null,this.sc=!0,this.zc=this.L=0,this.uc=!!p("internalChannelParams.failFast",e),this.Ga=this.v=this.s=this.l=this.i=this.b=null,this.eb=!0,this.B=this.jb=this.K=-1,this.Y=this.u=this.A=0,this.tc=p("internalChannelParams.baseRetryDelayMs",e)||5e3,this.Fc=p("internalChannelParams.retryDelaySeedMs",e)||1e4,this.pc=p("internalChannelParams.forwardChannelMaxRetries",e)||2,this.ib=p("internalChannelParams.forwardChannelRequestTimeoutMs",e)||2e4,this.xc=e&&e.ue||void 0,this.F=void 0,this.vc=0,this.T=e&&e.supportsCrossDomainXhr||!1,this.I="",this.c=new ke(e&&e.concurrentRequestLimit),this.U=new _e,this.o=!e||void 0===e.backgroundChannelTest||e.backgroundChannelTest,(this.hb=e&&e.fastHandshake||!1)&&!this.o&&(this.o=!0),e&&e.se&&(this.eb=!1)}function Ke(){}function je(){if(z&&!(10<=+at))throw Error("Environmental error: no available transport.")}function We(o,r){At.call(this),this.a=new Qe(r),this.g=o,this.o=r&&r.testUrl?r.testUrl:function(o){for(var t=o,a=1;a<arguments.length;a++){var s=arguments[a],i;0==s.lastIndexOf("/",0)?t=s:((i=""==t)||(i=0<=(i=t.length-1)&&t.indexOf("/",i)==i),t+=i?s:"/"+s)}return t}(this.g,"test"),this.b=r&&r.messageUrlParams||null,o=r&&r.messageHeaders||null,r&&r.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.a.cd(o),o=r&&r.initMessageHeaders||null,r&&r.messageContentType&&(o?o["X-WebChannel-Content-Type"]=r.messageContentType:o={"X-WebChannel-Content-Type":r.messageContentType}),r&&r.tb&&(o?o["X-WebChannel-Client-Profile"]=r.tb:o={"X-WebChannel-Client-Profile":r.tb}),this.a.Pd(o),(o=r&&r.httpHeadersOverwriteParam)&&!M(o)&&this.a.Nd(o),this.l=r&&r.supportsCrossDomainXhr||!1,this.h=r&&r.sendRawJson||!1,(r=r&&r.httpSessionIdParam)&&!M(r)&&(this.a.Od(r),null!==(o=this.b)&&r in o&&r in(o=this.b)&&delete o[r]),this.f=new He(this)}function Ge(o){ne.call(this);var r=o.__sm__;if(r){t:{for(var e in r){o=e;break t}o=void 0}(this.f=o)?(o=this.f,this.data=null!==r&&o in r?r[o]:void 0):this.data=r}else this.data=o}function ze(){oe.call(this),this.status=1}function He(e){this.a=e}function Ye(){return hn.logLevel===cd.DEBUG?ln.DEBUG:hn.logLevel===cd.SILENT?ln.SILENT:ln.ERROR}function $t(e){e===ln.DEBUG?hn.logLevel=cd.DEBUG:e===ln.ERROR?hn.logLevel=cd.ERROR:e===ln.SILENT?hn.logLevel=cd.SILENT:hn.error("Firestore ("+cn+"): Invalid value passed to `setLogLevel`")}function Ro(o,t){for(var e=[],a=2;a<arguments.length;a++)e[a-2]=arguments[a];if(hn.logLevel<=cd.DEBUG){var n=e.map(Ga);hn.debug.apply(hn,["Firestore ("+cn+") ["+o+"]: "+t].concat(n))}}function Ho(o){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];if(hn.logLevel<=cd.ERROR){var a=t.map(Ga);hn.error.apply(hn,["Firestore ("+cn+"): "+o].concat(a))}}function Ga(o){if("string"==typeof o)return o;var e=Ad.getPlatform();try{return e.formatJSON(o)}catch(e){return o}}function rn(o){var t="FIRESTORE ("+cn+") INTERNAL ASSERTION FAILED: "+o;throw Ho(t),new Error(t)}function dn(o,t){o||rn(t)}function pn(){return Ad.getPlatform().emptyByteString}function mn(o,a){function e(){var e="This constructor is private.";throw a&&(e+=" ",e+=a),new En(bn.INVALID_ARGUMENT,e)}for(var t in e.prototype=o.prototype,o)o.hasOwnProperty(t)&&(e[t]=o[t]);return e}function yn(o,t){return Object.prototype.hasOwnProperty.call(o,t)}function gn(o,t){return void 0===o?t:o}function fn(o,t){for(var e in o)if(Object.prototype.hasOwnProperty.call(o,e)){var a=+e;isNaN(a)||t(a,o[e])}}function Tn(o,t){for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&t(e,o[e])}function In(o){for(var t in dn(null!=o&&"object"==typeof o,"isEmpty() expects object parameter."),o)if(Object.prototype.hasOwnProperty.call(o,t))return!1;return!0}function Cn(o,t){if(0!==t.length)throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() does not support arguments, but was called with "+Bn(t.length,"argument")+".")}function Dn(o,t,e){if(t.length!==e)throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires "+Bn(e,"argument")+", but was called with "+Bn(t.length,"argument")+".")}function vn(o,t,e){if(t.length<e)throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires at least "+Bn(e,"argument")+", but was called with "+Bn(t.length,"argument")+".")}function An(o,t,e,a){if(t.length<e||t.length>a)throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires between "+e+" and "+a+" arguments, but was called with "+Bn(t.length,"argument")+".")}function Nn(o,t,e,a){Pn(o,t,Vn(e)+" argument",a)}function kn(o,t,e,a){void 0!==a&&Nn(o,t,e,a)}function wn(o,t,e,a){Pn(o,t,e+" option",a)}function Rn(o,t,e,a){void 0!==a&&wn(o,t,e,a)}function Mn(o,t,e,a,r){void 0!==a&&function(a,t,e,n,r){if(!(n instanceof Array))throw new En(bn.INVALID_ARGUMENT,"Function "+a+"() requires its "+t+" option to be an array, but it was: "+On(n));for(var i=0;i<n.length;++i)if(!r(n[i]))throw new En(bn.INVALID_ARGUMENT,"Function "+a+"() requires all "+t+" elements to be "+e+", but the value at index "+i+" was: "+On(n[i]))}(o,t,e,a,r)}function _n(o,t,e,a,r){void 0!==a&&function(d,t,e,n,r){for(var i=[],o=0,l=r,s;o<l.length;o++){if(s=l[o],s===n)return;i.push(On(s))}var p=On(n);throw new En(bn.INVALID_ARGUMENT,"Invalid value "+p+" provided to function "+d+"() for option \""+e+"\". Acceptable values: "+i.join(", "))}(o,0,e,a,r)}function Pn(o,t,e,a){if("object"===t?!Ln(a):"non-empty string"===t?"string"!=typeof a||""===a:typeof a!=t){var r=On(a);throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires its "+e+" to be of type "+t+", but it was: "+r)}}function Ln(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function On(o){if(void 0===o)return"undefined";if(null===o)return"null";if("string"==typeof o)return 20<o.length&&(o=o.substring(0,20)+"..."),JSON.stringify(o);if("number"==typeof o||"boolean"==typeof o)return""+o;if("object"!=typeof o)return"function"==typeof o?"a function":rn("Unknown wrong type: "+typeof o);if(o instanceof Array)return"an array";var r=function(o){if(o.constructor){var t=/function\s+([^\s(]+)\s*\(/.exec(o.constructor.toString());if(t&&1<t.length)return t[1]}return null}(o);return r?"a custom "+r+" object":"an object"}function xn(o,t,e){if(void 0===e)throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires a valid "+Vn(t)+" argument, but it was undefined.")}function qn(e,o,a){Tn(o,function(o){if(0>a.indexOf(o))throw new En(bn.INVALID_ARGUMENT,"Unknown option '"+o+"' passed to function "+e+"(). Available options: "+a.join(", "))})}function Fn(o,t,e,a){var r=On(a);return new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires its "+Vn(e)+" argument to be a "+t+", but it was: "+r)}function Vn(e){return 1===e?"first":2===e?"second":3===e?"third":e+"th"}function Bn(o,t){return o+" "+t+(1===o?"":"s")}function Un(o,t){return o<t?-1:t<o?1:0}function Qn(o,t){if(o.length!==t.length)return!1;for(var e=0;e<o.length;e++)if(!o[e].isEqual(t[e]))return!1;return!0}function Kn(e){return e+"\0"}function Wn(){if("undefined"==typeof Uint8Array)throw new En(bn.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function Gn(){if(!Ad.getPlatform().base64Available)throw new En(bn.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}function jn(o,t){return o===t?0!==o||1/o==1/t:o!=o&&t!=t}function kr(e){return null==e}function jr(e){return Qr(e)&&e<=Ur&&Br<=e}function Wr(e){return e instanceof Fr?e.internalValue.slice():[]}function Hn(e){return e===bn.OK?rn("Treated status OK as error"):e!==bn.CANCELLED&&e!==bn.UNKNOWN&&e!==bn.DEADLINE_EXCEEDED&&e!==bn.RESOURCE_EXHAUSTED&&e!==bn.INTERNAL&&e!==bn.UNAVAILABLE&&e!==bn.UNAUTHENTICATED&&(!(e!==bn.INVALID_ARGUMENT&&e!==bn.NOT_FOUND&&e!==bn.ALREADY_EXISTS&&e!==bn.PERMISSION_DENIED&&e!==bn.FAILED_PRECONDITION&&e!==bn.ABORTED&&e!==bn.OUT_OF_RANGE&&e!==bn.UNIMPLEMENTED&&e!==bn.DATA_LOSS)||rn("Unknown status code: "+e))}function Yn(e){if(void 0===e)return Ho("GRPC error has no .code"),bn.UNKNOWN;return e===Ni.OK?bn.OK:e===Ni.CANCELLED?bn.CANCELLED:e===Ni.UNKNOWN?bn.UNKNOWN:e===Ni.DEADLINE_EXCEEDED?bn.DEADLINE_EXCEEDED:e===Ni.RESOURCE_EXHAUSTED?bn.RESOURCE_EXHAUSTED:e===Ni.INTERNAL?bn.INTERNAL:e===Ni.UNAVAILABLE?bn.UNAVAILABLE:e===Ni.UNAUTHENTICATED?bn.UNAUTHENTICATED:e===Ni.INVALID_ARGUMENT?bn.INVALID_ARGUMENT:e===Ni.NOT_FOUND?bn.NOT_FOUND:e===Ni.ALREADY_EXISTS?bn.ALREADY_EXISTS:e===Ni.PERMISSION_DENIED?bn.PERMISSION_DENIED:e===Ni.FAILED_PRECONDITION?bn.FAILED_PRECONDITION:e===Ni.ABORTED?bn.ABORTED:e===Ni.OUT_OF_RANGE?bn.OUT_OF_RANGE:e===Ni.UNIMPLEMENTED?bn.UNIMPLEMENTED:e===Ni.DATA_LOSS?bn.DATA_LOSS:rn("Unknown status code: "+e)}function Xn(){return xd}function Jn(){return Xn()}function $n(){return Ri}function Ii(){return Oi}function Ai(){for(var a=[],t=0;t<arguments.length;t++)a[t]=arguments[t];for(var s=Li,d=0,l=a,i;d<l.length;d++)i=l[d],s=s.add(i);return s}function ki(){return qi}function Mi(){return new br(dr.comparator)}function ro(){return new br(dr.comparator)}function io(o,t){dn(!kr(o),t+" is missing")}function ho(e){return"number"==typeof e?e:"string"==typeof e?+e:rn("can't parse "+e)}function lo(o,t,e){return t===e||!t&&e in o}function po(o){for(var t="",r=0;r<o.length;r++)0<t.length&&(t=_o(t)),t=Mo(o.get(r),t);return _o(t)}function Mo(a,t){for(var e=t,s=a.length,r=0,d;r<s;r++)d=a.charAt(r),e+="\0"===d?"\x01\x10":"\x01"===d?"\x01\x11":d;return e}function _o(e){return e+"\x01"+"\x01"}function Oo(n){var t=n.length;if(dn(2<=t,"Invalid path "+n),2===t)return dn(n.charAt(0)==="\x01"&&n.charAt(1)==="\x01","Non-empty path "+n+" had length 2"),lr.EMPTY_PATH;for(var e=[],r="",d=0,l;d<t;){switch(l=n.indexOf("\x01",d),(0>l||t-2<l)&&rn("Invalid encoded resource path: \""+n+"\""),n.charAt(l+1)){case"\x01":var c=n.substring(d,l),s=void 0;0===r.length?s=c:(s=r+=c,r=""),e.push(s);break;case"\x10":r+=n.substring(d,l),r+="\0";break;case"\x11":r+=n.substring(d,l+1);break;default:rn("Invalid encoded resource path: \""+n+"\"");}d=l+2}return new lr(e)}function Po(i,d,t){var e=Sa.prefixForPath(d,t.path),o=e[1],a=IDBKeyRange.lowerBound(e),l=!1;return Qo(i).iterate({range:a,keysOnly:!0},function(a,t,e){var n=a[0],r=a[1];a[2],n===d&&r===o&&(l=!0),e.done()}).next(function(){return l})}function Vo(d,t,e){var n=d.store(Ea.store),r=d.store(Sa.store),i=[],o=IDBKeyRange.only(e.batchId),a=0,m=n.iterate({range:o},function(o,t,e){return a++,e.delete()});i.push(m.next(function(){dn(1==a,"Dangling document-mutation reference found: Missing batch "+e.batchId)}));for(var u=[],c=0,y=e.mutations;c<y.length;c++){var l=y[c],g=Sa.key(t,l.key.path,e.batchId);i.push(r.delete(g)),u.push(l.key)}return xo.waitFor(i).next(function(){return u})}function Bo(e){return e instanceof Uint8Array?(dn("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),e.toString()):e}function Uo(e){return Ha.getStore(e,Ea.store)}function Qo(e){return Ha.getStore(e,Sa.store)}function Ko(e){return Ha.getStore(e,wa.store)}function jo(o){return new xo(function(r,a){o.onsuccess=function(o){var t=o.target.result;r(t)},o.onerror=function(e){a(e.target.error)}})}function Zo(e){return Ha.getStore(e,Na.store)}function ea(e){return zo.getStore(e,ka.store).get(ka.key).next(function(e){return dn(null!==e,"Missing metadata row."),e})}function na(e){return ea(e).next(function(e){return e.highestListenSequenceNumber})}function ra(e){return Ha.getStore(e,Aa.store)}function ia(e){return Ha.getStore(e,Da.store)}function ca(e){return Ha.getStore(e,Ca.store)}function la(e){return Ha.getStore(e,Ma.store)}function fa(e){return e.path.toArray()}function pa(o){var t;if(o.document)t=o.document;else if(o.unknownDocument)t=o.unknownDocument;else{if(!o.noDocument)throw rn("Unknown remote document type");t=o.noDocument}return JSON.stringify(t).length}function da(e){e.createObjectStore(Aa.store,{keyPath:Aa.keyPath}).createIndex(Aa.documentTargetsIndex,Aa.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(Na.store,{keyPath:Na.keyPath}).createIndex(Na.queryTargetsIndexName,Na.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(ka.store)}function _a(e){return Ha.getStore(e,Ra.store)}function qa(s,t){var e=s[0],n=s[1],r=t[0],i=t[1],o=Un(e,r);return 0===o?Un(n,i):o}function Va(t){return No(this,void 0,void 0,function(){return ko(this,function(){if((o=t).code!==bn.FAILED_PRECONDITION||o.message!=="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.")throw t;var o;return Ro("IndexedDbPersistence","Unexpectedly lost primary lease"),[2]})})}function Xa(e){return e.store(ba.store)}function Ja(e){return e.store(Oa.store)}function $a(o,t){return ra(o).put((e=t,a=o.currentSequenceNumber,new Aa(0,po(e.path),a)));var e,a}function _i(e){return function(a,t){if("object"!=typeof a||null===a)return!1;for(var e=a,n=0,s=t,i;n<s.length;n++)if(i=s[n],i in e&&"function"==typeof e[i])return!0;return!1}(e,["next","error","complete"])}function Pi(e){switch(e){case Tl.Set:case Tl.MergeSet:case Tl.Update:return!0;case Tl.Argument:return!1;default:throw rn("Unexpected case for UserDataSource: "+e);}}function xi(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof or||e instanceof ir||e instanceof zn||e instanceof Cl||e instanceof cl)}function Fi(o,t,e){if(!xi(e)||!Ln(e)){var a=On(e);throw"an object"===a?t.createError(o+" a custom object"):t.createError(o+" "+a)}}function Bi(o,t){if(t instanceof rl)return t._internalPath;if("string"==typeof t)return ts(o,t);throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function ts(o,e){try{return function(o){if(0<=o.search(al))throw new En(bn.INVALID_ARGUMENT,"Invalid field path ("+o+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(rl.bind.apply(rl,[void 0].concat(o.split("."))))}catch(e){throw new En(bn.INVALID_ARGUMENT,"Invalid field path ("+o+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var r=Ns(e);throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() called with invalid data. "+r)}}function Ns(e){return e instanceof Error?e.message:e.toString()}function ed(o,t){if(void 0===t)return{merge:!1};if(qn(o,t,["merge","mergeFields"]),Rn(o,"boolean","merge",t.merge),Mn(o,"mergeFields","a string or a FieldPath",t.mergeFields,function(e){return"string"==typeof e||e instanceof rl}),void 0!==t.mergeFields&&void 0!==t.merge)throw new En(bn.INVALID_ARGUMENT,"Invalid options passed to function "+o+"(): You cannot specify both \"merge\" and \"mergeFields\".");return t}function td(o,t){return void 0===t?{}:(qn(o,t,["serverTimestamps"]),_n(o,0,"serverTimestamps",t.serverTimestamps,["estimate","previous","none"]),t)}function od(o,t){kn(o,"object",1,t),t&&(qn(o,t,["source"]),_n(o,0,"source",t.source,["default","server","cache"]))}function rd(o,t,e){if(t instanceof Ml){if(t.firestore!==e)throw new En(bn.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}throw Fn(o,"DocumentReference",1,t)}function ad(e){e.INTERNAL.registerService("firestore",function(e){return new kl(e)},function(o){dn(o&&"object"==typeof o,"shallowCopy() expects object parameter.");var t={};for(var e in o)Object.prototype.hasOwnProperty.call(o,e)&&(t[e]=o[e]);return t}(jl))}var nd=Number.POSITIVE_INFINITY,id=Number.NEGATIVE_INFINITY,sd=Math.min,dd=Math.floor,ld=Math.max,cd,pd;vo=vo&&vo.hasOwnProperty("default")?vo.default:vo,(pd=cd||(cd={}))[pd.DEBUG=0]="DEBUG",pd[pd.VERBOSE=1]="VERBOSE",pd[pd.INFO=2]="INFO",pd[pd.WARN=3]="WARN",pd[pd.ERROR=4]="ERROR",pd[pd.SILENT=5]="SILENT";var ud=cd.INFO,e=function(o,t){for(var e=[],a=2;a<arguments.length;a++)e[a-2]=arguments[a];if(!(t<o.logLevel)){var n=new Date().toISOString();switch(t){case cd.DEBUG:case cd.VERBOSE:console.log.apply(console,["["+n+"]  "+o.name+":"].concat(e));break;case cd.INFO:console.info.apply(console,["["+n+"]  "+o.name+":"].concat(e));break;case cd.WARN:console.warn.apply(console,["["+n+"]  "+o.name+":"].concat(e));break;case cd.ERROR:console.error.apply(console,["["+n+"]  "+o.name+":"].concat(e));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+t+")");}}},n=function(){function o(o){this.name=o,this._logLevel=ud,this._logHandler=e}return Object.defineProperty(o.prototype,"logLevel",{get:function(){return this._logLevel},set:function(e){if(!(e in cd))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=e},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"logHandler",{get:function(){return this._logHandler},set:function(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e},enumerable:!0,configurable:!0}),o.prototype.debug=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];this._logHandler.apply(this,[this,cd.DEBUG].concat(o))},o.prototype.log=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];this._logHandler.apply(this,[this,cd.VERBOSE].concat(o))},o.prototype.info=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];this._logHandler.apply(this,[this,cd.INFO].concat(o))},o.prototype.warn=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];this._logHandler.apply(this,[this,cd.WARN].concat(o))},o.prototype.error=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];this._logHandler.apply(this,[this,cd.ERROR].concat(o))},o}(),r=function(o,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,t){o.__proto__=t}||function(o,t){for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e])})(o,t)},md="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?{}:self:global:window,u=u||{},yd=md,l="closure_uid_"+(1e9*Math.random()>>>0),c=0,w=Date.now||function(){return+new Date},D;v.prototype.i=!1,v.prototype.La=function(){!this.i&&(this.i=!0,this.G(),0)&&(this[l]||(this[l]=++c))},v.prototype.G=function(){if(this.j)for(;this.j.length;)this.j.shift()()};var hd=Array.prototype.indexOf?function(o,t){return Array.prototype.indexOf.call(o,t,void 0)}:function(o,t){if(s(o))return s(t)&&1==t.length?o.indexOf(t,0):-1;for(var e=0;e<o.length;e++)if(e in o&&o[e]===t)return e;return-1},k=Array.prototype.forEach?function(o,t,e){Array.prototype.forEach.call(o,t,e)}:function(a,t,e){for(var n=a.length,r=s(a)?a.split(""):a,i=0;i<n;i++)i in r&&t.call(e,r[i],i,a)},R=String.prototype.trim?function(e){return e.trim()}:function(e){return /^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]},L;t:{var gd=yd.navigator;if(gd){var F=gd.userAgent;if(F){L=F;break t}}L=""}var V=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"];U[" "]=d;var Q=_(L,"Opera"),z=_(L,"Trident")||_(L,"MSIE"),H=_(L,"Edge"),Y=H||z,X=_(L,"Gecko")&&(!_(L.toLowerCase(),"webkit")||_(L,"Edge"))&&!(_(L,"Trident")||_(L,"MSIE"))&&!_(L,"Edge"),J=_(L.toLowerCase(),"webkit")&&!_(L,"Edge"),$,fd;t:{var bd="",Ed=(fd=L,X?/rv:([^\);]+)(\)|;)/.exec(fd):H?/Edge\/([\d\.]+)/.exec(fd):z?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(fd):J?/WebKit\/(\S+)/.exec(fd):Q?/(?:Version)[ \/]?(\S+)/.exec(fd):void 0);if(Ed&&(bd=Ed?Ed[1]:""),z){var et=K();if(null!=et&&et>parseFloat(bd)){$=et+"";break t}}$=bd}var nt={},it=yd.document,at;at=it&&z?K()||("CSS1Compat"==it.compatMode?parseInt($,10):5):void 0;var Td=!z||9<=+at,st=z&&!j("9"),ut=function(){if(!yd.addEventListener||!Object.defineProperty)return!1;var o=!1,r=Object.defineProperty({},"passive",{get:function(){o=!0}});try{yd.addEventListener("test",d,r),yd.removeEventListener("test",d,r)}catch(e){}return o}();Z.prototype.c=function(){this.hc=!1},C(ot,Z);var ct={2:"touch",3:"pen",4:"mouse"};ot.prototype.g=function(o,t){var a=this.type=o.type,n=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(!(this.target=o.target||o.srcElement,this.a=t,t=o.relatedTarget))"mouseover"==a?t=o.fromElement:"mouseout"==a&&(t=o.toElement);else if(X){t:{try{U(t.nodeName);var r=!0;break t}catch(e){}r=!1}r||(t=null)}this.relatedTarget=t,this.screenY=n?(this.clientX=void 0===n.clientX?n.pageX:n.clientX,this.clientY=void 0===n.clientY?n.pageY:n.clientY,this.screenX=n.screenX||0,n.screenY||0):(this.clientX=void 0===o.clientX?o.pageX:o.clientX,this.clientY=void 0===o.clientY?o.pageY:o.clientY,this.screenX=o.screenX||0,o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=s(o.pointerType)?o.pointerType:ct[o.pointerType]||"",(this.f=o).defaultPrevented&&this.c()},ot.prototype.c=function(){ot.S.c.call(this);var e=this.f;if(e.preventDefault)e.preventDefault();else if(e.returnValue=!1,st)try{(e.ctrlKey||112<=e.keyCode&&123>=e.keyCode)&&(e.keyCode=-1)}catch(e){}};var ft="closure_listenable_"+(0|1e6*Math.random()),pt=0;lt.prototype.a=function(){this.ja=!0,this.ya=this.src=this.proxy=this.listener=null},(D=mt.prototype).add=function(s,d,l,n,r){var i=s.toString();(s=this.a[i])||(s=this.a[i]=[],this.b++);var o=yt(s,d,n,r);return-1<o?(d=s[o],l||(d.oa=!1)):((d=new lt(d,this.src,i,!!n,r)).oa=l,s.push(d)),d},D.Sc=function(o,a,s,n){if((o=o.toString())in this.a){var r=this.a[o];-1<(a=yt(r,a,s,n))&&(r[a].a(),Array.prototype.splice.call(r,a,1),0==r.length&&(delete this.a[o],this.b--))}},D.fc=function(o){var t=o.type;if(t in this.a){var e=this.a[t],r=hd(e,o),a;(a=0<=r)&&Array.prototype.splice.call(e,r,1),a&&(o.a(),0==this.a[t].length&&(delete this.a[t],this.b--))}},D.Tc=function(){for(var o in this.a){for(var t=this.a[o],e=0;e<t.length;e++)t[e].a();delete this.a[o],this.b--}},D.Rc=function(o,a,e,n){var r=-1;return(o=this.a[o.toString()])&&(r=yt(o,a,e,n)),-1<r?o[r]:null};var Sd="closure_lm_"+(0|1e6*Math.random()),vt={},bt="__closure_events_fn_"+(1e9*Math.random()>>>0);C(At,v),At.prototype[ft]=!0,(D=At.prototype).addEventListener=function(o,t,e,a){ht(this,o,t,e,a)},D.removeEventListener=function(o,t,e,a){!function s(t,d,l,c,p){if(y(d))for(var o=0;o<d.length;o++)s(t,d[o],l,c,p);else c=g(c)?!!c.capture:!!c,l=Dt(l),t&&t[ft]?t.Qc(d,l,c,p):t&&(t=Ct(t))&&(d=t.Rc(d,l,c,p))&&Et(d)}(this,o,t,e,a)},D.dispatchEvent=function(d){var l=this.F,c;if(l)for(c=[];l;l=l.F)c.push(l);l=this.K;var p=d.type||d;if(s(d))d=new Z(d,l);else if(d instanceof Z)d.target=d.target||l;else{var r=d;B(d=new Z(p,l),r)}if(r=!0,c)for(var u=c.length-1,m;!d.b&&0<=u;u--)m=d.a=c[u],r=m.ua(p,!0,d)&&r;if(d.b||(r=(m=d.a=l).ua(p,!0,d)&&r,d.b||(r=m.ua(p,!1,d)&&r)),c)for(u=0;!d.b&&u<c.length;u++)r=(m=d.a=c[u]).ua(p,!1,d)&&r;return r},D.G=function(){At.S.G.call(this),this.Id(),this.F=null},D.Lb=function(o,t,e,a){return this.c.add(o+"",t,!1,e,a)},D.Mb=function(o,t,e,a){return this.c.add(o+"",t,!0,e,a)},D.Qc=function(o,t,e,a){this.c.Sc(o+"",t,e,a)},D.nc=function(e){this.c.fc(e)},D.Id=function(){this.c&&this.c.Tc()},D.ua=function(d,l,e){if(!(d=this.c.a[d+""]))return!0;d=d.concat();for(var n=!0,c=0,p;c<d.length;++c)if(p=d[c],p&&!p.ja&&p.capture==l){var u=p.listener,a=p.ya||p.src;p.oa&&this.nc(p),n=!1!==u.call(a,e)&&n}return n&&0!=e.hc};var Nt=yd.JSON.stringify;kt.prototype.get=function(){if(0<this.b){this.b--;var e=this.a;this.a=e.next,e.next=null}else e=this.c();return e},kt.prototype.f=function(e){this.h(e),this.b<this.g&&(this.b++,e.next=this.a,this.a=e)};var Rt=new kt(function(){return new Mt},function(e){e.reset()}),Pt;wt.prototype.add=function(o,t){var e=this.c();e.set(o,t),this.b?this.b.next=e:this.a=e,this.b=e},wt.prototype.f=function(){var e=null;return this.a&&(e=this.a,this.a=this.a.next,this.a||(this.b=null),e.next=null),e},wt.prototype.g=function(e){Rt.f(e)},wt.prototype.c=function(){return Rt.get()},Mt.prototype.set=function(o,t){this.a=o,this.b=t,this.next=null};var Id=!(Mt.prototype.reset=function(){this.next=this.b=this.a=null}),Cd=new wt;C(xt,At),(D=xt.prototype).wa=!1,D.P=null,D.$d=function(){if(this.wa){var e=w()-this.g;0<e&&e<.8*this.b?this.P=this.a.setTimeout(this.f,this.b-e):(this.P&&(this.a.clearTimeout(this.P),this.P=null),this.Gc(),this.wa&&(this.Na(),this.start()))}},D.Gc=function(){this.dispatchEvent("tick")},D.start=function(){this.wa=!0,this.P||(this.P=this.a.setTimeout(this.f,this.b),this.g=w())},D.Na=function(){this.wa=!1,this.P&&(this.a.clearTimeout(this.P),this.P=null)},D.G=function(){xt.S.G.call(this),this.Na(),delete this.a},C(Bt,v),(D=Bt.prototype).Ca=!1,D.ec=0,D.ba=null,D.Hc=function(){this.a=arguments,this.ba||this.ec?this.Ca=!0:this.yb()},D.Pc=function(){this.ba&&(yd.clearTimeout(this.ba),this.ba=null,this.Ca=!1,this.a=[])},D.G=function(){Bt.S.G.call(this),this.Pc()},D.Cd=function(){this.ba=null,this.Ca&&!this.ec&&(this.Ca=!1,this.yb())},D.yb=function(){this.ba=Vt(this.b,this.c),this.f.apply(null,this.a)},C(Ut,v);var Ft=[];(D=Ut.prototype).Jb=function(o,t,e){this.wd(o,t,e)},D.wd=function(o,t,a){y(t)||(t&&(Ft[0]=t.toString()),t=Ft);for(var n=0,s;n<t.length&&(s=ht(o,t[n],a||this.handleEvent,!1,this.b||this),!!s);n++)this.a[s.key]=s},D.Kb=function(){x(this.a,function(o,t){this.a.hasOwnProperty(t)&&Et(o)},this),this.a={}},D.G=function(){Ut.S.G.call(this),this.Kb()},D.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var jt=new At;C(Kt,Z),C(zt,Z),C(Yt,Z);var Gt={NO_ERROR:0,ae:1,he:2,ge:3,de:4,fe:5,ie:6,qc:7,TIMEOUT:8,le:9},Zt={ce:"complete",pe:"success",rc:"error",qc:"abort",ne:"ready",oe:"readystatechange",TIMEOUT:"timeout",je:"incrementaldata",me:"progress",ee:"downloadprogress",qe:"uploadprogress"};Jt.prototype.a=null,Jt.prototype.c=function(){return this.a||(this.a={})};var te={OPEN:"a",be:"b",rc:"c",ke:"d"},ie;C(ne,Z),C(oe,Z),C(ae,Jt),ae.prototype.b=function(){return new XMLHttpRequest},ie=new ae;var Dd={},ce={};(D=se.prototype).ha=function(e){this.J=e},D.setTimeout=function(e){this.L=e},D.Xc=function(e){this.K=e},D.Qd=function(e){this.j=e},D.cb=function(o,t){this.F=1,this.f=o.N().za(),this.i=t,this.H=!0,this.ic(null)},D.bb=function(o,t,e){this.F=1,this.f=o.N().za(),this.i=null,this.H=t,this.ic(e)},D.ic=function(e){this.u=w(),this.fa(),this.C=this.f.N(),this.C.Aa("t",this.ca),this.A=0,this.a=this.g.sa(this.g.Da()?e:null),0<this.K&&(this.B=new Bt(T(this.oc,this,this.a),this.K)),this.I.Jb(this.a,"readystatechange",this.Hd),e=this.J?q(this.J):{},this.i?(this.v||(this.v="POST"),e["Content-Type"]="application/x-www-form-urlencoded",this.a.xa(this.C,this.v,this.i,e)):(this.v="GET",this.a.xa(this.C,this.v,null,e)),Wt(1)},D.Hd=function(o){o=o.target;var r=this.B;r&&3==o.W()?r.Hc():this.oc(o)},D.oc=function(e){try{e==this.a&&this.Ed()}catch(e){}},D.Ed=function(){var o=this.a.W(),t=this.a.Db(),r=this.a.aa();if(!(3>o)&&(3!=o||Y||this.a.va()))if(this.l||4!=o||7==t||Wt(8==t||0>=r?3:2),this.pa(),this.o=r=this.a.aa(),t=this.a.va(),this.b=200==r){if(this.Td()){if(!(r=this.Kc()))return this.b=!1,this.c=3,Ht(12),this.Z(),void this.ta();this.s=!0,this.Wa(r)}this.H?(this.vb(o,t),Y&&this.b&&3==o&&this.Yd()):this.Wa(t),4==o&&this.Z(),this.b&&!this.l&&(4==o?this.g.Va(this):(this.b=!1,this.fa()))}else 400==r&&0<t.indexOf("Unknown SID")?(this.c=3,Ht(12)):(this.c=0,Ht(13)),this.Z(),this.ta()},D.Td=function(){return this.Y&&!this.s},D.Kc=function(){if(this.a){var e=this.a.ga("X-HTTP-Initial-Response");if(e&&!M(e))return e}return null},D.Md=function(){this.Y=!0},D.vb=function(o,t){for(var e=!0,a;!this.l&&this.A<t.length;){if(a=this.Lc(t),a==ce){4==o&&(this.c=4,Ht(14),e=!1);break}if(a==Dd){this.c=4,Ht(15),e=!1;break}this.Wa(a)}4==o&&0==t.length&&(this.c=1,Ht(16),e=!1),this.b=this.b&&e,e||(this.Z(),this.ta())},D.Gd=function(){if(this.a){var o=this.a.W(),t=this.a.va();this.A<t.length&&(this.pa(),this.vb(o,t),this.b&&4!=o&&this.fa())}},D.Yd=function(){this.I.Jb(this.T,"tick",this.Gd),this.T.start()},D.Lc=function(o){var r=this.A,a=o.indexOf("\n",r);return-1==a?ce:(r=+o.substring(r,a),isNaN(r)?Dd:(a+=1)+r>o.length?ce:(o=o.substr(a,r),this.A=a+r,o))},D.Ld=function(e){this.F=2,this.f=e.N().za(),e=!1,yd.navigator&&yd.navigator.sendBeacon&&(e=yd.navigator.sendBeacon(this.f.toString(),"")),!e&&yd.Image&&(new Image().src=this.f,e=!0),e||(this.a=this.g.sa(null),this.a.xa(this.f)),this.u=w(),this.fa()},D.cancel=function(){this.l=!0,this.Z()},D.Kd=function(e){e&&this.setTimeout(e),this.h&&(this.pa(),this.fa())},D.fa=function(){this.U=w()+this.L,this.mc(this.L)},D.mc=function(e){if(null!=this.h)throw Error("WatchDog timer not null");this.h=Xt(T(this.Dd,this),e)},D.pa=function(){this.h&&(yd.clearTimeout(this.h),this.h=null)},D.Dd=function(){this.h=null;var e=w();0<=e-this.U?this.md():this.mc(this.U-e)},D.md=function(){2!=this.F&&(Wt(3),Ht(17)),this.Z(),this.c=2,this.ta()},D.ta=function(){this.g.Tb()||this.l||this.g.Va(this)},D.Z=function(){this.pa();var e=this.B;e&&"function"==typeof e.La&&e.La(),this.B=null,this.T.Na(),this.I.Kb(),this.a&&(e=this.a,this.a=null,e.abort(),e.La())},D.Wa=function(e){try{this.g.bc(this,e),Wt(4)}catch(e){}},(D=le.prototype).D=function(){this.Ka();for(var o=[],t=0;t<this.a.length;t++)o.push(this.b[this.a[t]]);return o},D.O=function(){return this.Ka(),this.a.concat()},D.Ra=function(e){return fe(this.b,e)},D.hd=function(){return 0==this.c},D.gd=function(){this.b={},this.c=this.a.length=0},D.Qb=function(e){fe(this.b,e)&&(delete this.b[e],this.c--,this.a.length>2*this.c&&this.Ka())},D.Ka=function(){if(this.c!=this.a.length){for(var o=0,a=0,i;o<this.a.length;)i=this.a[o],fe(this.b,i)&&(this.a[a++]=i),o++;this.a.length=a}if(this.c!=this.a.length){var s={};for(a=o=0;o<this.a.length;)fe(s,i=this.a[o])||(s[this.a[a++]=i]=1),o++;this.a.length=a}},D.get=function(o,t){return fe(this.b,o)?this.b[o]:t},D.set=function(o,t){fe(this.b,o)||(this.c++,this.a.push(o)),this.b[o]=t},D.fd=function(o){if(o instanceof le)for(var t=o.O(),r=0;r<t.length;r++)this.set(t[r],o.get(t[r]));else for(t in o)this.set(t,o[t])},D.forEach=function(a,t){for(var e=this.O(),n=0;n<e.length;n++){var s=e[n],i=this.get(s);a.call(t,i,s,this)}},D.Pb=function(){return new le(this)};var he=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;(D=pe.prototype).toString=function(){var o=[],t=this.b;t&&o.push(ye(t,de,!0),":");var r=this.c;return(r||"file"==t)&&(o.push("//"),(t=this.i)&&o.push(ye(t,de,!0),"@"),o.push(encodeURIComponent(r+"").replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(r=this.h)&&o.push(":",r+"")),(r=this.g)&&(this.Sa()&&"/"!=r.charAt(0)&&o.push("/"),o.push(ye(r,"/"==r.charAt(0)?we:be,!0))),(r=this.Ic())&&o.push("?",r),(r=this.j)&&o.push("#",ye(r,Se)),o.join("")},D.resolve=function(d){var t=this.N(),e=d.qd();e?t.ma(d.b):e=d.rd(),e?t.$a(d.i):e=d.Sa(),e?t.ka(d.c):e=d.od();var l=d.g;if(e)t.la(d.h);else if(e=d.Sb()){if("/"!=l.charAt(0))if(this.Sa()&&!this.Sb())l="/"+l;else{var c=t.g.lastIndexOf("/");-1!=c&&(l=t.g.substr(0,c+1)+l)}if(".."==(c=l)||"."==c)l="";else if(_(c,"./")||_(c,"/.")){l=0==c.lastIndexOf("/",0),c=c.split("/");for(var p=[],o=0,u;o<c.length;)u=c[o++],"."==u?l&&o==c.length&&p.push(""):".."==u?((1<p.length||1==p.length&&""!=p[0])&&p.pop(),l&&o==c.length&&p.push("")):(p.push(u),l=!0);l=p.join("/")}else l=c}return e?t.Ba(l):e=d.pd(),e?t.Za(d.a.Gb()):e=d.nd(),e&&t.Ya(d.j),t},D.N=function(){return new pe(this)},D.ma=function(o,t){this.M(),(this.b=t?me(o,!0):o)&&(this.b=this.b.replace(/:$/,""))},D.qd=function(){return!!this.b},D.$a=function(o,t){this.M(),this.i=t?me(o):o},D.rd=function(){return!!this.i},D.ka=function(o,t){this.M(),this.c=t?me(o,!0):o},D.Sa=function(){return!!this.c},D.la=function(e){if(this.M(),e){if(e=+e,isNaN(e)||0>e)throw Error("Bad port number "+e);this.h=e}else this.h=null},D.od=function(){return null!=this.h},D.Ba=function(o,t){this.M(),this.g=t?me(o,!0):o},D.Sb=function(){return!!this.g},D.pd=function(){return""!==this.a.toString()},D.Za=function(o,r){this.M(),o instanceof ve?(this.a=o,this.a.Oc(this.f)):(r||(o=ye(o,Ee)),this.a=new ve(o,this.f))},D.Ic=function(){return this.a.toString()},D.m=function(o,t){this.M(),this.a.set(o,t)},D.Aa=function(o,t){this.M(),y(t)||(t=[t+""]),this.a.lc(o,t)},D.Ya=function(o,t){this.M(),this.j=t?me(o):o},D.nd=function(){return!!this.j},D.za=function(){return this.M(),this.m("zx",dd(2147483648*Math.random()).toString(36)+Math.abs(dd(2147483648*Math.random())^w()).toString(36)),this},D.M=function(){if(this.l)throw Error("Tried to modify a read-only Uri")};var de=/[#\/\?@]/g,be=/[#\?:]/g,we=/[#\?]/g,Ee=/[#\?@]/g,Se=/#/g;(D=ve.prototype).V=function(){if(!this.a&&(this.a=new le,this.b=0,this.c)){var o=this;!function(a,s){if(a){a=a.split("&");for(var e=0;e<a.length;e++){var d=a[e].indexOf("="),r=null;if(0<=d){var l=a[e].substring(0,d);r=a[e].substring(d+1)}else l=a[e];s(l,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(this.c,function(r,t){o.add(decodeURIComponent(r.replace(/\+/g," ")),t)})}},D.add=function(o,r){this.V(),this.ia(),o=this.$(o);var e=this.a.get(o);return e||this.a.set(o,e=[]),e.push(r),this.b+=1,this},D.Ib=function(e){this.V(),e=this.$(e),this.a.Ra(e)&&(this.ia(),this.b-=this.a.get(e).length,this.a.Qb(e))},D.Hb=function(e){return this.V(),e=this.$(e),this.a.Ra(e)},D.forEach=function(o,a){this.V(),this.a.forEach(function(r,n){k(r,function(e){o.call(a,e,n,this)},this)},this)},D.O=function(){this.V();for(var a=this.a.D(),t=this.a.O(),e=[],n=0;n<t.length;n++)for(var s=a[n],i=0;i<s.length;i++)e.push(t[n]);return e},D.D=function(o){this.V();var r=[];if(s(o))this.Hb(o)&&(r=A(r,this.a.get(this.$(o))));else{o=this.a.D();for(var a=0;a<o.length;a++)r=A(r,o[a])}return r},D.set=function(o,r){return this.V(),this.ia(),o=this.$(o),this.Hb(o)&&(this.b-=this.a.get(o).length),this.a.set(o,[r]),this.b+=1,this},D.get=function(o,r){return o&&0<(o=this.D(o)).length?o[0]+"":r},D.lc=function(o,t){this.Ib(o),0<t.length&&(this.ia(),this.a.set(this.$(o),N(t)),this.b+=t.length)},D.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var s=[],t=this.a.O(),e=0;e<t.length;e++){var d=t[e],l=encodeURIComponent(d+"");d=this.D(d);for(var i=0,c;i<d.length;i++)c=l,""!==d[i]&&(c+="="+encodeURIComponent(d[i]+"")),s.push(c)}return this.c=s.join("&")},D.ia=function(){this.c=null},D.Gb=function(){var e=new ve;return e.c=this.c,this.a&&(e.a=this.a.Pb(),e.b=this.b),e},D.$=function(e){return e=e+"",this.f&&(e=e.toLowerCase()),e},D.Oc=function(e){e&&!this.f&&(this.V(),this.ia(),this.a.forEach(function(o,t){var e=t.toLowerCase();t!=e&&(this.Ib(t),this.lc(e,o))},this)),this.f=e},C(function(){},function(){}),(D=Ie.prototype).R=null,D.Wc=function(e){this.h=e},D.Vc=function(o){this.i=o,o=this.a.Cb(this.i),Ht(3);var r=this.a.H.b;null==r?(o.Aa("MODE","init"),!this.a.o&&this.a.j&&o.Aa("X-HTTP-Session-Id",this.a.j),this.b=new se(this,void 0,void 0),this.b.ha(this.h),this.b.bb(o,!1,null),this.R=0):(this.f=this.a.Oa(r[0]),this.R=1,this.rb())},D.rb=function(){var o=this.a.H.a;if(null!=o)Ht(4),o?(Ht(10),this.a.na(this,!1)):(Ht(11),this.a.na(this,!0));else{this.b=new se(this,void 0,void 0),this.b.ha(this.h),o=this.a.Bb(this.f,this.i),Ht(4),o.Aa("TYPE","xmlhttp");var r=this.a.j,e=this.a.Fa;r&&e&&o.m(r,e),this.b.bb(o,!1,this.f)}},D.sa=function(e){return this.a.sa(e)},D.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},D.Tb=function(){return!1},D.bc=function(o,t){if(!(this.c=o.o,0==this.R))1==this.R&&(this.g?Ht(6):"11111"==t?(Ht(5),this.g=!0,this.Ac()&&(this.c=200,this.b.cancel(),Ht(11),this.a.na(this,!0))):(Ht(7),this.g=!1));else if(this.Uc(o),t){try{var e=this.a.U.a(t)}catch(e){return void this.a.ab(this)}this.f=this.a.Oa(e[0])}else this.a.ab(this)},D.Va=function(){this.c=this.b.o,this.b.b?0==this.R?(this.R=1,this.rb()):1==this.R&&(this.g?(Ht(11),this.a.na(this,!0)):(Ht(10),this.a.na(this,!1))):(0==this.R?Ht(8):1==this.R&&Ht(9),this.a.ab(this))},D.Uc=function(o){if(!this.a.o&&(o=o.a)){var r=o.ga("X-Client-Wire-Protocol");this.l=r||null,this.a.j&&(o=o.ga("X-HTTP-Session-Id"))&&this.a.kc(o)}},D.Da=function(){return this.a.Da()},D.Pa=function(){return this.a.Pa()},D.Ac=function(){return!z||10<=+at},(D=De.prototype).add=function(e){this.a.set(Ne(e),e)},D.ed=function(e){this.a.Qb(Ne(e))},D.jd=function(){this.a.gd()},D.Rb=function(){return this.a.hd()},D.Ob=function(e){return this.a.Ra(Ne(e))},D.D=function(){return this.a.D()};var Te=10;(D=ke.prototype).kb=function(e){!this.a&&(_(e,"spdy")||_(e,"quic")||_(e,"h2"))&&(this.f=this.g,this.a=new De,this.b&&(this.Ha(this.b),this.b=null))},D.Ub=function(){return!!this.b||!!this.a&&this.a.a.c>=this.f},D.Mc=function(){return this.b?1:this.a?this.a.a.c:0},D.Ta=function(e){return this.b?this.b==e:!!this.a&&this.a.Ob(e)},D.Ha=function(e){this.a?this.a.add(e):this.b=e},D.gc=function(e){this.b&&this.b==e?this.b=null:this.a&&this.a.Ob(e)&&this.a.ed(e)},D.cancel=function(){this.c=this.Xb(),this.b?(this.b.cancel(),this.b=null):this.a&&!this.a.Rb()&&(k(this.a.D(),function(e){e.cancel()}),this.a.jd())},D.Xb=function(){if(null!=this.b)return this.c.concat(this.b.j);if(null==this.a||this.a.Rb())return N(this.c);var o=this.c;return k(this.a.D(),function(e){o=o.concat(e.j)}),o},D.wc=function(e){this.c=this.c.concat(e)},D.Bc=function(){this.c.length=0},Re.prototype.stringify=function(e){return yd.JSON.stringify(e,this.a)},Re.prototype.parse=function(e){return yd.JSON.parse(e,this.b)},_e.prototype.b=function(o,a,t){var r=t||"";try{ue(o,function(o,t){var e=o;g(o)&&(e=Nt(o)),a.push(r+t+"="+encodeURIComponent(e))})}catch(e){throw a.push(r+"type="+encodeURIComponent("_badmap")),e}},_e.prototype.c=function(d,t,e){for(var n=-1,l;;){l=["count="+t],-1==n?0<t?(n=d[0].a,l.push("ofs="+n)):n=0:l.push("ofs="+n);for(var c=!0,p=0;p<t;p++){var m=d[p].a,y=d[p].b;if(0>(m-=n))n=ld(0,d[p].a-100),c=!1;else try{this.b(y,l,"req"+m+"_")}catch(o){e&&e(y)}}if(c)return l.join("&")}},_e.prototype.a=function(e){return this.f.parse(e)};var Me=yd.JSON.parse;C(Pe,At);var Le="",qe=/^https?$/i,Fe=["POST","PUT"];(D=Pe.prototype).Sd=function(e){this.I=e},D.xa=function(a,d,l,c){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.C+"; newUri="+a);d=d?d.toUpperCase():"GET",this.C=a,this.f="",this.h=0,this.A=!1,this.b=!0,this.a=this.Ec(),this.v=this.l?this.l.c():ie.c(),this.a.onreadystatechange=T(this.ac,this),this.L&&"onprogress"in this.a&&(this.a.onprogress=T(function(e){this.Zb(e,!0)},this),this.a.upload&&(this.a.upload.onprogress=T(this.Zb,this)));try{this.B=!0,this.a.open(d,a+"",!0),this.B=!1}catch(e){return void this.Ab(e)}a=l||"";var p=this.headers.Pb(),o;c&&ue(c,function(o,t){p.set(t,o)}),c=function(o){t:{for(var t=xe,a=o.length,n=s(o)?o.split(""):o,r=0;r<a;r++)if(r in n&&t.call(void 0,n[r],r,o)){t=r;break t}t=-1}return 0>t?null:s(o)?o.charAt(t):o[t]}(p.O()),l=yd.FormData&&a instanceof yd.FormData,!(0<=hd(Fe,d))||c||l||p.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),p.forEach(function(o,t){this.a.setRequestHeader(t,o)},this),this.J&&(this.a.responseType=this.J),"withCredentials"in this.a&&this.a.withCredentials!==this.I&&(this.a.withCredentials=this.I);try{this.sb(),0<this.u&&((this.H=(o=this.a,z&&j(9)&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.a.timeout=this.u,this.a.ontimeout=T(this.Nb,this)):this.s=Vt(this.Nb,this.u,this)),this.o=!0,this.a.send(a),this.o=!1}catch(e){this.Ab(e)}},D.Ec=function(){return this.l?this.l.b():ie.b()},D.Nb=function(){void 0!==u&&this.a&&(this.f="Timed out after "+this.u+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},D.Ab=function(e){this.b=!1,this.a&&(this.g=!0,this.a.abort(),this.g=!1),this.f=e,this.h=5,this.xb(),this.qa()},D.xb=function(){this.A||(this.A=!0,this.dispatchEvent("complete"),this.dispatchEvent("error"))},D.abort=function(e){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=e||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),this.qa())},D.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),this.qa(!0)),Pe.S.G.call(this)},D.ac=function(){this.i||(this.B||this.o||this.g?this.$b():this.Bd())},D.Bd=function(){this.$b()},D.$b=function(){if(this.b&&void 0!==u&&(!this.v[1]||4!=this.W()||2!=this.aa()))if(this.o&&4==this.W())Vt(this.ac,0,this);else if(this.dispatchEvent("readystatechange"),this.td()){this.b=!1;try{this.vd()?(this.dispatchEvent("complete"),this.dispatchEvent("success")):(this.h=6,this.f=this.Fb()+" ["+this.aa()+"]",this.xb())}finally{this.qa()}}},D.Zb=function(o,t){this.dispatchEvent(Be(o,"progress")),this.dispatchEvent(Be(o,t?"downloadprogress":"uploadprogress"))},D.qa=function(o){if(this.a){this.sb();var t=this.a,e=this.v[0]?d:null;this.v=this.a=null,o||this.dispatchEvent("ready");try{t.onreadystatechange=e}catch(e){}}},D.sb=function(){this.a&&this.H&&(this.a.ontimeout=null),this.s&&(yd.clearTimeout(this.s),this.s=null)},D.td=function(){return 4==this.W()},D.vd=function(){var o=this.aa();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break t;default:t=!1;}return t||0===o&&!this.ud()},D.ud=function(){var e=(this.C+"").match(he)[1]||null;return!e&&yd.self&&yd.self.location&&(e=(e=yd.self.location.protocol).substr(0,e.length-1)),qe.test(e?e.toLowerCase():"")},D.W=function(){return this.a?this.a.readyState:0},D.aa=function(){try{return 2<this.W()?this.a.status:-1}catch(e){return-1}},D.Fb=function(){try{return 2<this.W()?this.a.statusText:""}catch(e){return""}},D.va=function(){try{return this.a?this.a.responseText:""}catch(e){return""}},D.Nc=function(o){if(this.a){var t=this.a.responseText;return o&&0==t.indexOf(o)&&(t=t.substring(o.length)),Me(t)}},D.ga=function(e){return this.a?this.a.getResponseHeader(e):null},D.Db=function(){return this.h},D.dd=function(){return s(this.f)?this.f:this.f+""},(D=Qe.prototype).qb=8,D.w=1,D.bd=function(o,t,e){Ht(0),this.Ea=t,this.ca=e||{},this.o&&(this.H.b=[],this.H.a=!1),this.Dc(o)},D.Qa=function(){if(this.lb(),3==this.w){var o=this.L++,t=this.C.N();t.m("SID",this.I),t.m("RID",o),t.m("TYPE","terminate"),this.ea(t),new se(this,o,void 0).Ld(t)}this.Yb()},D.Dc=function(o){this.v=new Ie(this),null===this.f&&this.v.Wc(this.h);var t=o;this.f&&this.h&&(t=Ue(o,this.f,this.h)),this.v.Vc(t)},D.Cc=function(){this.C=this.Cb(this.Ea),this.Ma()},D.lb=function(){this.v&&(this.v.abort(),this.v=null),this.a&&(this.a.cancel(),this.a=null),this.l&&(yd.clearTimeout(this.l),this.l=null),this.ra(),this.c.cancel(),this.i&&(yd.clearTimeout(this.i),this.i=null)},D.cd=function(e){this.h=e},D.Pd=function(e){this.J=e},D.Nd=function(e){this.f=e},D.Od=function(e){this.j=e},D.kc=function(e){this.Fa=e},D.Rd=function(){this.T=!0},D.jc=function(e){this.b=e},D.sd=function(){return!this.Ga},D.Xa=function(e){this.g.push(new Ae(this.zc++,e)),3==this.w&&this.Ma()},D.Jc=function(){return this.uc?0:this.pc},D.Tb=function(){return 0==this.w},D.Ma=function(){this.c.Ub()||this.i||(this.i=Xt(T(this.dc,this),0),this.A=0)},D.xd=function(e){return!(this.c.Mc()>=this.c.f-(this.i?1:0))&&(this.i?(this.g=e.j.concat(this.g),!0):!(1==this.w||2==this.w||this.A>=this.Jc())&&(this.i=Xt(T(this.dc,this,e),this.Eb(this.A)),this.A++,!0))},D.dc=function(e){this.i=null,this.Xd(e)},D.Xd=function(e){1==this.w?e||(this.Fd(),this.w=2):3==this.w&&(e?this.Wb(e):0==this.g.length||this.c.Ub()||this.Wb())},D.Fd=function(){this.L=dd(1e5*Math.random());var o=this.L++,t=new se(this,o,void 0),e=this.h;this.J&&(e?B(e=q(e),this.J):e=this.J),null===this.f&&t.ha(e);var a=this.wb(t),r=this.C.N();r.m("RID",o),0<this.gb&&r.m("CVER",this.gb),this.o&&this.j&&r.m("X-HTTP-Session-Id",this.j),this.ea(r),this.f&&e&&Ue(r,this.f,e),this.c.Ha(t),this.hb?(r.m("$req",a),r.m("SID","null"),t.Md(),t.cb(r,null)):t.cb(r,a)},D.Wb=function(o){var r=Math.round,a;a=o?o.da:this.L++;var i=this.C.N();i.m("SID",this.I),i.m("RID",a),i.m("AID",this.K),this.ea(i),this.f&&this.h&&Ue(i,this.f,this.h),a=new se(this,a,this.A+1),null===this.f&&a.ha(this.h),o&&this.Jd(o),o=this.wb(a),a.setTimeout(r(.5*this.ib)+r(.5*this.ib*Math.random())),this.c.Ha(a),a.cb(i,o)},D.ea=function(o){this.b&&ue({},function(r,t){o.m(t,r)})},D.wb=function(o){var t=sd(this.g.length,1e3),e=this.b?T(this.b.yc,this.b,this):null;return e=this.U.c(this.g,t,e),o.Qd(this.g.splice(0,t)),e},D.Jd=function(e){this.g=e.j.concat(this.g)},D.zb=function(){if(!this.a&&!this.l){this.Y=1;var o=this.cc;Pt||(t=yd.Promise.resolve(void 0),Pt=function(){t.then(Lt)}),Id||(Pt(),Id=!0),Cd.add(o,this),this.u=0}var t},D.Ua=function(){return!(this.a||this.l||3<=this.u)&&(this.Y++,this.l=Xt(T(this.cc,this),this.Eb(this.u)),this.u++,!0)},D.cc=function(){this.l=null,this.Vd()},D.Vd=function(){this.a=new se(this,"rpc",this.Y),null===this.f&&this.a.ha(this.h),this.a.Xc(this.vc);var e=this.fb.N();e.m("RID","rpc"),e.m("SID",this.I),e.m("CI",this.Ga?"0":"1"),e.m("AID",this.K),this.ea(e),e.m("TYPE","xmlhttp"),this.f&&this.h&&Ue(e,this.f,this.h),this.F&&this.a.setTimeout(this.F),this.a.bb(e,!0,this.da)},D.na=function(o,t){var e=o.l;e&&this.c.kb(e),this.Ga=this.eb&&t,this.B=o.c,this.Cc()},D.ab=function(e){this.B=e.c,this.X(2)},D.bc=function(o,t){if(0!=this.w&&(this.a==o||this.c.Ta(o)))if(this.B=o.o,!o.s&&this.c.Ta(o)&&3==this.w){try{var e=this.U.a(t)}catch(o){e=null}y(e)&&3==e.length?this.ld(e,o):this.X(11)}else(o.s||this.a==o)&&this.ra(),M(t)||(e=this.U.a(t),this.Ad(e,o))},D.ld=function(o,t){0==o[0]?this.kd(t):(this.jb=o[1],0<this.jb-this.K&&this.Ud(o[2])&&!this.s&&(this.s=Xt(T(this.yd,this),6e3)))},D.kd=function(e){if(!this.l){if(this.a){if(!(this.a.u+3e3<e.u))return;this.ra(),this.a.cancel(),this.a=null}this.Ua(),Ht(18)}},D.Ud=function(e){return 37500>e&&!this.sd()&&0==this.u},D.Oa=function(e){return this.sc?this.b?this.b.$c(e):e:null},D.yd=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,this.Ua(),Ht(19))},D.ra=function(){null!=this.s&&(yd.clearTimeout(this.s),this.s=null)},D.Va=function(o){var t=null;if(this.a==o){this.ra(),this.a=null;var a=2}else{if(!this.c.Ta(o))return;t=o.j,this.c.gc(o),a=1}if(this.B=o.o,0!=this.w)if(o.b)1==a?(a=w()-o.u,jt.dispatchEvent(new Yt(jt,o.i?o.i.length:0,a,this.A)),this.Ma()):this.zb();else{var i=o.c;if(3==i||0==i&&0<this.B||!(1==a&&this.xd(o)||2==a&&this.Ua()))switch(t&&0<t.length&&this.c.wc(t),i){case 1:this.X(5);break;case 4:this.X(10);break;case 3:this.X(6);break;default:this.X(2);}}},D.Eb=function(o){var t=this.tc+dd(Math.random()*this.Fc);return this.Pa()||(t*=2),t*o},D.ad=function(o){if(this.o&&(o=o.a)){var r=o.ga("X-Client-Wire-Protocol");r&&this.c.kb(r),this.j&&(o=o.ga("X-HTTP-Session-Id"))&&(this.kc(o),this.C.m(this.j,o))}},D.Ad=function(a,t){for(var e=this.b&&this.b.Ia?[]:null,n=0,s;n<a.length;n++)if(s=a[n],this.K=s[0],s=s[1],2!=this.w)3==this.w&&("stop"==s[0]||"close"==s[0]?(e&&0!=e.length&&(this.b.Ia(this,e),e.length=0),"stop"==s[0]?this.X(7):this.Qa()):"noop"!=s[0]&&(e?e.push(s):this.b&&this.b.ob(s)),this.u=0);else if("c"==s[0]){this.I=s[1],this.da=this.Oa(s[2]);var d=s[3];null!=d&&(this.qb=d),null!=(s=s[5])&&"number"==typeof s&&0<s&&(this.F=1.5*s),this.ad(t),this.w=3,this.b&&this.b.pb(),this.Wd(t)}else"stop"!=s[0]&&"close"!=s[0]||this.X(7);e&&0!=e.length&&this.b.Ia(this,e)},D.Wd=function(e){this.fb=this.Bb(this.da,this.Ea),e.s?(this.c.gc(e),e.Kd(this.F),this.a=e):this.zb()},D.X=function(s){if(2==s){var t=null;this.b&&(t=null);var d=T(this.Zd,this);t||(t=new pe("//www.google.com/images/cleardot.gif"),yd.location&&"http"==yd.location.protocol||t.ma("https"),t.za()),n=t.toString(),l=d,c=new Qt,(p=new Image).onload=S(Oe,c,p,"TestLoadImage: loaded",!0,l),p.onerror=S(Oe,c,p,"TestLoadImage: error",!1,l),p.onabort=S(Oe,c,p,"TestLoadImage: abort",!1,l),p.ontimeout=S(Oe,c,p,"TestLoadImage: timeout",!1,l),yd.setTimeout(function(){p.ontimeout&&p.ontimeout()},1e4),p.src=n}else Ht(2);var n,l,c,p;this.zd(s)},D.Zd=function(e){Ht(e?2:1)},D.zd=function(e){this.w=0,this.b&&this.b.nb(e),this.Yb(),this.lb()},D.Yb=function(){this.w=0,this.B=-1,this.b&&(0==this.c.Xb().length&&0==this.g.length||(this.c.Bc(),N(this.g),this.g.length=0),this.b.mb())},D.Cb=function(e){return this.ub(null,e)},D.Bb=function(o,t){return this.ub(this.Da()?o:null,t)},D.ub=function(d,l){var p=(m=l)instanceof pe?m.N():new pe(m,void 0),m,y,g,f,b,E;if(""!=p.c)d&&p.ka(d+"."+p.c),p.la(p.h);else{var T=yd.location,h;h=d?d+"."+T.hostname:T.hostname,y=T.protocol,g=h,f=+T.port,b=l,E=new pe(null,void 0),y&&E.ma(y),g&&E.ka(g),f&&E.la(f),b&&E.Ba(b),p=E}return this.ca&&x(this.ca,function(o,t){p.m(t,o)}),d=this.j,l=this.Fa,d&&l&&p.m(d,l),p.m("VER",this.qb),this.ea(p),p},D.sa=function(e){if(e&&!this.T)throw Error("Can't create secondary domain capable XhrIo object.");return(e=new Pe(this.xc)).Sd(this.T),e},D.Pa=function(){return!!this.b&&!0},D.Da=function(){return this.T},(D=Ke.prototype).Ia=null,D.pb=function(){},D.ob=function(){},D.nb=function(){},D.mb=function(){},D.yc=function(){},D.$c=function(e){return e},je.prototype.a=function(o,t){return new We(o,t)},C(We,At),(D=We.prototype).addEventListener=function(o,t,e,a){We.S.addEventListener.call(this,o,t,e,a)},D.removeEventListener=function(o,t,e,a){We.S.removeEventListener.call(this,o,t,e,a)},D.Yc=function(){this.a.jc(this.f),this.l&&this.a.Rd(),this.a.bd(this.o,this.g,this.b||void 0)},D.close=function(){this.a.Qa()},D.Zc=function(o){if(s(o)){var t={};t.__data__=o,this.a.Xa(t)}else this.h?((t={}).__data__=Nt(o),this.a.Xa(t)):this.a.Xa(o)},D.G=function(){this.a.jc(null),delete this.f,this.a.Qa(),delete this.a,We.S.G.call(this)},C(Ge,ne),C(ze,oe),C(He,Ke),He.prototype.pb=function(){this.a.dispatchEvent("a")},He.prototype.ob=function(e){this.a.dispatchEvent(new Ge(e))},He.prototype.nb=function(e){this.a.dispatchEvent(new ze(e))},He.prototype.mb=function(){this.a.dispatchEvent("b")};var Ve=S(function(e){function t(){}t.prototype=e.prototype;var o=new t;return e.apply(o,Array.prototype.slice.call(arguments,1)),o},je);je.prototype.createWebChannel=je.prototype.a,We.prototype.send=We.prototype.Zc,We.prototype.open=We.prototype.Yc,We.prototype.close=We.prototype.close,Gt.NO_ERROR=0,Gt.TIMEOUT=8,Gt.HTTP_ERROR=6,Zt.COMPLETE="complete",(ee.EventType=te).OPEN="a",te.CLOSE="b",te.ERROR="c",te.MESSAGE="d",At.prototype.listen=At.prototype.Lb,Pe.prototype.listenOnce=Pe.prototype.Mb,Pe.prototype.getLastError=Pe.prototype.dd,Pe.prototype.getLastErrorCode=Pe.prototype.Db,Pe.prototype.getStatus=Pe.prototype.aa,Pe.prototype.getStatusText=Pe.prototype.Fb,Pe.prototype.getResponseJson=Pe.prototype.Nc,Pe.prototype.getResponseText=Pe.prototype.va,Pe.prototype.send=Pe.prototype.xa;var Xe={createWebChannelTransport:Ve,ErrorCode:Gt,EventType:Zt,WebChannel:ee,XhrIo:Pe},Je=Xe.createWebChannelTransport,$e=Xe.ErrorCode,Ze=Xe.EventType,tn=Xe.WebChannel,en=Xe.XhrIo,nn=Error.captureStackTrace,on=function(o,t){if(this.code=o,this.message=t,nn)nn(this,an.prototype.create);else try{throw Error.apply(this,arguments)}catch(e){this.name="FirebaseError",Object.defineProperty(this,"stack",{get:function(){return e.stack}})}};on.prototype=Object.create(Error.prototype),(on.prototype.constructor=on).prototype.name="FirebaseError";var an=function(){function e(o,t,e){this.service=o,this.serviceName=t,this.errors=e,this.pattern=/\{\$([^}]+)}/g}return e.prototype.create=function(s,d){void 0===d&&(d={});var t=this.errors[s],n=this.service+"/"+s,i;i=void 0===t?"Error":t.replace(this.pattern,function(o,t){var e=d[t];return void 0===e?"<"+t+"?>":e.toString()}),i=this.serviceName+": "+i+" ("+n+").";var l=new on(n,i);for(var o in d)d.hasOwnProperty(o)&&"_"!==o.slice(-1)&&(l[o]=d[o]);return l},e}(),cn=(function(o){function e(){var r=o.call(this)||this;r.chain_=[],r.buf_=[],r.W_=[],r.pad_=[],r.inbuf_=0,r.total_=0,r.blockSize=64,r.pad_[0]=128;for(var t=1;t<r.blockSize;++t)r.pad_[t]=0;return r.reset(),r}Ao(e,o),e.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},e.prototype.compress_=function(d,t){t||(t=0);var p=this.W_;if("string"==typeof d)for(var n=0;16>n;n++)p[n]=d.charCodeAt(t)<<24|d.charCodeAt(t+1)<<16|d.charCodeAt(t+2)<<8|d.charCodeAt(t+3),t+=4;else for(n=0;16>n;n++)p[n]=d[t]<<24|d[t+1]<<16|d[t+2]<<8|d[t+3],t+=4;for(n=16;80>n;n++){var m=p[n-3]^p[n-8]^p[n-14]^p[n-16];p[n]=4294967295&(m<<1|m>>>31)}var y=this.chain_[0],g=this.chain_[1],f=this.chain_[2],b=this.chain_[3],E=this.chain_[4],T,S;for(n=0;80>n;n++)S=40>n?20>n?(T=b^g&(f^b),1518500249):(T=g^f^b,1859775393):60>n?(T=g&f|b&(g|f),2400959708):(T=g^f^b,3395469782),m=4294967295&(y<<5|y>>>27)+T+E+S+p[n],E=b,b=f,f=4294967295&(g<<30|g>>>2),g=y,y=m;this.chain_[0]=4294967295&this.chain_[0]+y,this.chain_[1]=4294967295&this.chain_[1]+g,this.chain_[2]=4294967295&this.chain_[2]+f,this.chain_[3]=4294967295&this.chain_[3]+b,this.chain_[4]=4294967295&this.chain_[4]+E},e.prototype.update=function(a,t){if(null!=a){void 0===t&&(t=a.length);for(var s=t-this.blockSize,n=0,d=this.buf_,i=this.inbuf_;n<t;){if(0==i)for(;n<=s;)this.compress_(a,n),n+=this.blockSize;if("string"==typeof a){for(;n<t;)if(d[i]=a.charCodeAt(n),++n,++i==this.blockSize){this.compress_(d),i=0;break}}else for(;n<t;)if(d[i]=a[n],++n,++i==this.blockSize){this.compress_(d),i=0;break}}this.inbuf_=i,this.total_+=t}},e.prototype.digest=function(){var o=[],t=8*this.total_;56>this.inbuf_?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var a=this.blockSize-1;56<=a;a--)this.buf_[a]=255&t,t/=256;this.compress_(this.buf_);var s=0;for(a=0;5>a;a++)for(var d=24;0<=d;d-=8)o[s]=255&this.chain_[a]>>d,++s;return o}}(function(){this.blockSize=-1}),vo.SDK_VERSION),hn=new n("common/firestore"),ln,vd;(vd=ln||(ln={}))[vd.DEBUG=0]="DEBUG",vd[vd.ERROR=1]="ERROR",vd[vd.SILENT=2]="SILENT";var Ad=function(){function o(){}return o.setPlatform=function(e){o.platform&&rn("Platform already defined"),o.platform=e},o.getPlatform=function(){return o.platform||rn("Platform not set"),o.platform},o}(),bn={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},En=function(o){function e(r,t){var e=o.call(this,t)||this;return e.code=r,e.message=t,e.name="FirebaseError",e.toString=function(){return e.name+": [code="+e.code+"]: "+e.message},e}return Ao(e,o),e}(Error),Sn=function(){function e(){}return e.newId=function(){for(var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",r=0;20>r;r++)t+=o.charAt(dd(Math.random()*o.length));return dn(20===t.length,"Invalid auto ID: "+t),t},e}(),zn=function(){function o(e){Gn(),this._binaryString=e}return o.fromBase64String=function(e){Dn("Blob.fromBase64String",arguments,1),Nn("Blob.fromBase64String","string",1,e),Gn();try{return new o(Ad.getPlatform().atob(e))}catch(e){throw new En(bn.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+e)}},o.fromUint8Array=function(e){if(Dn("Blob.fromUint8Array",arguments,1),Wn(),!(e instanceof Uint8Array))throw Fn("Blob.fromUint8Array","Uint8Array",1,e);return new o(Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join(""))},o.prototype.toBase64=function(){return Dn("Blob.toBase64",arguments,0),Gn(),Ad.getPlatform().btoa(this._binaryString)},o.prototype.toUint8Array=function(){Dn("Blob.toUint8Array",arguments,0),Wn();for(var o=new Uint8Array(this._binaryString.length),t=0;t<this._binaryString.length;t++)o[t]=this._binaryString.charCodeAt(t);return o},o.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},o.prototype.isEqual=function(e){return this._binaryString===e._binaryString},o.prototype._compareTo=function(e){return Un(this._binaryString,e._binaryString)},o}(),rr=mn(zn,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),ir=function(){function e(o,t){if(Dn("GeoPoint",arguments,2),Nn("GeoPoint","number",1,o),Nn("GeoPoint","number",2,t),!isFinite(o)||-90>o||90<o)throw new En(bn.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+o);if(!isFinite(t)||-180>t||180<t)throw new En(bn.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=o,this._long=t}return Object.defineProperty(e.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(e){return this._lat===e._lat&&this._long===e._long},e.prototype._compareTo=function(e){return Un(this._lat,e._lat)||Un(this._long,e._long)},e}(),or=function(){function o(o,t){if(this.seconds=o,0>(this.nanoseconds=t))throw new En(bn.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new En(bn.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(-62135596800>o)throw new En(bn.INVALID_ARGUMENT,"Timestamp seconds out of range: "+o);if(253402300800<=o)throw new En(bn.INVALID_ARGUMENT,"Timestamp seconds out of range: "+o)}return o.now=function(){return o.fromMillis(Date.now())},o.fromDate=function(e){return o.fromMillis(e.getTime())},o.fromMillis=function(r){var t=dd(r/1e3);return new o(t,1e6*(r-1e3*t))},o.prototype.toDate=function(){return new Date(this.toMillis())},o.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},o.prototype._compareTo=function(e){return this.seconds===e.seconds?Un(this.nanoseconds,e.nanoseconds):Un(this.seconds,e.seconds)},o.prototype.isEqual=function(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds},o.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},o}(),ar=function(o,t,e,a){this.databaseId=o,this.persistenceKey=t,this.host=e,this.ssl=a},sr="(default)",ur=function(){function o(o,t){this.projectId=o,this.database=t||sr}return Object.defineProperty(o.prototype,"isDefaultDatabase",{get:function(){return this.database===sr},enumerable:!0,configurable:!0}),o.prototype.isEqual=function(e){return e instanceof o&&e.projectId===this.projectId&&e.database===this.database},o.prototype.compareTo=function(e){return Un(this.projectId,e.projectId)||Un(this.database,e.database)},o}(),cr="__name__",hr=function(){function o(o,t,e){this.init(o,t,e)}return o.prototype.init=function(o,t,r){void 0===t?t=0:t>o.length&&rn("offset "+t+" out of range "+o.length),void 0===r?r=o.length-t:r>o.length-t&&rn("length "+r+" out of range "+(o.length-t)),this.segments=o,this.offset=t,this.len=r},o.prototype.construct=function(o,t,e){var a=Object.create(Object.getPrototypeOf(this));return a.init(o,t,e),a},Object.defineProperty(o.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),o.prototype.isEqual=function(e){return 0===o.comparator(this,e)},o.prototype.child=function(r){var a=this.segments.slice(this.offset,this.limit());return r instanceof o?r.forEach(function(e){a.push(e)}):"string"==typeof r?a.push(r):rn("Unknown parameter type for Path.child(): "+r),this.construct(a)},o.prototype.limit=function(){return this.offset+this.length},o.prototype.popFirst=function(e){return e=void 0===e?1:e,dn(this.length>=e,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+e,this.length-e)},o.prototype.popLast=function(){return dn(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},o.prototype.firstSegment=function(){return dn(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},o.prototype.lastSegment=function(){return this.get(this.length-1)},o.prototype.get=function(e){return dn(e<this.length,"Index out of range"),this.segments[this.offset+e]},o.prototype.isEmpty=function(){return 0===this.length},o.prototype.isPrefixOf=function(o){if(o.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==o.get(t))return!1;return!0},o.prototype.isImmediateParentOf=function(o){if(this.length+1!==o.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==o.get(t))return!1;return!0},o.prototype.forEach=function(o){for(var t=this.offset,r=this.limit();t<r;t++)o(this.segments[t])},o.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},o.comparator=function(a,t){for(var e=sd(a.length,t.length),n=0;n<e;n++){var s=a.get(n),i=t.get(n);if(s<i)return-1;if(i<s)return 1}return a.length<t.length?-1:a.length>t.length?1:0},o}(),lr=function(o){function r(){return null!==o&&o.apply(this,arguments)||this}return Ao(r,o),r.prototype.canonicalString=function(){return this.toArray().join("/")},r.prototype.toString=function(){return this.canonicalString()},r.fromString=function(e){if(0<=e.indexOf("//"))throw new En(bn.INVALID_ARGUMENT,"Invalid path ("+e+"). Paths must not contain // in them.");return new r(e.split("/").filter(function(e){return 0<e.length}))},r.EMPTY_PATH=new r([]),r}(hr),fr=/^[_a-zA-Z][_a-zA-Z0-9]*$/,pr=function(e){function d(){return null!==e&&e.apply(this,arguments)||this}return Ao(d,e),d.isValidIdentifier=function(e){return fr.test(e)},d.prototype.canonicalString=function(){return this.toArray().map(function(e){return e=e.replace("\\","\\\\").replace("`","\\`"),d.isValidIdentifier(e)||(e="`"+e+"`"),e}).join(".")},d.prototype.toString=function(){return this.canonicalString()},d.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===cr},d.keyField=function(){return new d([cr])},d.fromServerFormat=function(l){for(var t=[],e="",c=0,p=function(){if(0===e.length)throw new En(bn.INVALID_ARGUMENT,"Invalid field path ("+l+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");t.push(e),e=""},i=!1,u;c<l.length;)if(u=l[c],"\\"===u){if(c+1===l.length)throw new En(bn.INVALID_ARGUMENT,"Path has trailing escape character: "+l);var m=l[c+1];if("\\"!==m&&"."!==m&&"`"!==m)throw new En(bn.INVALID_ARGUMENT,"Path has invalid escape sequence: "+l);e+=m,c+=2}else"`"===u?i=!i:"."!==u||i?e+=u:p(),c++;if(p(),i)throw new En(bn.INVALID_ARGUMENT,"Unterminated ` in path: "+l);return new d(t)},d.EMPTY_PATH=new d([]),d}(hr),dr=function(){function o(e){this.path=e,dn(o.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}return o.prototype.hasCollectionId=function(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e},o.prototype.isEqual=function(e){return null!==e&&0===lr.comparator(this.path,e.path)},o.prototype.toString=function(){return this.path.toString()},o.comparator=function(o,t){return lr.comparator(o.path,t.path)},o.isDocumentKey=function(e){return 0==e.length%2},o.fromSegments=function(e){return new o(new lr(e.slice()))},o.fromPathString=function(e){return new o(lr.fromString(e))},o.EMPTY=new o(new lr([])),o}(),mr=function(){function e(o,t){this.key=o,this.version=t}return e.compareByKey=function(o,t){return dr.comparator(o.key,t.key)},e}(),yr=function(s){function o(a,t,e,n,r){var i=s.call(this,a,t)||this;return i.data=e,i.proto=r,i.hasLocalMutations=!!n.hasLocalMutations,i.hasCommittedMutations=!!n.hasCommittedMutations,i}return Ao(o,s),o.prototype.field=function(e){return this.data.field(e)},o.prototype.fieldValue=function(o){var t=this.field(o);return t?t.value():void 0},o.prototype.value=function(){return this.data.value()},o.prototype.isEqual=function(e){return e instanceof o&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.data.isEqual(e.data)&&this.hasLocalMutations===e.hasLocalMutations&&this.hasCommittedMutations===e.hasCommittedMutations},o.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(o.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),o.compareByField=function(o,t,e){var a=t.field(o),r=e.field(o);return void 0!==a&&void 0!==r?a.compareTo(r):rn("Trying to compare documents on fields that don't exist")},o}(mr),gr=function(o){function r(a,t,e){var n=o.call(this,a,t)||this;return n.hasCommittedMutations=e&&e.hasCommittedMutations,n}return Ao(r,o),r.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(r.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),r.prototype.isEqual=function(e){return e instanceof r&&e.hasCommittedMutations===this.hasCommittedMutations&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},r}(mr),vr=function(o){function r(r,t){return o.call(this,r,t)||this}return Ao(r,o),r.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(r.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),r.prototype.isEqual=function(e){return e instanceof r&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},r}(mr),br=function(){function o(o,t){this.comparator=o,this.root=t||Er.EMPTY}return o.prototype.insert=function(r,t){return new o(this.comparator,this.root.insert(r,t,this.comparator).copy(null,null,Er.BLACK,null,null))},o.prototype.remove=function(e){return new o(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Er.BLACK,null,null))},o.prototype.get=function(o){for(var t=this.root,r;!t.isEmpty();){if(r=this.comparator(o,t.key),0===r)return t.value;0>r?t=t.left:0<r&&(t=t.right)}return null},o.prototype.indexOf=function(o){for(var t=0,a=this.root,i;!a.isEmpty();){if(i=this.comparator(o,a.key),0===i)return t+a.left.size;a=0>i?a.left:(t+=a.left.size+1,a.right)}return-1},o.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(o.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),o.prototype.minKey=function(){return this.root.minKey()},o.prototype.maxKey=function(){return this.root.maxKey()},o.prototype.inorderTraversal=function(e){return this.root.inorderTraversal(e)},o.prototype.forEach=function(o){this.inorderTraversal(function(r,t){return o(r,t),!1})},o.prototype.toString=function(){var o=[];return this.inorderTraversal(function(r,t){return o.push(r+":"+t),!1}),"{"+o.join(", ")+"}"},o.prototype.reverseTraversal=function(e){return this.root.reverseTraversal(e)},o.prototype.getIterator=function(){return new wr(this.root,null,this.comparator,!1)},o.prototype.getIteratorFrom=function(e){return new wr(this.root,e,this.comparator,!1)},o.prototype.getReverseIterator=function(){return new wr(this.root,null,this.comparator,!0)},o.prototype.getReverseIteratorFrom=function(e){return new wr(this.root,e,this.comparator,!0)},o}(),wr=function(){function e(o,a,e,n){this.isReverse=n,this.nodeStack=[];for(var r=1;!o.isEmpty();)if(r=a?e(o.key,a):1,n&&(r*=-1),0>r)o=this.isReverse?o.left:o.right;else{if(0===r){this.nodeStack.push(o);break}this.nodeStack.push(o),o=this.isReverse?o.right:o.left}}return e.prototype.getNext=function(){dn(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var o=this.nodeStack.pop(),r={key:o.key,value:o.value};if(this.isReverse)for(o=o.left;!o.isEmpty();)this.nodeStack.push(o),o=o.right;else for(o=o.right;!o.isEmpty();)this.nodeStack.push(o),o=o.left;return r},e.prototype.hasNext=function(){return 0<this.nodeStack.length},e.prototype.peek=function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}},e}(),Er=function(){function a(o,t,e,n,r){this.key=o,this.value=t,this.color=null==e?a.RED:e,this.left=null==n?a.EMPTY:n,this.right=null==r?a.EMPTY:r,this.size=this.left.size+1+this.right.size}return a.prototype.copy=function(o,t,e,n,r){return new a(null==o?this.key:o,null==t?this.value:t,null==e?this.color:e,null==n?this.left:n,null==r?this.right:r)},a.prototype.isEmpty=function(){return!1},a.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)},a.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},a.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},a.prototype.minKey=function(){return this.min().key},a.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},a.prototype.insert=function(o,t,e){var a=this,n=e(o,a.key);return(a=0>n?a.copy(null,null,null,a.left.insert(o,t,e),null):0===n?a.copy(null,t,null,null,null):a.copy(null,null,null,null,a.right.insert(o,t,e))).fixUp()},a.prototype.removeMin=function(){if(this.left.isEmpty())return a.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},a.prototype.remove=function(o,t){var e=this,i;if(0>t(o,e.key))e.left.isEmpty()||e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.remove(o,t),null);else{if(e.left.isRed()&&(e=e.rotateRight()),e.right.isEmpty()||e.right.isRed()||e.right.left.isRed()||(e=e.moveRedRight()),0===t(o,e.key)){if(e.right.isEmpty())return a.EMPTY;i=e.right.min(),e=e.copy(i.key,i.value,null,null,e.right.removeMin())}e=e.copy(null,null,null,null,e.right.remove(o,t))}return e.fixUp()},a.prototype.isRed=function(){return this.color},a.prototype.fixUp=function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e},a.prototype.moveRedLeft=function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e},a.prototype.moveRedRight=function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e},a.prototype.rotateLeft=function(){var e=this.copy(null,null,a.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},a.prototype.rotateRight=function(){var e=this.copy(null,null,a.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},a.prototype.colorFlip=function(){var o=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,o,t)},a.prototype.checkMaxDepth=function(){var e=this.check();return Math.pow(2,e)<=this.size+1},a.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw rn("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw rn("Right child of ("+this.key+","+this.value+") is red");var e=this.left.check();if(e!==this.right.check())throw rn("Black depths differ");return e+(this.isRed()?0:1)},a.EMPTY=null,a.RED=!0,a.BLACK=!1,a}(),Sr=function(){function e(){this.size=0}return e.prototype.copy=function(){return this},e.prototype.insert=function(o,t){return new Er(o,t)},e.prototype.remove=function(){return this},e.prototype.isEmpty=function(){return!0},e.prototype.inorderTraversal=function(){return!1},e.prototype.reverseTraversal=function(){return!1},e.prototype.minKey=function(){return null},e.prototype.maxKey=function(){return null},e.prototype.isRed=function(){return!1},e.prototype.checkMaxDepth=function(){return!0},e.prototype.check=function(){return 0},e}(),Tr,Nd,kd,wd;Er.EMPTY=new Sr,(Nd=Tr||(Tr={}))[Nd.NullValue=0]="NullValue",Nd[Nd.BooleanValue=1]="BooleanValue",Nd[Nd.NumberValue=2]="NumberValue",Nd[Nd.TimestampValue=3]="TimestampValue",Nd[Nd.StringValue=4]="StringValue",Nd[Nd.BlobValue=5]="BlobValue",Nd[Nd.RefValue=6]="RefValue",Nd[Nd.GeoPointValue=7]="GeoPointValue",Nd[Nd.ArrayValue=8]="ArrayValue",Nd[Nd.ObjectValue=9]="ObjectValue",(wd=kd||(kd={}))[wd.Default=0]="Default",wd[wd.Estimate=1]="Estimate",wd[wd.Previous=2]="Previous";var Rd=function(){function o(o,t){this.serverTimestampBehavior=o,this.timestampsInSnapshots=t}return o.fromSnapshotOptions=function(r,t){switch(r.serverTimestamps){case"estimate":return new o(kd.Estimate,t);case"previous":return new o(kd.Previous,t);case"none":case void 0:return new o(kd.Default,t);default:return rn("fromSnapshotOptions() called with invalid options.");}},o}(),Ir=function(){function e(){}return e.prototype.toString=function(){var e=this.value();return null===e?"null":e.toString()},e.prototype.defaultCompareTo=function(e){return dn(this.typeOrder!==e.typeOrder,"Default compareTo should not be used for values of same type."),Un(this.typeOrder,e.typeOrder)},e}(),Cr=function(o){function e(){var e=o.call(this)||this;return e.typeOrder=Tr.NullValue,e.internalValue=null,e}return Ao(e,o),e.prototype.value=function(){return null},e.prototype.isEqual=function(o){return o instanceof e},e.prototype.compareTo=function(o){return o instanceof e?0:this.defaultCompareTo(o)},e.INSTANCE=new e,e}(Ir),Dr=function(o){function r(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.BooleanValue,t}return Ao(r,o),r.prototype.value=function(){return this.internalValue},r.prototype.isEqual=function(e){return e instanceof r&&this.internalValue===e.internalValue},r.prototype.compareTo=function(e){return e instanceof r?Un(this,e):this.defaultCompareTo(e)},r.of=function(e){return e?r.TRUE:r.FALSE},r.TRUE=new r(!0),r.FALSE=new r(!1),r}(Ir),Nr=function(o){function a(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.NumberValue,t}return Ao(a,o),a.prototype.value=function(){return this.internalValue},a.prototype.compareTo=function(o){return o instanceof a?(t=this.internalValue,r=o.internalValue,t<r?-1:r<t?1:t===r?0:isNaN(t)?isNaN(r)?0:-1:1):this.defaultCompareTo(o);var t,r},a}(Ir),Ar=function(o){function e(e){return o.call(this,e)||this}return Ao(e,o),e.prototype.isEqual=function(o){return o instanceof e&&jn(this.internalValue,o.internalValue)},e}(Nr),Rr=function(o){function r(r){var t=o.call(this,r)||this;return t.internalValue=r,t}return Ao(r,o),r.prototype.isEqual=function(e){return e instanceof r&&jn(this.internalValue,e.internalValue)},r.NAN=new r(NaN),r.POSITIVE_INFINITY=new r(1/0),r.NEGATIVE_INFINITY=new r(-1/0),r}(Nr),Mr=function(o){function r(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.StringValue,t}return Ao(r,o),r.prototype.value=function(){return this.internalValue},r.prototype.isEqual=function(e){return e instanceof r&&this.internalValue===e.internalValue},r.prototype.compareTo=function(e){return e instanceof r?Un(this.internalValue,e.internalValue):this.defaultCompareTo(e)},r}(Ir),_r=function(o){function r(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.TimestampValue,t}return Ao(r,o),r.prototype.value=function(e){return!e||e.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},r.prototype.isEqual=function(e){return e instanceof r&&this.internalValue.isEqual(e.internalValue)},r.prototype.compareTo=function(e){return e instanceof r?this.internalValue._compareTo(e.internalValue):e instanceof Or?-1:this.defaultCompareTo(e)},r}(Ir),Or=function(o){function r(r,t){var e=o.call(this)||this;return e.localWriteTime=r,e.previousValue=t,e.typeOrder=Tr.TimestampValue,e}return Ao(r,o),r.prototype.value=function(e){return e&&e.serverTimestampBehavior===kd.Estimate?new _r(this.localWriteTime).value(e):e&&e.serverTimestampBehavior===kd.Previous&&this.previousValue?this.previousValue.value(e):null},r.prototype.isEqual=function(e){return e instanceof r&&this.localWriteTime.isEqual(e.localWriteTime)},r.prototype.compareTo=function(e){return e instanceof r?this.localWriteTime._compareTo(e.localWriteTime):e instanceof _r?1:this.defaultCompareTo(e)},r.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},r}(Ir),Pr=function(o){function r(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.BlobValue,t}return Ao(r,o),r.prototype.value=function(){return this.internalValue},r.prototype.isEqual=function(e){return e instanceof r&&this.internalValue.isEqual(e.internalValue)},r.prototype.compareTo=function(e){return e instanceof r?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},r}(Ir),Lr=function(o){function r(r,t){var e=o.call(this)||this;return e.databaseId=r,e.key=t,e.typeOrder=Tr.RefValue,e}return Ao(r,o),r.prototype.value=function(){return this.key},r.prototype.isEqual=function(e){return e instanceof r&&this.key.isEqual(e.key)&&this.databaseId.isEqual(e.databaseId)},r.prototype.compareTo=function(o){if(o instanceof r){var t=this.databaseId.compareTo(o.databaseId);return 0===t?dr.comparator(this.key,o.key):t}return this.defaultCompareTo(o)},r}(Ir),xr=function(o){function r(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.GeoPointValue,t}return Ao(r,o),r.prototype.value=function(){return this.internalValue},r.prototype.isEqual=function(e){return e instanceof r&&this.internalValue.isEqual(e.internalValue)},r.prototype.compareTo=function(e){return e instanceof r?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},r}(Ir),qr=function(o){function s(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.ObjectValue,t}return Ao(s,o),s.prototype.value=function(o){var a={};return this.internalValue.inorderTraversal(function(r,t){a[r]=t.value(o)}),a},s.prototype.forEach=function(e){this.internalValue.inorderTraversal(e)},s.prototype.isEqual=function(o){if(o instanceof s){for(var t=this.internalValue.getIterator(),e=o.internalValue.getIterator();t.hasNext()&&e.hasNext();){var a=t.getNext(),r=e.getNext();if(a.key!==r.key||!a.value.isEqual(r.value))return!1}return!t.hasNext()&&!e.hasNext()}return!1},s.prototype.compareTo=function(a){if(a instanceof s){for(var t=this.internalValue.getIterator(),e=a.internalValue.getIterator();t.hasNext()&&e.hasNext();){var n=t.getNext(),r=e.getNext(),i=Un(n.key,r.key)||n.value.compareTo(r.value);if(i)return i}return Un(t.hasNext(),e.hasNext())}return this.defaultCompareTo(a)},s.prototype.set=function(o,t){if(dn(!o.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===o.length)return this.setChild(o.firstSegment(),t);var e=this.child(o.firstSegment());e instanceof s||(e=s.EMPTY);var a=e.set(o.popFirst(),t);return this.setChild(o.firstSegment(),a)},s.prototype.delete=function(o){if(dn(!o.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===o.length)return new s(this.internalValue.remove(o.firstSegment()));var t=this.child(o.firstSegment());if(t instanceof s){var e=t.delete(o.popFirst());return new s(this.internalValue.insert(o.firstSegment(),e))}return this},s.prototype.contains=function(e){return void 0!==this.field(e)},s.prototype.field=function(o){dn(!o.isEmpty(),"Can't get field of empty path");var r=this;return o.forEach(function(e){r=r instanceof s&&r.internalValue.get(e)||void 0}),r},s.prototype.toString=function(){return this.internalValue.toString()},s.prototype.child=function(e){return this.internalValue.get(e)||void 0},s.prototype.setChild=function(o,t){return new s(this.internalValue.insert(o,t))},s.EMPTY=new s(new br(Un)),s}(Ir),Fr=function(o){function a(r){var t=o.call(this)||this;return t.internalValue=r,t.typeOrder=Tr.ArrayValue,t}return Ao(a,o),a.prototype.value=function(o){return this.internalValue.map(function(e){return e.value(o)})},a.prototype.forEach=function(e){this.internalValue.forEach(e)},a.prototype.isEqual=function(o){if(o instanceof a){if(this.internalValue.length!==o.internalValue.length)return!1;for(var t=0;t<this.internalValue.length;t++)if(!this.internalValue[t].isEqual(o.internalValue[t]))return!1;return!0}return!1},a.prototype.compareTo=function(o){if(o instanceof a){for(var t=sd(this.internalValue.length,o.internalValue.length),e=0,i;e<t;e++)if(i=this.internalValue[e].compareTo(o.internalValue[e]),i)return i;return Un(this.internalValue.length,o.internalValue.length)}return this.defaultCompareTo(o)},a.prototype.toString=function(){return"["+this.internalValue.map(function(e){return e.toString()}).join(",")+"]"},a}(Ir),Vr=Number,Br=Vr.MIN_SAFE_INTEGER||-9007199254740991,Ur=Vr.MAX_SAFE_INTEGER||9007199254740991,Qr=Vr.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&dd(e)===e},Kr=function(){function o(s,t,d,l,c,p,u){void 0===t&&(t=null),void 0===d&&(d=[]),void 0===l&&(l=[]),void 0===c&&(c=null),void 0===p&&(p=null),void 0===u&&(u=null),this.path=s,this.collectionGroup=t,this.explicitOrderBy=d,this.filters=l,this.limit=c,this.startAt=p,this.endAt=u,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return o.atPath=function(e){return new o(e)},Object.defineProperty(o.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var s=this.getInequalityFilterField(),t=this.getFirstOrderByField();if(null!==s&&null===t)this.memoizedOrderBy=s.isKeyField()?[ni]:[new ei(s),ni];else{dn(null===s||null!==t&&s.isEqual(t),"First orderBy should match inequality field.");for(var e=!(this.memoizedOrderBy=[]),d=0,l=this.explicitOrderBy,i;d<l.length;d++)i=l[d],this.memoizedOrderBy.push(i),i.field.isKeyField()&&(e=!0);if(!e){var c=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Zr.ASCENDING;this.memoizedOrderBy.push(c===Zr.ASCENDING?ni:ri)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),o.prototype.addFilter=function(r){dn(null==this.getInequalityFilterField()||!(r instanceof Xr)||!r.isInequality()||r.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),dn(!this.isDocumentQuery(),"No filtering allowed for document query");var t=this.filters.concat([r]);return new o(this.path,this.collectionGroup,this.explicitOrderBy.slice(),t,this.limit,this.startAt,this.endAt)},o.prototype.addOrderBy=function(r){dn(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var t=this.explicitOrderBy.concat([r]);return new o(this.path,this.collectionGroup,t,this.filters.slice(),this.limit,this.startAt,this.endAt)},o.prototype.withLimit=function(e){return new o(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),e,this.startAt,this.endAt)},o.prototype.withStartAt=function(e){return new o(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,e,this.endAt)},o.prototype.withEndAt=function(e){return new o(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,e)},o.prototype.asCollectionQueryAtPath=function(e){return new o(e,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},o.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var o=this.path.canonicalString();this.isCollectionGroupQuery()&&(o+="|cg:"+this.collectionGroup),o+="|f:";for(var a=0,s=this.filters;a<s.length;a++)o+=s[a].canonicalId(),o+=",";o+="|ob:";for(var n=0,d=this.orderBy;n<d.length;n++)o+=d[n].canonicalId(),o+=",";kr(this.limit)||(o+="|l:",o+=this.limit),this.startAt&&(o+="|lb:",o+=this.startAt.canonicalId()),this.endAt&&(o+="|ub:",o+=this.endAt.canonicalId()),this.memoizedCanonicalId=o}return this.memoizedCanonicalId},o.prototype.toString=function(){var e="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(e+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(e+=", filters: ["+this.filters.join(", ")+"]"),kr(this.limit)||(e+=", limit: "+this.limit),0<this.explicitOrderBy.length&&(e+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(e+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(e+=", endAt: "+this.endAt.canonicalId()),e+")"},o.prototype.isEqual=function(o){if(this.limit!==o.limit)return!1;if(this.orderBy.length!==o.orderBy.length)return!1;for(var t=0;t<this.orderBy.length;t++)if(!this.orderBy[t].isEqual(o.orderBy[t]))return!1;if(this.filters.length!==o.filters.length)return!1;for(t=0;t<this.filters.length;t++)if(!this.filters[t].isEqual(o.filters[t]))return!1;return this.collectionGroup===o.collectionGroup&&!!this.path.isEqual(o.path)&&(null===this.startAt?null===o.startAt:!!this.startAt.isEqual(o.startAt))&&(null===this.endAt?null===o.endAt:this.endAt.isEqual(o.endAt))},o.prototype.docComparator=function(s,t){for(var e=!1,d=0,l=this.orderBy;d<l.length;d++){var i=l[d],o=i.compare(s,t);if(0!==o)return o;e=e||i.field.isKeyField()}return dn(e,"orderBy used that doesn't compare on key field"),0},o.prototype.matches=function(e){return this.matchesPathAndCollectionGroup(e)&&this.matchesOrderBy(e)&&this.matchesFilters(e)&&this.matchesBounds(e)},o.prototype.hasLimit=function(){return!kr(this.limit)},o.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},o.prototype.getInequalityFilterField=function(){for(var o=0,r=this.filters,e;o<r.length;o++)if(e=r[o],e instanceof Xr&&e.isInequality())return e.field;return null},o.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(e){return e instanceof Xr&&e.op===Yr.ARRAY_CONTAINS})},o.prototype.isDocumentQuery=function(){return dr.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},o.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},o.prototype.matchesPathAndCollectionGroup=function(o){var t=o.key.path;return null===this.collectionGroup?dr.isDocumentKey(this.path)?this.path.isEqual(t):this.path.isImmediateParentOf(t):o.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(t)},o.prototype.matchesOrderBy=function(o){for(var t=0,a=this.explicitOrderBy,n;t<a.length;t++)if(n=a[t],!n.field.isKeyField()&&void 0===o.field(n.field))return!1;return!0},o.prototype.matchesFilters=function(o){for(var t=0,r=this.filters;t<r.length;t++)if(!r[t].matches(o))return!1;return!0},o.prototype.matchesBounds=function(e){return(!this.startAt||this.startAt.sortsBeforeDocument(this.orderBy,e))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,e))},o.prototype.assertValidBound=function(e){dn(e.position.length<=this.orderBy.length,"Bound is longer than orderBy")},o}(),Hr=function(){function e(){}return e.create=function(o,t,e){if(e.isEqual(Cr.INSTANCE)){if(t!==Yr.EQUAL)throw new En(bn.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new Jr(o)}if(e.isEqual(Rr.NAN)){if(t!==Yr.EQUAL)throw new En(bn.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new $r(o)}return new Xr(o,t,e)},e}(),Yr=function(){function o(e){this.name=e}return o.fromString=function(e){return"<"===e?o.LESS_THAN:"<="===e?o.LESS_THAN_OR_EQUAL:"=="===e?o.EQUAL:">="===e?o.GREATER_THAN_OR_EQUAL:">"===e?o.GREATER_THAN:"array-contains"===e?o.ARRAY_CONTAINS:rn("Unknown relation: "+e)},o.prototype.toString=function(){return this.name},o.prototype.isEqual=function(e){return this.name===e.name},o.LESS_THAN=new o("<"),o.LESS_THAN_OR_EQUAL=new o("<="),o.EQUAL=new o("=="),o.GREATER_THAN=new o(">"),o.GREATER_THAN_OR_EQUAL=new o(">="),o.ARRAY_CONTAINS=new o("array-contains"),o}(),Xr=function(o){function r(a,t,e){var n=o.call(this)||this;return n.field=a,n.op=t,n.value=e,n}return Ao(r,o),r.prototype.matches=function(o){if(this.field.isKeyField()){dn(this.value instanceof Lr,"Comparing on key, but filter value not a RefValue"),dn(this.op!==Yr.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var t=this.value,e=dr.comparator(o.key,t.key);return this.matchesComparison(e)}var a=o.field(this.field);return void 0!==a&&this.matchesValue(a)},r.prototype.matchesValue=function(o){var r=this;return this.op===Yr.ARRAY_CONTAINS?o instanceof Fr&&void 0!==o.internalValue.find(function(e){return e.isEqual(r.value)}):this.value.typeOrder===o.typeOrder&&this.matchesComparison(o.compareTo(this.value))},r.prototype.matchesComparison=function(e){switch(this.op){case Yr.LESS_THAN:return 0>e;case Yr.LESS_THAN_OR_EQUAL:return 0>=e;case Yr.EQUAL:return 0===e;case Yr.GREATER_THAN:return 0<e;case Yr.GREATER_THAN_OR_EQUAL:return 0<=e;default:return rn("Unknown relation op"+this.op);}},r.prototype.isInequality=function(){return this.op!==Yr.EQUAL&&this.op!==Yr.ARRAY_CONTAINS},r.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},r.prototype.isEqual=function(e){return e instanceof r&&this.op.isEqual(e.op)&&this.field.isEqual(e.field)&&this.value.isEqual(e.value)},r.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},r}(Hr),Jr=function(o){function r(r){var t=o.call(this)||this;return t.field=r,t}return Ao(r,o),r.prototype.matches=function(o){var t=o.field(this.field);return void 0!==t&&null===t.value()},r.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},r.prototype.toString=function(){return this.field.canonicalString()+" IS null"},r.prototype.isEqual=function(e){return e instanceof r&&this.field.isEqual(e.field)},r}(Hr),$r=function(o){function r(r){var t=o.call(this)||this;return t.field=r,t}return Ao(r,o),r.prototype.matches=function(o){var t=o.field(this.field),e=t&&t.value();return"number"==typeof e&&isNaN(e)},r.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},r.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},r.prototype.isEqual=function(e){return e instanceof r&&this.field.isEqual(e.field)},r}(Hr),Zr=function(){function e(e){this.name=e}return e.prototype.toString=function(){return this.name},e.ASCENDING=new e("asc"),e.DESCENDING=new e("desc"),e}(),ti=function(){function e(o,t){this.position=o,this.before=t}return e.prototype.canonicalId=function(){for(var o=this.before?"b:":"a:",r=0,a=this.position;r<a.length;r++)o+=a[r].toString();return o},e.prototype.sortsBeforeDocument=function(s,t){dn(this.position.length<=s.length,"Bound has more components than query's orderBy");for(var e=0,d=0;d<this.position.length;d++){var l=s[d],i=this.position[d];if(l.field.isKeyField())dn(i instanceof Lr,"Bound has a non-key value where the key path is being used."),e=dr.comparator(i.key,t.key);else{var o=t.field(l.field);dn(void 0!==o,"Field should exist since document matched the orderBy already."),e=i.compareTo(o)}if(l.dir===Zr.DESCENDING&&(e*=-1),0!==e)break}return this.before?0>=e:0>e},e.prototype.isEqual=function(o){if(null===o)return!1;if(this.before!==o.before||this.position.length!==o.position.length)return!1;for(var t=0;t<this.position.length;t++){var a=this.position[t],n=o.position[t];return a.isEqual(n)}return!0},e}(),ei=function(){function e(o,t){this.field=o,void 0===t&&(t=Zr.ASCENDING),this.dir=t,this.isKeyOrderBy=o.isKeyField()}return e.prototype.compare=function(o,t){var e=this.isKeyOrderBy?yr.compareByKey(o,t):yr.compareByField(this.field,o,t);switch(this.dir){case Zr.ASCENDING:return e;case Zr.DESCENDING:return-1*e;default:return rn("Unknown direction: "+this.dir);}},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},e.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},e.prototype.isEqual=function(e){return this.dir===e.dir&&this.field.isEqual(e.field)},e}(),ni=new ei(pr.keyField(),Zr.ASCENDING),ri=new ei(pr.keyField(),Zr.DESCENDING),ii=function(){function o(e){this.timestamp=e}return o.fromMicroseconds=function(r){var t=dd(r/1e6);return new o(new or(t,1e3*(r%1e6)))},o.fromTimestamp=function(e){return new o(e)},o.forDeletedDoc=function(){return o.MIN},o.prototype.compareTo=function(e){return this.timestamp._compareTo(e.timestamp)},o.prototype.isEqual=function(e){return this.timestamp.isEqual(e.timestamp)},o.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},o.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},o.prototype.toTimestamp=function(){return this.timestamp},o.MIN=new o(new or(0,0)),o}(),oi,Md;(Md=oi||(oi={}))[Md.Listen=0]="Listen",Md[Md.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",Md[Md.LimboResolution=2]="LimboResolution";var _d=function(){function o(a,t,e,n,r,s){void 0===r&&(r=ii.MIN),void 0===s&&(s=pn()),this.query=a,this.targetId=t,this.purpose=e,this.sequenceNumber=n,this.snapshotVersion=r,this.resumeToken=s}return o.prototype.copy=function(e){return new o(this.query,this.targetId,this.purpose,void 0===e.sequenceNumber?this.sequenceNumber:e.sequenceNumber,void 0===e.snapshotVersion?this.snapshotVersion:e.snapshotVersion,void 0===e.resumeToken?this.resumeToken:e.resumeToken)},o.prototype.isEqual=function(e){return this.targetId===e.targetId&&this.purpose===e.purpose&&this.sequenceNumber===e.sequenceNumber&&this.snapshotVersion.isEqual(e.snapshotVersion)&&this.resumeToken===e.resumeToken&&this.query.isEqual(e.query)},o}(),ui=function(){function a(e){this.comparator=e,this.data=new br(this.comparator)}return a.fromMapKeys=function(o){var r=new a(o.comparator);return o.forEach(function(e){r=r.add(e)}),r},a.prototype.has=function(e){return null!==this.data.get(e)},a.prototype.first=function(){return this.data.minKey()},a.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(a.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),a.prototype.indexOf=function(e){return this.data.indexOf(e)},a.prototype.forEach=function(e){this.data.inorderTraversal(function(o){return e(o),!1})},a.prototype.forEachInRange=function(o,t){for(var e=this.data.getIteratorFrom(o[0]),a;e.hasNext();){if(a=e.getNext(),0<=this.comparator(a.key,o[1]))return;t(a.key)}},a.prototype.forEachWhile=function(o,t){var e;for(e=void 0===t?this.data.getIterator():this.data.getIteratorFrom(t);e.hasNext();)if(!o(e.getNext().key))return},a.prototype.firstAfterOrEqual=function(o){var t=this.data.getIteratorFrom(o);return t.hasNext()?t.getNext().key:null},a.prototype.getIterator=function(){return new ci(this.data.getIterator())},a.prototype.getIteratorFrom=function(e){return new ci(this.data.getIteratorFrom(e))},a.prototype.add=function(e){return this.copy(this.data.remove(e).insert(e,!0))},a.prototype.delete=function(e){return this.has(e)?this.copy(this.data.remove(e)):this},a.prototype.isEmpty=function(){return this.data.isEmpty()},a.prototype.unionWith=function(o){var r=this;return o.forEach(function(e){r=r.add(e)}),r},a.prototype.isEqual=function(o){if(!(o instanceof a))return!1;if(this.size!==o.size)return!1;for(var t=this.data.getIterator(),e=o.data.getIterator();t.hasNext();){var n=t.getNext().key,r=e.getNext().key;if(0!==this.comparator(n,r))return!1}return!0},a.prototype.toArray=function(){var o=[];return this.forEach(function(e){o.push(e)}),o},a.prototype.toString=function(){var o=[];return this.forEach(function(e){return o.push(e)}),"SortedSet("+o.toString()+")"},a.prototype.copy=function(o){var t=new a(this.comparator);return t.data=o,t},a}(),ci=function(){function e(e){this.iter=e}return e.prototype.getNext=function(){return this.iter.getNext().key},e.prototype.hasNext=function(){return this.iter.hasNext()},e}(),hi=function(){function o(e){this.fields=e}return o.fromSet=function(e){return new o(e)},o.fromArray=function(r){var a=new ui(pr.comparator);return r.forEach(function(e){return a=a.add(e)}),new o(a)},o.prototype.covers=function(o){var e=!1;return this.fields.forEach(function(r){r.isPrefixOf(o)&&(e=!0)}),e},o.prototype.applyTo=function(o){var a=qr.EMPTY;return this.fields.forEach(function(r){if(r.isEmpty())return o;var t=o.field(r);void 0!==t&&(a=a.set(r,t))}),a},o.prototype.isEqual=function(e){return this.fields.isEqual(e.fields)},o}(),li=function(){function e(o,t){this.field=o,this.transform=t}return Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(e){return this.field.isEqual(e.field)&&this.transform.isEqual(e.transform)},e}(),fi=function(o,t){this.version=o,this.transformResults=t},pi,Pd;(Pd=pi||(pi={}))[Pd.Set=0]="Set",Pd[Pd.Patch=1]="Patch",Pd[Pd.Transform=2]="Transform",Pd[Pd.Delete=3]="Delete";var Ld=function(){function o(o,t){this.updateTime=o,this.exists=t,dn(void 0===o||void 0===t,"Precondition can specify \"exists\" or \"updateTime\" but not both")}return o.exists=function(e){return new o(void 0,e)},o.updateTime=function(e){return new o(e)},Object.defineProperty(o.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),o.prototype.isValidFor=function(e){return void 0===this.updateTime?void 0===this.exists?(dn(this.isNone,"Precondition should be empty"),!0):this.exists===e instanceof yr:e instanceof yr&&e.version.isEqual(this.updateTime)},o.prototype.isEqual=function(o){return t=this.updateTime,r=o.updateTime,(null==t?t===r:r&&t.isEqual(r))&&this.exists===o.exists;var t,r},o.NONE=new o,o}(),di=function(){function e(){}return e.prototype.verifyKeyMatches=function(e){null!=e&&dn(e.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},e.getPostMutationVersion=function(e){return e instanceof yr?e.version:ii.MIN},e}(),mi=function(o){function r(a,t,e){var n=o.call(this)||this;return n.key=a,n.value=t,n.precondition=e,n.type=pi.Set,n}return Ao(r,o),r.prototype.applyToRemoteDocument=function(o,t){this.verifyKeyMatches(o),dn(null==t.transformResults,"Transform results received by SetMutation.");var e=t.version;return new yr(this.key,e,this.value,{hasCommittedMutations:!0})},r.prototype.applyToLocalView=function(e){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var t=di.getPostMutationVersion(e);return new yr(this.key,t,this.value,{hasLocalMutations:!0})},Object.defineProperty(r.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),r.prototype.isEqual=function(e){return e instanceof r&&this.key.isEqual(e.key)&&this.value.isEqual(e.value)&&this.precondition.isEqual(e.precondition)},r}(di),yi=function(a){function o(o,t,e,n){var r=a.call(this)||this;return r.key=o,r.data=t,r.fieldMask=e,r.precondition=n,r.type=pi.Patch,r}return Ao(o,a),o.prototype.applyToRemoteDocument=function(o,t){if(this.verifyKeyMatches(o),dn(null==t.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(o))return new vr(this.key,t.version);var e=this.patchDocument(o);return new yr(this.key,t.version,e,{hasCommittedMutations:!0})},o.prototype.applyToLocalView=function(e){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var t=di.getPostMutationVersion(e),o=this.patchDocument(e);return new yr(this.key,t,o,{hasLocalMutations:!0})},Object.defineProperty(o.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),o.prototype.isEqual=function(e){return e instanceof o&&this.key.isEqual(e.key)&&this.fieldMask.isEqual(e.fieldMask)&&this.precondition.isEqual(e.precondition)},o.prototype.patchDocument=function(o){var t;return t=o instanceof yr?o.data:qr.EMPTY,this.patchObject(t)},o.prototype.patchObject=function(o){var a=this;return this.fieldMask.fields.forEach(function(r){if(!r.isEmpty()){var t=a.data.field(r);o=void 0===t?o.delete(r):o.set(r,t)}}),o},o}(di),gi=function(o){function r(r,t){var e=o.call(this)||this;return e.key=r,e.fieldTransforms=t,e.type=pi.Transform,e.precondition=Ld.exists(!0),e}return Ao(r,o),r.prototype.applyToRemoteDocument=function(a,t){if(this.verifyKeyMatches(a),dn(null!=t.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(a))return new vr(this.key,t.version);var e=this.requireDocument(a),n=this.serverTransformResults(a,t.transformResults),r=t.version,i=this.transformObject(e.data,n);return new yr(this.key,r,i,{hasCommittedMutations:!0})},r.prototype.applyToLocalView=function(a,t,e){if(this.verifyKeyMatches(a),!this.precondition.isValidFor(a))return a;var n=this.requireDocument(a),r=this.localTransformResults(e,t),i=this.transformObject(n.data,r);return new yr(this.key,n.version,i,{hasLocalMutations:!0})},Object.defineProperty(r.prototype,"isIdempotent",{get:function(){for(var o=0,r=this.fieldTransforms;o<r.length;o++)if(!r[o].isIdempotent)return!1;return!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fieldMask",{get:function(){var o=new ui(pr.comparator);return this.fieldTransforms.forEach(function(e){return o=o.add(e.field)}),new hi(o)},enumerable:!0,configurable:!0}),r.prototype.isEqual=function(e){return e instanceof r&&this.key.isEqual(e.key)&&Qn(this.fieldTransforms,e.fieldTransforms)&&this.precondition.isEqual(e.precondition)},r.prototype.requireDocument=function(o){dn(o instanceof yr,"Unknown MaybeDocument type "+o);var t=o;return dn(t.key.isEqual(this.key),"Can only transform a document with the same key"),t},r.prototype.serverTransformResults=function(s,t){var e=[];dn(this.fieldTransforms.length===t.length,"server transform result count ("+t.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var n=0;n<t.length;n++){var d=this.fieldTransforms[n],i=d.transform,o=null;s instanceof yr&&(o=s.field(d.field)||null),e.push(i.applyToRemoteDocument(o,t[n]))}return e},r.prototype.localTransformResults=function(d,t){for(var e=[],n=0,l=this.fieldTransforms;n<l.length;n++){var i=l[n],o=i.transform,a=null;t instanceof yr&&(a=t.field(i.field)||null),e.push(o.applyToLocalView(a,d))}return e},r.prototype.transformObject=function(o,a){dn(a.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var e=0,i;e<this.fieldTransforms.length;e++)i=this.fieldTransforms[e].field,o=o.set(i,a[e]);return o},r}(di),vi=function(o){function r(r,t){var e=o.call(this)||this;return e.key=r,e.precondition=t,e.type=pi.Delete,e}return Ao(r,o),r.prototype.applyToRemoteDocument=function(o,t){return this.verifyKeyMatches(o),dn(null==t.transformResults,"Transform results received by DeleteMutation."),new gr(this.key,t.version,{hasCommittedMutations:!0})},r.prototype.applyToLocalView=function(e){return this.verifyKeyMatches(e),this.precondition.isValidFor(e)?(e&&dn(e.key.isEqual(this.key),"Can only apply mutation to document with same key"),new gr(this.key,ii.forDeletedDoc())):e},r.prototype.isEqual=function(e){return e instanceof r&&this.key.isEqual(e.key)&&this.precondition.isEqual(e.precondition)},Object.defineProperty(r.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),r}(di),bi=function(){function o(){this.isIdempotent=!0}return o.prototype.applyToLocalView=function(o,t){return new Or(t,o)},o.prototype.applyToRemoteDocument=function(o,t){return t},o.prototype.isEqual=function(e){return e instanceof o},o.instance=new o,o}(),wi=function(){function o(e){this.elements=e,this.isIdempotent=!0}return o.prototype.applyToLocalView=function(e){return this.apply(e)},o.prototype.applyToRemoteDocument=function(e){return this.apply(e)},o.prototype.apply=function(o){for(var t=Wr(o),a=function(o){t.find(function(e){return e.isEqual(o)})||t.push(o)},e=0,n=this.elements;e<n.length;e++)a(n[e]);return new Fr(t)},o.prototype.isEqual=function(e){return e instanceof o&&Qn(e.elements,this.elements)},o}(),Ei=function(){function o(e){this.elements=e,this.isIdempotent=!0}return o.prototype.applyToLocalView=function(e){return this.apply(e)},o.prototype.applyToRemoteDocument=function(e){return this.apply(e)},o.prototype.apply=function(o){for(var t=Wr(o),a=function(o){t=t.filter(function(e){return!e.isEqual(o)})},e=0,s=this.elements;e<s.length;e++)a(s[e]);return new Fr(t)},o.prototype.isEqual=function(e){return e instanceof o&&Qn(e.elements,this.elements)},o}(),Si=function(){function o(e){this.operand=e,this.isIdempotent=!1}return o.prototype.applyToLocalView=function(e){if(e instanceof Ar&&this.operand instanceof Ar){var t=e.internalValue+this.operand.internalValue;return new Ar(t)}return e instanceof Nr?(t=e.internalValue+this.operand.internalValue,new Rr(t)):this.operand},o.prototype.applyToRemoteDocument=function(o,t){return dn(null!==t,"Didn't receive transformResult for NUMERIC_ADD transform"),t},o.prototype.isEqual=function(e){return e instanceof o&&this.operand.isEqual(e.operand)},o}(),Ti=function(){function e(e){this.count=e}return e.prototype.isEqual=function(e){return e&&e.count===this.count},e}(),Ni,Od;(Od=Ni||(Ni={}))[Od.OK=0]="OK",Od[Od.CANCELLED=1]="CANCELLED",Od[Od.UNKNOWN=2]="UNKNOWN",Od[Od.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Od[Od.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Od[Od.NOT_FOUND=5]="NOT_FOUND",Od[Od.ALREADY_EXISTS=6]="ALREADY_EXISTS",Od[Od.PERMISSION_DENIED=7]="PERMISSION_DENIED",Od[Od.UNAUTHENTICATED=16]="UNAUTHENTICATED",Od[Od.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Od[Od.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Od[Od.ABORTED=10]="ABORTED",Od[Od.OUT_OF_RANGE=11]="OUT_OF_RANGE",Od[Od.UNIMPLEMENTED=12]="UNIMPLEMENTED",Od[Od.INTERNAL=13]="INTERNAL",Od[Od.UNAVAILABLE=14]="UNAVAILABLE",Od[Od.DATA_LOSS=15]="DATA_LOSS";var xd=new br(dr.comparator),Ri=new br(dr.comparator),Oi=new br(dr.comparator),Li=new ui(dr.comparator),qi=new ui(Un),Vi=function(){function a(o){this.comparator=o?function(r,t){return o(r,t)||dr.comparator(r.key,t.key)}:function(o,t){return dr.comparator(o.key,t.key)},this.keyedMap=$n(),this.sortedSet=new br(this.comparator)}return a.emptySet=function(e){return new a(e.comparator)},a.prototype.has=function(e){return null!=this.keyedMap.get(e)},a.prototype.get=function(e){return this.keyedMap.get(e)},a.prototype.first=function(){return this.sortedSet.minKey()},a.prototype.last=function(){return this.sortedSet.maxKey()},a.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},a.prototype.indexOf=function(o){var t=this.keyedMap.get(o);return t?this.sortedSet.indexOf(t):-1},Object.defineProperty(a.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),a.prototype.forEach=function(e){this.sortedSet.inorderTraversal(function(o){return e(o),!1})},a.prototype.add=function(o){var t=this.delete(o.key);return t.copy(t.keyedMap.insert(o.key,o),t.sortedSet.insert(o,null))},a.prototype.delete=function(o){var t=this.get(o);return t?this.copy(this.keyedMap.remove(o),this.sortedSet.remove(t)):this},a.prototype.isEqual=function(o){if(!(o instanceof a))return!1;if(this.size!==o.size)return!1;for(var t=this.sortedSet.getIterator(),e=o.sortedSet.getIterator();t.hasNext();){var n=t.getNext().key,r=e.getNext().key;if(!n.isEqual(r))return!1}return!0},a.prototype.toString=function(){var o=[];return this.forEach(function(e){o.push(e.toString())}),0===o.length?"DocumentSet ()":"DocumentSet (\n  "+o.join("  \n")+"\n)"},a.prototype.copy=function(o,t){var e=new a;return e.comparator=this.comparator,e.keyedMap=o,e.sortedSet=t,e},a}(),Wi,qd,Fd,Vd;(qd=Wi||(Wi={}))[qd.Added=0]="Added",qd[qd.Removed=1]="Removed",qd[qd.Modified=2]="Modified",qd[qd.Metadata=3]="Metadata",(Vd=Fd||(Fd={}))[Vd.Local=0]="Local",Vd[Vd.Synced=1]="Synced";var Bd=function(){function e(){this.changeMap=new br(dr.comparator)}return e.prototype.track=function(o){var t=o.doc.key,e=this.changeMap.get(t);e?o.type!==Wi.Added&&e.type===Wi.Metadata?this.changeMap=this.changeMap.insert(t,o):o.type===Wi.Metadata&&e.type!==Wi.Removed?this.changeMap=this.changeMap.insert(t,{type:e.type,doc:o.doc}):o.type===Wi.Modified&&e.type===Wi.Modified?this.changeMap=this.changeMap.insert(t,{type:Wi.Modified,doc:o.doc}):o.type===Wi.Modified&&e.type===Wi.Added?this.changeMap=this.changeMap.insert(t,{type:Wi.Added,doc:o.doc}):o.type===Wi.Removed&&e.type===Wi.Added?this.changeMap=this.changeMap.remove(t):o.type===Wi.Removed&&e.type===Wi.Modified?this.changeMap=this.changeMap.insert(t,{type:Wi.Removed,doc:e.doc}):o.type===Wi.Added&&e.type===Wi.Removed?this.changeMap=this.changeMap.insert(t,{type:Wi.Modified,doc:o.doc}):rn("unsupported combination of changes: "+JSON.stringify(o)+" after "+JSON.stringify(e)):this.changeMap=this.changeMap.insert(t,o)},e.prototype.getChanges=function(){var o=[];return this.changeMap.inorderTraversal(function(r,t){o.push(t)}),o},e}(),Hi=function(){function a(d,t,e,n,r,i,o,a){this.query=d,this.docs=t,this.oldDocs=e,this.docChanges=n,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}return a.fromInitialDocuments=function(o,t,e,n){var r=[];return t.forEach(function(e){r.push({type:Wi.Added,doc:e})}),new a(o,t,Vi.emptySet(t),r,e,n,!0,!1)},Object.defineProperty(a.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),a.prototype.isEqual=function(o){if(!(this.fromCache===o.fromCache&&this.syncStateChanged===o.syncStateChanged&&this.mutatedKeys.isEqual(o.mutatedKeys)&&this.query.isEqual(o.query)&&this.docs.isEqual(o.docs)&&this.oldDocs.isEqual(o.oldDocs)))return!1;var t=this.docChanges,e=o.docChanges;if(t.length!==e.length)return!1;for(var a=0;a<t.length;a++)if(t[a].type!==e[a].type||!t[a].doc.isEqual(e[a].doc))return!1;return!0},a}(),Yi=function(){function o(o,t,e,a,r){this.snapshotVersion=o,this.targetChanges=t,this.targetMismatches=e,this.documentUpdates=a,this.resolvedLimboDocuments=r}return o.createSynthesizedRemoteEventForCurrentChange=function(a,t){var e=((r={})[a]=Xi.createSynthesizedTargetChangeForCurrentChange(a,t),r),r;return new o(ii.MIN,e,ki(),Xn(),Ai())},o}(),Xi=function(){function o(o,t,e,a,r){this.resumeToken=o,this.current=t,this.addedDocuments=e,this.modifiedDocuments=a,this.removedDocuments=r}return o.createSynthesizedTargetChangeForCurrentChange=function(r,t){return new o(pn(),t,Ai(),Ai(),Ai())},o}(),Ji=function(o,t,e,a){this.updatedTargetIds=o,this.removedTargetIds=t,this.key=e,this.newDoc=a},$i=function(o,t){this.targetId=o,this.existenceFilter=t},Zi,Ud;(Ud=Zi||(Zi={}))[Ud.NoChange=0]="NoChange",Ud[Ud.Added=1]="Added",Ud[Ud.Removed=2]="Removed",Ud[Ud.Current=3]="Current",Ud[Ud.Reset=4]="Reset";var Qd=function(o,t,e,a){void 0===e&&(e=pn()),void 0===a&&(a=null),this.state=o,this.targetIds=t,this.resumeToken=e,this.cause=a},to=function(){function e(){this.pendingResponses=0,this.documentChanges=ro(),this._resumeToken=pn(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(e.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),e.prototype.updateResumeToken=function(e){0<e.length&&(this._hasPendingChanges=!0,this._resumeToken=e)},e.prototype.toTargetChange=function(){var o=Ai(),a=Ai(),s=Ai();return this.documentChanges.forEach(function(r,t){t===Wi.Added?o=o.add(r):t===Wi.Modified?a=a.add(r):t===Wi.Removed?s=s.add(r):rn("Encountered invalid change type: "+t)}),new Xi(this._resumeToken,this._current,o,a,s)},e.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=ro()},e.prototype.addDocumentChange=function(o,t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(o,t)},e.prototype.removeDocumentChange=function(e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(e)},e.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},e.prototype.recordTargetResponse=function(){this.pendingResponses-=1},e.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},e}(),eo=function(){function e(e){this.metadataProvider=e,this.targetStates={},this.pendingDocumentUpdates=Xn(),this.pendingDocumentTargetMapping=Mi(),this.pendingTargetResets=new ui(Un)}return e.prototype.handleDocumentChange=function(a){for(var t=0,s=a.updatedTargetIds,n;t<s.length;t++)n=s[t],a.newDoc instanceof yr?this.addDocumentToTarget(n,a.newDoc):a.newDoc instanceof gr&&this.removeDocumentFromTarget(n,a.key,a.newDoc);for(var d=0,l=a.removedTargetIds;d<l.length;d++)n=l[d],this.removeDocumentFromTarget(n,a.key,a.newDoc)},e.prototype.handleTargetChange=function(o){var a=this;this.forEachTarget(o,function(r){var t=a.ensureTargetState(r);switch(o.state){case Zi.NoChange:a.isActiveTarget(r)&&t.updateResumeToken(o.resumeToken);break;case Zi.Added:t.recordTargetResponse(),t.isPending||t.clearPendingChanges(),t.updateResumeToken(o.resumeToken);break;case Zi.Removed:t.recordTargetResponse(),t.isPending||a.removeTarget(r),dn(!o.cause,"WatchChangeAggregator does not handle errored targets");break;case Zi.Current:a.isActiveTarget(r)&&(t.markCurrent(),t.updateResumeToken(o.resumeToken));break;case Zi.Reset:a.isActiveTarget(r)&&(a.resetTarget(r),t.updateResumeToken(o.resumeToken));break;default:rn("Unknown target watch change state: "+o.state);}})},e.prototype.forEachTarget=function(o,t){0<o.targetIds.length?o.targetIds.forEach(t):fn(this.targetStates,t)},e.prototype.handleExistenceFilter=function(a){var t=a.targetId,e=a.existenceFilter.count,n=this.queryDataForActiveTarget(t);if(n){var r=n.query;if(!r.isDocumentQuery())this.getCurrentDocumentCountForTarget(t)!==e&&(this.resetTarget(t),this.pendingTargetResets=this.pendingTargetResets.add(t));else if(0===e){var i=new dr(r.path);this.removeDocumentFromTarget(t,i,new gr(i,ii.forDeletedDoc()))}else dn(1===e,"Single document existence filter with count: "+e)}},e.prototype.createRemoteEvent=function(e){var i=this,o={};fn(this.targetStates,function(a,t){var s=i.queryDataForActiveTarget(a);if(s){if(t.current&&s.query.isDocumentQuery()){var n=new dr(s.query.path);null!==i.pendingDocumentUpdates.get(n)||i.targetContainsDocument(a,n)||i.removeDocumentFromTarget(a,n,new gr(n,e))}t.hasPendingChanges&&(o[a]=t.toTargetChange(),t.clearPendingChanges())}});var a=Ai();this.pendingDocumentTargetMapping.forEach(function(o,t){var r=!0;t.forEachWhile(function(o){var t=i.queryDataForActiveTarget(o);return!t||t.purpose===oi.LimboResolution||(r=!1)}),r&&(a=a.add(o))});var n=new Yi(e,o,this.pendingTargetResets,this.pendingDocumentUpdates,a);return this.pendingDocumentUpdates=Xn(),this.pendingDocumentTargetMapping=Mi(),this.pendingTargetResets=new ui(Un),n},e.prototype.addDocumentToTarget=function(o,t){if(this.isActiveTarget(o)){var e=this.targetContainsDocument(o,t.key)?Wi.Modified:Wi.Added;this.ensureTargetState(o).addDocumentChange(t.key,e),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t.key,t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t.key,this.ensureDocumentTargetMapping(t.key).add(o))}},e.prototype.removeDocumentFromTarget=function(o,t,e){if(this.isActiveTarget(o)){var a=this.ensureTargetState(o);this.targetContainsDocument(o,t)?a.addDocumentChange(t,Wi.Removed):a.removeDocumentChange(t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,this.ensureDocumentTargetMapping(t).delete(o)),e&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t,e))}},e.prototype.removeTarget=function(e){delete this.targetStates[e]},e.prototype.getCurrentDocumentCountForTarget=function(o){var t=this.ensureTargetState(o).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(o).size+t.addedDocuments.size-t.removedDocuments.size},e.prototype.recordPendingTargetRequest=function(e){this.ensureTargetState(e).recordPendingTargetRequest()},e.prototype.ensureTargetState=function(e){return this.targetStates[e]||(this.targetStates[e]=new to),this.targetStates[e]},e.prototype.ensureDocumentTargetMapping=function(o){var t=this.pendingDocumentTargetMapping.get(o);return t||(t=new ui(Un),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(o,t)),t},e.prototype.isActiveTarget=function(e){return null!==this.queryDataForActiveTarget(e)},e.prototype.queryDataForActiveTarget=function(o){var t=this.targetStates[o];return t&&t.isPending?null:this.metadataProvider.getQueryDataForTarget(o)},e.prototype.resetTarget=function(o){var e=this;dn(!this.targetStates[o].isPending,"Should only reset active targets"),this.targetStates[o]=new to,this.metadataProvider.getRemoteKeysForTarget(o).forEach(function(r){e.removeDocumentFromTarget(o,r,null)})},e.prototype.targetContainsDocument=function(o,t){return this.metadataProvider.getRemoteKeysForTarget(o).has(t)},e}(),no=((wo={})[Zr.ASCENDING.name]="ASCENDING",wo[Zr.DESCENDING.name]="DESCENDING",wo),so=((Kd={})[Yr.LESS_THAN.name]="LESS_THAN",Kd[Yr.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Kd[Yr.GREATER_THAN.name]="GREATER_THAN",Kd[Yr.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Kd[Yr.EQUAL.name]="EQUAL",Kd[Yr.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Kd),uo=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),co=function(){function e(o,t){this.databaseId=o,this.options=t}return e.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},e.prototype.unsafeCastProtoByteString=function(e){return e},e.prototype.fromRpcStatus=function(o){var t=void 0===o.code?bn.UNKNOWN:Yn(o.code);return new En(t,o.message||"")},e.prototype.toInt32Value=function(e){return kr(e)?void 0:{value:e}},e.prototype.fromInt32Value=function(o){var t;return kr(t="object"==typeof o?o.value:o)?null:t},e.prototype.toTimestamp=function(e){return{seconds:e.seconds,nanos:e.nanoseconds}},e.prototype.fromTimestamp=function(o){if("string"==typeof o)return this.fromIso8601String(o);dn(!!o,"Cannot deserialize null or undefined timestamp.");var t=ho(o.seconds||"0"),e=o.nanos||0;return new or(t,e)},e.prototype.fromIso8601String=function(a){var t=0,s=uo.exec(a);if(dn(!!s,"invalid timestamp: "+a),s[1]){var n=s[1];n=(n+"000000000").substr(0,9),t=+n}var d=new Date(a),i=dd(d.getTime()/1e3);return new or(i,t)},e.prototype.toBytes=function(e){return this.options.useProto3Json?e.toBase64():this.unsafeCastProtoByteString(e.toUint8Array())},e.prototype.fromBlob=function(e){return"string"==typeof e?(dn(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),zn.fromBase64String(e)):(dn(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),zn.fromUint8Array(e))},e.prototype.toVersion=function(e){return this.toTimestamp(e.toTimestamp())},e.prototype.fromVersion=function(e){return dn(!!e,"Trying to deserialize version that isn't set"),ii.fromTimestamp(this.fromTimestamp(e))},e.prototype.toResourceName=function(o,t){return this.fullyQualifiedPrefixPath(o).child("documents").child(t).canonicalString()},e.prototype.fromResourceName=function(o){var t=lr.fromString(o);return dn(this.isValidResourceName(t),"Tried to deserialize invalid key "+t.toString()),t},e.prototype.toName=function(e){return this.toResourceName(this.databaseId,e.path)},e.prototype.fromName=function(o){var t=this.fromResourceName(o);return dn(t.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+t.get(1)+" vs "+this.databaseId.projectId),dn(!t.get(3)&&!this.databaseId.database||t.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+t.get(3)+" vs "+this.databaseId.database),new dr(this.extractLocalPathFromResourceName(t))},e.prototype.toQueryPath=function(e){return this.toResourceName(this.databaseId,e)},e.prototype.fromQueryPath=function(o){var t=this.fromResourceName(o);return 4===t.length?lr.EMPTY_PATH:this.extractLocalPathFromResourceName(t)},Object.defineProperty(e.prototype,"encodedDatabaseId",{get:function(){return new lr(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),e.prototype.fullyQualifiedPrefixPath=function(e){return new lr(["projects",e.projectId,"databases",e.database])},e.prototype.extractLocalPathFromResourceName=function(e){return dn(4<e.length&&"documents"===e.get(4),"tried to deserialize invalid key "+e.toString()),e.popFirst(5)},e.prototype.isValidResourceName=function(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)},e.prototype.toValue=function(o){if(o instanceof Cr)return{nullValue:"NULL_VALUE"};if(o instanceof Dr)return{booleanValue:o.value()};if(o instanceof Ar)return{integerValue:""+o.value()};if(o instanceof Rr){var t=o.value();if(this.options.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:o.value()}}return o instanceof Mr?{stringValue:o.value()}:o instanceof qr?{mapValue:this.toMapValue(o)}:o instanceof Fr?{arrayValue:this.toArrayValue(o)}:o instanceof _r?{timestampValue:this.toTimestamp(o.internalValue)}:o instanceof xr?{geoPointValue:{latitude:o.value().latitude,longitude:o.value().longitude}}:o instanceof Pr?{bytesValue:this.toBytes(o.value())}:o instanceof Lr?{referenceValue:this.toResourceName(o.databaseId,o.key.path)}:rn("Unknown FieldValue "+JSON.stringify(o))},e.prototype.fromValue=function(d){var l=this,e=d.value_type;if(lo(d,e,"nullValue"))return Cr.INSTANCE;if(lo(d,e,"booleanValue"))return Dr.of(d.booleanValue);if(lo(d,e,"integerValue"))return new Ar(ho(d.integerValue));if(lo(d,e,"doubleValue")){if(this.options.useProto3Json){if("NaN"===d.doubleValue)return Rr.NAN;if("Infinity"===d.doubleValue)return Rr.POSITIVE_INFINITY;if("-Infinity"===d.doubleValue)return Rr.NEGATIVE_INFINITY}return new Rr(d.doubleValue)}if(lo(d,e,"stringValue"))return new Mr(d.stringValue);if(lo(d,e,"mapValue"))return this.fromFields(d.mapValue.fields||{});if(lo(d,e,"arrayValue")){io(d.arrayValue,"arrayValue");var t=d.arrayValue.values||[];return new Fr(t.map(function(e){return l.fromValue(e)}))}if(lo(d,e,"timestampValue"))return io(d.timestampValue,"timestampValue"),new _r(this.fromTimestamp(d.timestampValue));if(lo(d,e,"geoPointValue")){io(d.geoPointValue,"geoPointValue");var r=d.geoPointValue.latitude||0,n=d.geoPointValue.longitude||0;return new xr(new ir(r,n))}if(lo(d,e,"bytesValue")){io(d.bytesValue,"bytesValue");var o=this.fromBlob(d.bytesValue);return new Pr(o)}if(lo(d,e,"referenceValue")){io(d.referenceValue,"referenceValue");var a=this.fromResourceName(d.referenceValue),i=new ur(a.get(1),a.get(3)),s=new dr(this.extractLocalPathFromResourceName(a));return new Lr(i,s)}return rn("Unknown Value proto "+JSON.stringify(d))},e.prototype.toMutationDocument=function(o,t){return{name:this.toName(o),fields:this.toFields(t)}},e.prototype.toDocument=function(e){return dn(!e.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(e.key),fields:this.toFields(e.data),updateTime:this.toTimestamp(e.version.toTimestamp())}},e.prototype.fromDocument=function(o,t){return new yr(this.fromName(o.name),this.fromVersion(o.updateTime),this.fromFields(o.fields||{}),{hasCommittedMutations:!!t})},e.prototype.toFields=function(e){var o=this,a={};return e.forEach(function(r,t){a[r]=o.toValue(t)}),a},e.prototype.fromFields=function(e){var o=this,a=qr.EMPTY;return Tn(e,function(r,t){a=a.set(new pr([r]),o.fromValue(t))}),a},e.prototype.toMapValue=function(e){return{fields:this.toFields(e)}},e.prototype.toArrayValue=function(o){var r=this,e=[];return o.forEach(function(o){e.push(r.toValue(o))}),{values:e}},e.prototype.fromFound=function(o){dn(!!o.found,"Tried to deserialize a found document from a missing document."),io(o.found.name,"doc.found.name"),io(o.found.updateTime,"doc.found.updateTime");var t=this.fromName(o.found.name),e=this.fromVersion(o.found.updateTime),a=this.fromFields(o.found.fields||{});return new yr(t,e,a,{},o.found)},e.prototype.fromMissing=function(o){dn(!!o.missing,"Tried to deserialize a missing document from a found document."),dn(!!o.readTime,"Tried to deserialize a missing document without a read time.");var t=this.fromName(o.missing),e=this.fromVersion(o.readTime);return new gr(t,e)},e.prototype.fromMaybeDocument=function(o){var t=o.result;return lo(o,t,"found")?this.fromFound(o):lo(o,t,"missing")?this.fromMissing(o):rn("invalid batch get response: "+JSON.stringify(o))},e.prototype.toWatchTargetChangeState=function(e){return e===Zi.Added?"ADD":e===Zi.Current?"CURRENT":e===Zi.NoChange?"NO_CHANGE":e===Zi.Removed?"REMOVE":e===Zi.Reset?"RESET":rn("Unknown WatchTargetChangeState: "+e)},e.prototype.toTestWatchChange=function(o){if(o instanceof $i)return{filter:{count:o.existenceFilter.count,targetId:o.targetId}};if(o instanceof Ji){if(o.newDoc instanceof yr){var t=o.newDoc;return{documentChange:{document:{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toVersion(t.version)},targetIds:o.updatedTargetIds,removedTargetIds:o.removedTargetIds}}}if(o.newDoc instanceof gr)return t=o.newDoc,{documentDelete:{document:this.toName(t.key),readTime:this.toVersion(t.version),removedTargetIds:o.removedTargetIds}};if(null===o.newDoc)return{documentRemove:{document:this.toName(o.key),removedTargetIds:o.removedTargetIds}}}if(o instanceof Qd){var r;return o.cause&&(r={code:function(e){return void 0===e?Ni.OK:e===bn.OK?Ni.OK:e===bn.CANCELLED?Ni.CANCELLED:e===bn.UNKNOWN?Ni.UNKNOWN:e===bn.DEADLINE_EXCEEDED?Ni.DEADLINE_EXCEEDED:e===bn.RESOURCE_EXHAUSTED?Ni.RESOURCE_EXHAUSTED:e===bn.INTERNAL?Ni.INTERNAL:e===bn.UNAVAILABLE?Ni.UNAVAILABLE:e===bn.UNAUTHENTICATED?Ni.UNAUTHENTICATED:e===bn.INVALID_ARGUMENT?Ni.INVALID_ARGUMENT:e===bn.NOT_FOUND?Ni.NOT_FOUND:e===bn.ALREADY_EXISTS?Ni.ALREADY_EXISTS:e===bn.PERMISSION_DENIED?Ni.PERMISSION_DENIED:e===bn.FAILED_PRECONDITION?Ni.FAILED_PRECONDITION:e===bn.ABORTED?Ni.ABORTED:e===bn.OUT_OF_RANGE?Ni.OUT_OF_RANGE:e===bn.UNIMPLEMENTED?Ni.UNIMPLEMENTED:e===bn.DATA_LOSS?Ni.DATA_LOSS:rn("Unknown status code: "+e)}(o.cause.code),message:o.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(o.state),targetIds:o.targetIds,resumeToken:this.unsafeCastProtoByteString(o.resumeToken),cause:r}}}return rn("Unrecognized watch change: "+JSON.stringify(o))},e.prototype.fromWatchChange=function(E){var t=E.response_type,n;if(lo(E,t,"targetChange")){io(E.targetChange,"targetChange");var T=this.fromWatchTargetChangeState(E.targetChange.targetChangeType||"NO_CHANGE"),r=E.targetChange.targetIds||[],i=E.targetChange.resumeToken||this.emptyByteString(),o=E.targetChange.cause,a=o&&this.fromRpcStatus(o);n=new Qd(T,r,i,a||null)}else if(lo(E,t,"documentChange")){io(E.documentChange,"documentChange"),io(E.documentChange.document,"documentChange.name"),io(E.documentChange.document.name,"documentChange.document.name"),io(E.documentChange.document.updateTime,"documentChange.document.updateTime");var s=E.documentChange,u=this.fromName(s.document.name),S=this.fromVersion(s.document.updateTime),I=this.fromFields(s.document.fields||{}),l=new yr(u,S,I,{},s.document),C=s.targetIds||[],p=s.removedTargetIds||[];n=new Ji(C,p,l.key,l)}else if(lo(E,t,"documentDelete")){io(E.documentDelete,"documentDelete"),io(E.documentDelete.document,"documentDelete.document");var D=E.documentDelete;u=this.fromName(D.document),S=D.readTime?this.fromVersion(D.readTime):ii.forDeletedDoc(),l=new gr(u,S),p=D.removedTargetIds||[],n=new Ji([],p,l.key,l)}else if(lo(E,t,"documentRemove")){io(E.documentRemove,"documentRemove"),io(E.documentRemove.document,"documentRemove");var m=E.documentRemove;u=this.fromName(m.document),p=m.removedTargetIds||[],n=new Ji([],p,u,null)}else{if(!lo(E,t,"filter"))return rn("Unknown change type "+JSON.stringify(E));io(E.filter,"filter"),io(E.filter.targetId,"filter.targetId");var y=E.filter,g=y.count||0,v=new Ti(g),b=y.targetId;n=new $i(b,v)}return n},e.prototype.fromWatchTargetChangeState=function(e){return"NO_CHANGE"===e?Zi.NoChange:"ADD"===e?Zi.Added:"REMOVE"===e?Zi.Removed:"CURRENT"===e?Zi.Current:"RESET"===e?Zi.Reset:rn("Got unexpected TargetChange.state: "+e)},e.prototype.versionFromListenResponse=function(o){if(!lo(o,o.response_type,"targetChange"))return ii.MIN;var t=o.targetChange;return t.targetIds&&t.targetIds.length?ii.MIN:t.readTime?this.fromVersion(t.readTime):ii.MIN},e.prototype.toMutation=function(o){var r=this,t;if(o instanceof mi)t={update:this.toMutationDocument(o.key,o.value)};else if(o instanceof vi)t={delete:this.toName(o.key)};else if(o instanceof yi)t={update:this.toMutationDocument(o.key,o.data),updateMask:this.toDocumentMask(o.fieldMask)};else{if(!(o instanceof gi))return rn("Unknown mutation type "+o.type);t={transform:{document:this.toName(o.key),fieldTransforms:o.fieldTransforms.map(function(e){return r.toFieldTransform(e)})}}}return o.precondition.isNone||(t.currentDocument=this.toPrecondition(o.precondition)),t},e.prototype.fromMutation=function(s){var d=this,e=s.currentDocument?this.fromPrecondition(s.currentDocument):Ld.NONE;if(s.update){io(s.update.name,"name");var t=this.fromName(s.update.name),n=this.fromFields(s.update.fields||{});if(s.updateMask){var i=this.fromDocumentMask(s.updateMask);return new yi(t,n,i,e)}return new mi(t,n,e)}if(s.delete)return t=this.fromName(s.delete),new vi(t,e);if(s.transform){t=this.fromName(s.transform.document);var o=s.transform.fieldTransforms.map(function(e){return d.fromFieldTransform(e)});return dn(!0===e.exists,"Transforms only support precondition \"exists == true\""),new gi(t,o)}return rn("unknown mutation proto: "+JSON.stringify(s))},e.prototype.toPrecondition=function(e){return dn(!e.isNone,"Can't serialize an empty precondition"),void 0===e.updateTime?void 0===e.exists?rn("Unknown precondition"):{exists:e.exists}:{updateTime:this.toVersion(e.updateTime)}},e.prototype.fromPrecondition=function(e){return void 0===e.updateTime?void 0===e.exists?Ld.NONE:Ld.exists(e.exists):Ld.updateTime(this.fromVersion(e.updateTime))},e.prototype.fromWriteResult=function(o,t){var e=this,a=o.updateTime?this.fromVersion(o.updateTime):this.fromVersion(t),r=null;return o.transformResults&&0<o.transformResults.length&&(r=o.transformResults.map(function(o){return e.fromValue(o)})),new fi(a,r)},e.prototype.fromWriteResults=function(o,r){var e=this;return o&&0<o.length?(dn(void 0!==r,"Received a write result without a commit time"),o.map(function(o){return e.fromWriteResult(o,r)})):[]},e.prototype.toFieldTransform=function(o){var r=this,e=o.transform;if(e instanceof bi)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(e instanceof wi)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:e.elements.map(function(e){return r.toValue(e)})}};if(e instanceof Ei)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:e.elements.map(function(e){return r.toValue(e)})}};if(e instanceof Si)return{fieldPath:o.field.canonicalString(),increment:this.toValue(e.operand)};throw rn("Unknown transform: "+o.transform)},e.prototype.fromFieldTransform=function(s){var d=this,e=s.transform_type,t=null;if(lo(s,e,"setToServerValue"))dn("REQUEST_TIME"===s.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(s)),t=bi.instance;else if(lo(s,e,"appendMissingElements")){var n=s.appendMissingElements.values||[];t=new wi(n.map(function(e){return d.fromValue(e)}))}else if(lo(s,e,"removeAllFromArray"))n=s.removeAllFromArray.values||[],t=new Ei(n.map(function(e){return d.fromValue(e)}));else if(lo(s,e,"increment")){var l=this.fromValue(s.increment);dn(l instanceof Nr,"NUMERIC_ADD transform requires a NumberValue"),t=new Si(l)}else rn("Unknown transform proto: "+JSON.stringify(s));var o=pr.fromServerFormat(s.fieldPath);return new li(o,t)},e.prototype.toDocumentsTarget=function(e){return{documents:[this.toQueryPath(e.path)]}},e.prototype.fromDocumentsTarget=function(o){var t=o.documents.length;dn(1===t,"DocumentsTarget contained other than 1 document: "+t);var e=o.documents[0];return Kr.atPath(this.fromQueryPath(e))},e.prototype.toQueryTarget=function(a){var t={structuredQuery:{}},e=a.path;null===a.collectionGroup?(dn(0!=e.length%2,"Document queries with filters are not supported."),t.parent=this.toQueryPath(e.popLast()),t.structuredQuery.from=[{collectionId:e.lastSegment()}]):(dn(0==e.length%2,"Collection Group queries should be within a document path or root."),t.parent=this.toQueryPath(e),t.structuredQuery.from=[{collectionId:a.collectionGroup,allDescendants:!0}]);var n=this.toFilter(a.filters);n&&(t.structuredQuery.where=n);var r=this.toOrder(a.orderBy);r&&(t.structuredQuery.orderBy=r);var i=this.toInt32Value(a.limit);return void 0!==i&&(t.structuredQuery.limit=i),a.startAt&&(t.structuredQuery.startAt=this.toCursor(a.startAt)),a.endAt&&(t.structuredQuery.endAt=this.toCursor(a.endAt)),t},e.prototype.fromQueryTarget=function(d){var t=this.fromQueryPath(d.parent),l=d.structuredQuery,n=l.from?l.from.length:0,r=null;if(0<n){dn(1===n,"StructuredQuery.from with more than one collection is not supported.");var p=l.from[0];p.allDescendants?r=p.collectionId:t=t.child(p.collectionId)}var o=[];l.where&&(o=this.fromFilter(l.where));var m=[];l.orderBy&&(m=this.fromOrder(l.orderBy));var y=null;l.limit&&(y=this.fromInt32Value(l.limit));var g=null;l.startAt&&(g=this.fromCursor(l.startAt));var f=null;return l.endAt&&(f=this.fromCursor(l.endAt)),new Kr(t,r,m,o,y,g,f)},e.prototype.toListenRequestLabels=function(o){var t=this.toLabel(o.purpose);return null==t?null:{"goog-listen-tags":t}},e.prototype.toLabel=function(e){return e===oi.Listen?null:e===oi.ExistenceFilterMismatch?"existence-filter-mismatch":e===oi.LimboResolution?"limbo-document":rn("Unrecognized query purpose: "+e)},e.prototype.toTarget=function(o){var t=o.query,r;return(r=t.isDocumentQuery()?{documents:this.toDocumentsTarget(t)}:{query:this.toQueryTarget(t)}).targetId=o.targetId,0<o.resumeToken.length&&(r.resumeToken=this.unsafeCastProtoByteString(o.resumeToken)),r},e.prototype.toFilter=function(o){var r=this;if(0!==o.length){var e=o.map(function(e){return e instanceof Xr?r.toRelationFilter(e):r.toUnaryFilter(e)});return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}},e.prototype.fromFilter=function(o){var r=this;return o?void 0===o.unaryFilter?void 0===o.fieldFilter?void 0===o.compositeFilter?rn("Unknown filter: "+JSON.stringify(o)):o.compositeFilter.filters.map(function(e){return r.fromFilter(e)}).reduce(function(o,t){return o.concat(t)}):[this.fromRelationFilter(o)]:[this.fromUnaryFilter(o)]:[]},e.prototype.toOrder=function(o){var r=this;if(0!==o.length)return o.map(function(e){return r.toPropertyOrder(e)})},e.prototype.fromOrder=function(o){var r=this;return o.map(function(e){return r.fromPropertyOrder(e)})},e.prototype.toCursor=function(o){var r=this;return{before:o.before,values:o.position.map(function(e){return r.toValue(e)})}},e.prototype.fromCursor=function(o){var a=this,e=!!o.before,t=o.values.map(function(e){return a.fromValue(e)});return new ti(t,e)},e.prototype.toDirection=function(e){return no[e.name]},e.prototype.fromDirection=function(e){return"ASCENDING"===e?Zr.ASCENDING:"DESCENDING"===e?Zr.DESCENDING:void 0},e.prototype.toOperatorName=function(e){return so[e.name]},e.prototype.fromOperatorName=function(e){return"EQUAL"===e?Yr.EQUAL:"GREATER_THAN"===e?Yr.GREATER_THAN:"GREATER_THAN_OR_EQUAL"===e?Yr.GREATER_THAN_OR_EQUAL:"LESS_THAN"===e?Yr.LESS_THAN:"LESS_THAN_OR_EQUAL"===e?Yr.LESS_THAN_OR_EQUAL:"ARRAY_CONTAINS"===e?Yr.ARRAY_CONTAINS:"OPERATOR_UNSPECIFIED"===e?rn("Unspecified relation"):rn("Unknown relation")},e.prototype.toFieldPathReference=function(e){return{fieldPath:e.canonicalString()}},e.prototype.fromFieldPathReference=function(e){return pr.fromServerFormat(e.fieldPath)},e.prototype.toPropertyOrder=function(e){return{field:this.toFieldPathReference(e.field),direction:this.toDirection(e.dir)}},e.prototype.fromPropertyOrder=function(e){return new ei(this.fromFieldPathReference(e.field),this.fromDirection(e.direction))},e.prototype.toRelationFilter=function(e){return e instanceof Xr?{fieldFilter:{field:this.toFieldPathReference(e.field),op:this.toOperatorName(e.op),value:this.toValue(e.value)}}:rn("Unrecognized filter: "+JSON.stringify(e))},e.prototype.fromRelationFilter=function(e){return new Xr(this.fromFieldPathReference(e.fieldFilter.field),this.fromOperatorName(e.fieldFilter.op),this.fromValue(e.fieldFilter.value))},e.prototype.toUnaryFilter=function(e){return e instanceof $r?{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NAN"}}:e instanceof Jr?{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NULL"}}:rn("Unrecognized filter: "+JSON.stringify(e))},e.prototype.fromUnaryFilter=function(o){switch(o.unaryFilter.op){case"IS_NAN":var t=this.fromFieldPathReference(o.unaryFilter.field);return new $r(t);case"IS_NULL":var e=this.fromFieldPathReference(o.unaryFilter.field);return new Jr(e);case"OPERATOR_UNSPECIFIED":return rn("Unspecified filter");default:return rn("Unknown filter");}},e.prototype.toDocumentMask=function(o){var r=[];return o.fields.forEach(function(e){return r.push(e.canonicalString())}),{fieldPaths:r}},e.prototype.fromDocumentMask=function(o){var t=(o.fieldPaths||[]).map(function(e){return pr.fromServerFormat(e)});return hi.fromArray(t)},e}(),fo=function(){function e(e){this.sendFn=e.sendFn,this.closeFn=e.closeFn}return e.prototype.onOpen=function(e){dn(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=e},e.prototype.onClose=function(e){dn(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=e},e.prototype.onMessage=function(e){dn(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=e},e.prototype.close=function(){this.closeFn()},e.prototype.send=function(e){this.sendFn(e)},e.prototype.callOnOpen=function(){dn(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},e.prototype.callOnClose=function(e){dn(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(e)},e.prototype.callOnMessage=function(e){dn(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(e)},e}(),mo="Connection",yo={BatchGetDocuments:"batchGet",Commit:"commit"},go=function(){function e(o){this.databaseId=o.databaseId;var t=o.ssl?"https":"http";this.baseUrl=t+"://"+o.host}return e.prototype.modifyHeadersForRequest=function(o,t){if(t)for(var e in t.authHeaders)t.authHeaders.hasOwnProperty(e)&&(o[e]=t.authHeaders[e]);o["X-Goog-Api-Client"]="gl-js/ fire/"+cn},e.prototype.invokeRPC=function(d,o,a){var s=this,l=this.makeUrl(d);return new Promise(function(c,n){var r=new en;r.listenOnce(Ze.COMPLETE,function(){try{switch(r.getLastErrorCode()){case $e.NO_ERROR:var o=r.getResponseJson();Ro(mo,"XHR received:",JSON.stringify(o)),c(o);break;case $e.TIMEOUT:Ro(mo,"RPC \""+d+"\" timed out"),n(new En(bn.DEADLINE_EXCEEDED,"Request time out"));break;case $e.HTTP_ERROR:var t=r.getStatus();Ro(mo,"RPC \""+d+"\" failed with status:",t,"response text:",r.getResponseText()),0<t?n(new En(function(e){return 200===e?bn.OK:400===e?bn.INVALID_ARGUMENT:401===e?bn.UNAUTHENTICATED:403===e?bn.PERMISSION_DENIED:404===e?bn.NOT_FOUND:409===e?bn.ABORTED:416===e?bn.OUT_OF_RANGE:429===e?bn.RESOURCE_EXHAUSTED:499===e?bn.CANCELLED:500===e?bn.UNKNOWN:501===e?bn.UNIMPLEMENTED:503===e?bn.UNAVAILABLE:504===e?bn.DEADLINE_EXCEEDED:200<=e&&300>e?bn.OK:400<=e&&500>e?bn.FAILED_PRECONDITION:500<=e&&600>e?bn.INTERNAL:bn.UNKNOWN}(t),"Server responded with status "+r.getStatusText())):(Ro(mo,"RPC \""+d+"\" failed"),n(new En(bn.UNAVAILABLE,"Connection failed.")));break;default:rn("RPC \""+d+"\" failed with unanticipated webchannel error "+r.getLastErrorCode()+": "+r.getLastError()+", giving up.");}}finally{Ro(mo,"RPC \""+d+"\" completed.")}});var i=JSON.stringify(o);Ro(mo,"XHR sending: ",l+" "+i);var t={"Content-Type":"text/plain"};s.modifyHeadersForRequest(t,a),r.send(l,"POST",i,t,15)})},e.prototype.invokeStreamingRPC=function(o,t,e){return this.invokeRPC(o,t,e)},e.prototype.openStream=function(d,t){var e=[this.baseUrl,"/","google.firestore.v1.Firestore","/",d,"/channel"],n=Je(),r={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5}};this.modifyHeadersForRequest(r.initMessageHeaders,t),"object"==typeof navigator&&"ReactNative"===navigator.product||(r.httpHeadersOverwriteParam="$httpHeaders");var i=e.join("");Ro(mo,"Creating WebChannel: "+i+" "+r);var l=n.createWebChannel(i,r),o=!1,a=!1,p=new fo({sendFn:function(e){a?Ro(mo,"Not sending because WebChannel is closed:",e):(o||(Ro(mo,"Opening WebChannel transport."),l.open(),o=!0),Ro(mo,"WebChannel sending:",e),l.send(e))},closeFn:function(){return l.close()}}),c=function(o,r){l.listen(o,function(e){try{r(e)}catch(e){setTimeout(function(){throw e},0)}})};return c(tn.EventType.OPEN,function(){a||Ro(mo,"WebChannel transport opened.")}),c(tn.EventType.CLOSE,function(){a||(a=!0,Ro(mo,"WebChannel transport closed"),p.callOnClose())}),c(tn.EventType.ERROR,function(e){a||(a=!0,Ro(mo,"WebChannel transport errored:",e),p.callOnClose(new En(bn.UNAVAILABLE,"The operation could not be completed")))}),c(tn.EventType.MESSAGE,function(s){if(!a){var t=s.data[0];dn(!!t,"Got a webchannel message without data.");var e=t.error||t[0]&&t[0].error;if(e){Ro(mo,"WebChannel received error:",e);var n=e.status,r=function(o){var t=Ni[o];if(void 0!==t)return Yn(t)}(n),d=e.message;void 0===r&&(r=bn.INTERNAL,d="Unknown error status: "+n+" with message "+e.message),a=!0,p.callOnClose(new En(r,d)),l.close()}else Ro(mo,"WebChannel received:",t),p.callOnMessage(t)}}),setTimeout(function(){p.callOnOpen()},0),p},e.prototype.makeUrl=function(o){var t=yo[o];dn(void 0!==t,"Unknown REST mapping for: "+o);var e=[this.baseUrl,"/","v1"];return e.push("/projects/"),e.push(this.databaseId.projectId),e.push("/databases/"),e.push(this.databaseId.database),e.push("/documents"),e.push(":"),e.push(t),e.join("")},e}(),bo=function(){function e(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(e.prototype,"document",{get:function(){return"undefined"==typeof document?null:document},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"window",{get:function(){return"undefined"==typeof window?null:window},enumerable:!0,configurable:!0}),e.prototype.loadConnection=function(e){return Promise.resolve(new go(e))},e.prototype.newSerializer=function(e){return new co(e,{useProto3Json:!0})},e.prototype.formatJSON=function(e){return JSON.stringify(e)},e.prototype.atob=function(e){return atob(e)},e.prototype.btoa=function(e){return btoa(e)},e}(),wo,Kd;Ad.setPlatform(new bo);var Wd=function(){function e(o,r){var e=this;this.previousValue=o,r&&(r.sequenceNumberHandler=function(o){return e.setPreviousValue(o)},this.writeNewSequenceNumber=function(e){return r.writeSequenceNumber(e)})}return e.prototype.setPreviousValue=function(e){return this.previousValue=ld(e,this.previousValue),this.previousValue},e.prototype.next=function(){var e=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(e),e},e.INVALID=-1,e}(),To=function(){var o=this;this.promise=new Promise(function(r,t){o.resolve=r,o.reject=t})},Io,Gd;(Gd=Io||(Io={})).All="all",Gd.ListenStreamIdle="listen_stream_idle",Gd.ListenStreamConnectionBackoff="listen_stream_connection_backoff",Gd.WriteStreamIdle="write_stream_idle",Gd.WriteStreamConnectionBackoff="write_stream_connection_backoff",Gd.OnlineStateTimeout="online_state_timeout",Gd.ClientMetadataRefresh="client_metadata_refresh",Gd.LruGarbageCollection="lru_garbage_collection";var zd=function(){function s(o,t,e,a,r){this.asyncQueue=o,this.timerId=t,this.targetTimeMs=e,this.op=a,this.removalCallback=r,this.deferred=new To,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(){})}return s.createAndSchedule=function(a,t,e,n,r){var i=new s(a,t,Date.now()+e,n,r);return i.start(e),i},s.prototype.start=function(o){var t=this;this.timerHandle=setTimeout(function(){return t.handleDelayElapsed()},o)},s.prototype.skipDelay=function(){return this.handleDelayElapsed()},s.prototype.cancel=function(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new En(bn.CANCELLED,"Operation cancelled"+(e?": "+e:""))))},s.prototype.handleDelayElapsed=function(){var o=this;this.asyncQueue.enqueueAndForget(function(){return null===o.timerHandle?Promise.resolve():(o.clearTimeout(),o.op().then(function(e){return o.deferred.resolve(e)}))})},s.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},s}(),Co=function(){function e(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return e.prototype.enqueueAndForget=function(e){this.enqueue(e)},e.prototype.enqueue=function(o){var r=this;this.verifyNotFailed();var t=this.tail.then(function(){return r.operationInProgress=!0,o().catch(function(o){r.failure=o,r.operationInProgress=!1;var t=o.stack||o.message||"";throw Ho("INTERNAL UNHANDLED ERROR: ",t),0>t.indexOf("Firestore Test Simulated Error")&&setTimeout(function(){throw o},0),o}).then(function(e){return r.operationInProgress=!1,e})});return this.tail=t},e.prototype.enqueueAfterDelay=function(o,t,e){var a=this;this.verifyNotFailed(),dn(0<=t,"Attempted to schedule an operation with a negative delay of "+t),dn(!this.containsDelayedOperation(o),"Attempted to schedule multiple operations with timer id "+o+".");var r=zd.createAndSchedule(this,o,t,e,function(e){return a.removeDelayedOperation(e)});return this.delayedOperations.push(r),r},e.prototype.verifyNotFailed=function(){this.failure&&rn("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},e.prototype.verifyOperationInProgress=function(){dn(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},e.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},e.prototype.containsDelayedOperation=function(o){for(var t=0,r=this.delayedOperations;t<r.length;t++)if(r[t].timerId===o)return!0;return!1},e.prototype.runDelayedOperationsEarly=function(o){var r=this;return this.drain().then(function(){dn(o===Io.All||r.containsDelayedOperation(o),"Attempted to drain to missing operation "+o),r.delayedOperations.sort(function(o,t){return o.targetTimeMs-t.targetTimeMs});for(var a=0,i=r.delayedOperations,e;a<i.length&&(e=i[a],e.skipDelay(),o===Io.All||e.timerId!==o);a++);return r.drain()})},e.prototype.removeDelayedOperation=function(o){var t=this.delayedOperations.indexOf(o);dn(0<=t,"Delayed operation not found."),this.delayedOperations.splice(t,1)},e}(),Do=function(){function e(o,t,e,a){this.batchId=o,this.localWriteTime=t,this.baseMutations=e,dn(0<(this.mutations=a).length,"Cannot create an empty mutation batch")}return e.prototype.applyToRemoteDocument=function(s,t,d){t&&dn(t.key.isEqual(s),"applyToRemoteDocument: key "+s+" should match maybeDoc key\n        "+t.key);var n=d.mutationResults;dn(n.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+n.length+").");for(var r=0,l;r<this.mutations.length;r++)if(l=this.mutations[r],l.key.isEqual(s)){var c=n[r];t=l.applyToRemoteDocument(t,c)}return t},e.prototype.applyToLocalView=function(d,t){t&&dn(t.key.isEqual(d),"applyToLocalDocument: key "+d+" should match maybeDoc key\n        "+t.key);for(var l=0,c=this.baseMutations;l<c.length;l++)(a=c[l]).key.isEqual(d)&&(t=a.applyToLocalView(t,t,this.localWriteTime));for(var r=t,i=0,p=this.mutations;i<p.length;i++){var a;(a=p[i]).key.isEqual(d)&&(t=a.applyToLocalView(t,r,this.localWriteTime))}return t},e.prototype.applyToLocalDocumentSet=function(o){var a=this,r=o;return this.mutations.forEach(function(n){var t=a.applyToLocalView(n.key,o.get(n.key));t&&(r=r.insert(n.key,t))}),r},e.prototype.keys=function(){return this.mutations.reduce(function(o,t){return o.add(t.key)},Ai())},e.prototype.isEqual=function(e){return this.batchId===e.batchId&&Qn(this.mutations,e.mutations)&&Qn(this.baseMutations,e.baseMutations)},e}(),Lo=function(){function d(o,t,e,a,r){this.batch=o,this.commitVersion=t,this.mutationResults=e,this.streamToken=a,this.docVersions=r}return d.from=function(s,t,e,n){dn(s.mutations.length===e.length,"Mutations sent "+s.mutations.length+" must equal results received "+e.length);for(var r=Ii(),l=s.mutations,o=0;o<l.length;o++)r=r.insert(l[o].key,e[o].version);return new d(s,t,e,n,r)},d}(),xo=function(){function s(o){var r=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,o(function(e){r.isDone=!0,r.result=e,r.nextCallback&&r.nextCallback(e)},function(e){r.isDone=!0,r.error=e,r.catchCallback&&r.catchCallback(e)})}return s.prototype.catch=function(e){return this.next(void 0,e)},s.prototype.next=function(a,r){var i=this;return this.callbackAttached&&rn("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(r,this.error):this.wrapSuccess(a,this.result):new s(function(o,e){i.nextCallback=function(r){i.wrapSuccess(a,r).next(o,e)},i.catchCallback=function(a){i.wrapFailure(r,a).next(o,e)}})},s.prototype.toPromise=function(){var o=this;return new Promise(function(r,t){o.next(r,t)})},s.prototype.wrapUserFunction=function(o){try{var t=o();return t instanceof s?t:s.resolve(t)}catch(e){return s.reject(e)}},s.prototype.wrapSuccess=function(o,t){return o?this.wrapUserFunction(function(){return o(t)}):s.resolve(t)},s.prototype.wrapFailure=function(o,t){return o?this.wrapUserFunction(function(){return o(t)}):s.reject(t)},s.resolve=function(e){return new s(function(o){o(e)})},s.reject=function(o){return new s(function(r,t){t(o)})},s.waitFor=function(a){return new s(function(t,e){var n=0,s=0,d=!1;a.forEach(function(o){++n,o.next(function(){++s,d&&s==n&&t()},function(o){return e(o)})}),d=!0,s==n&&t()})},s.or=function(o){for(var t=s.resolve(!1),a=function(o){t=t.next(function(e){return e?s.resolve(e):o()})},e=0,d=o;e<d.length;e++)a(d[e]);return t},s.forEach=function(e,o){var a=this,r=[];return e.forEach(function(n,t){r.push(o.call(a,n,t))}),this.waitFor(r)},s}(),qo=function(){function o(o,t,e,a){this.userId=o,this.serializer=t,this.indexManager=e,this.referenceDelegate=a,this.documentKeysByBatchId={}}return o.forUser=function(a,t,e,n){return dn(""!==a.uid,"UserID must not be an empty string."),new o(a.isAuthenticated()?a.uid:"",t,e,n)},o.prototype.checkEmpty=function(o){var a=!0,t=IDBKeyRange.bound([this.userId,id],[this.userId,nd]);return Uo(o).iterate({index:Ea.userMutationsIndex,range:t},function(o,t,e){a=!1,e.done()}).next(function(){return a})},o.prototype.acknowledgeBatch=function(o,e,r){return this.getMutationQueueMetadata(o).next(function(e){return e.lastStreamToken=Bo(r),Ko(o).put(e)})},o.prototype.getLastStreamToken=function(e){return this.getMutationQueueMetadata(e).next(function(e){return e.lastStreamToken})},o.prototype.setLastStreamToken=function(o,e){return this.getMutationQueueMetadata(o).next(function(r){return r.lastStreamToken=Bo(e),Ko(o).put(r)})},o.prototype.addMutationBatch=function(e,u,c,m){var l=this,y=Qo(e),p=Uo(e);return p.add({}).next(function(d){dn("number"==typeof d,"Auto-generated key is not a number");var t=new Do(d,u,c,m),h=l.serializer.toDbMutationBatch(l.userId,t);l.documentKeysByBatchId[d]=t.keys();for(var n=[],r=0,g=m;r<g.length;r++){var o=g[r],a=Sa.key(l.userId,o.key.path,d);n.push(p.put(h)),n.push(y.put(a,Sa.PLACEHOLDER)),n.push(l.indexManager.addToCollectionParentIndex(e,o.key.path.popLast()))}return xo.waitFor(n).next(function(){return t})})},o.prototype.lookupMutationBatch=function(o,r){var e=this;return Uo(o).get(r).next(function(o){return o?(dn(o.userId===e.userId,"Unexpected user '"+o.userId+"' for mutation batch "+r),e.serializer.fromDbMutationBatch(o)):null})},o.prototype.lookupMutationKeys=function(e,o){var a=this;return this.documentKeysByBatchId[o]?xo.resolve(this.documentKeysByBatchId[o]):this.lookupMutationBatch(e,o).next(function(r){if(r){var t=r.keys();return a.documentKeysByBatchId[o]=t}return null})},o.prototype.getNextMutationBatchAfterBatchId=function(t,n){var o=this;return this.getMutationQueueMetadata(t).next(function(){var a=n+1,r=IDBKeyRange.lowerBound([o.userId,a]),s=null;return Uo(t).iterate({index:Ea.userMutationsIndex,range:r},function(r,t,e){t.userId===o.userId&&(dn(t.batchId>=a,"Should have found mutation after "+a),s=o.serializer.fromDbMutationBatch(t)),e.done()}).next(function(){return s})})},o.prototype.getAllMutationBatches=function(o){var r=this,e=IDBKeyRange.bound([this.userId,-1],[this.userId,nd]);return Uo(o).loadAll(Ea.userMutationsIndex,e).next(function(e){return e.map(function(e){return r.serializer.fromDbMutationBatch(e)})})},o.prototype.getAllMutationBatchesAffectingDocumentKey=function(d,s){var l=this,o=Sa.prefixForPath(this.userId,s.path),t=IDBKeyRange.lowerBound(o),r=[];return Qo(d).iterate({range:t},function(c,e,t){var n=c[0],p=c[1],i=c[2],o=Oo(p);return n===l.userId&&s.path.isEqual(o)?Uo(d).get(i).next(function(e){if(!e)throw rn("Dangling document-mutation reference found: "+c+" which points to "+i);dn(e.userId===l.userId,"Unexpected user '"+e.userId+"' for mutation batch "+i),r.push(l.serializer.fromDbMutationBatch(e))}):void t.done()}).next(function(){return r})},o.prototype.getAllMutationBatchesAffectingDocumentKeys=function(o,e){var d=this,l=new ui(Un),r=[];return e.forEach(function(c){var a=Sa.prefixForPath(d.userId,c.path),t=IDBKeyRange.lowerBound(a),e=Qo(o).iterate({range:t},function(s,t,e){var n=s[0],r=s[1],i=s[2],o=Oo(r);n===d.userId&&c.path.isEqual(o)?l=l.add(i):e.done()});r.push(e)}),xo.waitFor(r).next(function(){return d.lookupMutationBatches(o,l)})},o.prototype.getAllMutationBatchesAffectingQuery=function(o,t){var d=this;dn(!t.isDocumentQuery(),"Document queries shouldn't go down this path"),dn(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var s=t.path,l=s.length+1,e=Sa.prefixForPath(this.userId,s),a=IDBKeyRange.lowerBound(e),c=new ui(Un);return Qo(o).iterate({range:a},function(p,t,e){var n=p[0],r=p[1],i=p[2],o=Oo(r);n===d.userId&&s.isPrefixOf(o)?o.length===l&&(c=c.add(i)):e.done()}).next(function(){return d.lookupMutationBatches(o,c)})},o.prototype.lookupMutationBatches=function(o,t){var a=this,n=[],r=[];return t.forEach(function(i){r.push(Uo(o).get(i).next(function(e){if(null===e)throw rn("Dangling document-mutation reference found, which points to "+i);dn(e.userId===a.userId,"Unexpected user '"+e.userId+"' for mutation batch "+i),n.push(a.serializer.fromDbMutationBatch(e))}))}),xo.waitFor(r).next(function(){return n})},o.prototype.removeMutationBatch=function(o,e){var a=this;return Vo(o.simpleDbTransaction,this.userId,e).next(function(r){return a.removeCachedMutationKeys(e.batchId),xo.forEach(r,function(e){return a.referenceDelegate.removeMutationReference(o,e)})})},o.prototype.removeCachedMutationKeys=function(e){delete this.documentKeysByBatchId[e]},o.prototype.performConsistencyCheck=function(r){var a=this;return this.checkEmpty(r).next(function(o){if(!o)return xo.resolve();var t=IDBKeyRange.lowerBound(Sa.prefixForUser(a.userId)),e=[];return Qo(r).iterate({range:t},function(o,t,i){if(o[0]===a.userId){var n=Oo(o[1]);e.push(n)}else i.done()}).next(function(){dn(0===e.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+e.map(function(e){return e.canonicalString()}))})})},o.prototype.containsKey=function(o,t){return Po(o,this.userId,t)},o.prototype.getMutationQueueMetadata=function(o){var r=this;return Ko(o).get(this.userId).next(function(e){return e||new wa(r.userId,-1,"")})},o}(),Fo,jd;(jd=Fo||(Fo={}))[jd.QueryCache=0]="QueryCache",jd[jd.SyncEngine=1]="SyncEngine";var Hd=function(){function e(o,t){dn((1&(this.generatorId=o))===o,"Generator ID "+o+" contains more than 1 reserved bits"),this.seek(void 0===t?this.generatorId:t)}return e.prototype.next=function(){var e=this.nextId;return this.nextId+=2,e},e.prototype.after=function(e){return this.seek(e+2),this.next()},e.prototype.seek=function(e){dn((1&e)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=e},e.forQueryCache=function(){return new e(Fo.QueryCache,2)},e.forSyncEngine=function(){return new e(Fo.SyncEngine)},e}(),zo=function(){function r(e){this.db=e}return r.openOrCreate=function(s,e,o){return dn(r.isAvailable(),"IndexedDB not supported in current environment."),Ro("SimpleDb","Opening database:",s),new xo(function(a,n){var d=window.indexedDB.open(s,e);d.onsuccess=function(o){var t=o.target.result;a(new r(t))},d.onblocked=function(){n(new En(bn.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},d.onerror=function(o){var t=o.target.error;"VersionError"===t.name?n(new En(bn.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):n(t)},d.onupgradeneeded=function(r){Ro("SimpleDb","Database \""+s+"\" requires upgrade from version:",r.oldVersion);var t=r.target.result,e=new Xo(d.transaction);o.createOrUpgrade(t,e,r.oldVersion,ya).next(function(){Ro("SimpleDb","Database upgrade to version "+ya+" complete")})}}).toPromise()},r.delete=function(e){return Ro("SimpleDb","Removing database:",e),jo(window.indexedDB.deleteDatabase(e)).toPromise()},r.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var e=window.navigator.userAgent;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/"))},r.getStore=function(o,t){return o.store(t)},r.prototype.runTransaction=function(o,t,e){var a=Xo.open(this.db,o,t),r=e(a).catch(function(e){return a.abort(e),xo.reject(e)}).toPromise();return r.catch(function(){}),a.completionPromise.then(function(){return r})},r.prototype.close=function(){this.db.close()},r}(),Yo=function(){function e(e){this.dbCursor=e,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(e.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cursor",{set:function(e){this.dbCursor=e},enumerable:!0,configurable:!0}),e.prototype.done=function(){this.shouldStop=!0},e.prototype.skip=function(e){this.nextKey=e},e.prototype.delete=function(){return jo(this.dbCursor.delete())},e}(),Xo=function(){function o(o){var r=this;this.transaction=o,this.aborted=!1,this.completionDeferred=new To,this.transaction.oncomplete=function(){r.completionDeferred.resolve()},this.transaction.onabort=function(){o.error?r.completionDeferred.reject(o.error):r.completionDeferred.resolve()},this.transaction.onerror=function(e){r.completionDeferred.reject(e.target.error)}}return o.open=function(r,t,e){return new o(r.transaction(e,t))},Object.defineProperty(o.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),o.prototype.abort=function(e){e&&this.completionDeferred.reject(e),this.aborted||(Ro("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},o.prototype.store=function(o){var t=this.transaction.objectStore(o);return dn(!!t,"Object store not part of transaction: "+o),new Jo(t)},o}(),Jo=function(){function e(e){this.store=e}return e.prototype.put=function(o,t){return jo(void 0===t?(Ro("SimpleDb","PUT",this.store.name,"<auto-key>",o),this.store.put(o)):(Ro("SimpleDb","PUT",this.store.name,o,t),this.store.put(t,o)))},e.prototype.add=function(e){return Ro("SimpleDb","ADD",this.store.name,e,e),jo(this.store.add(e))},e.prototype.get=function(o){var e=this;return jo(this.store.get(o)).next(function(r){return void 0===r&&(r=null),Ro("SimpleDb","GET",e.store.name,o,r),r})},e.prototype.delete=function(e){return Ro("SimpleDb","DELETE",this.store.name,e),jo(this.store.delete(e))},e.prototype.count=function(){return Ro("SimpleDb","COUNT",this.store.name),jo(this.store.count())},e.prototype.loadAll=function(o,t){var e=this.cursor(this.options(o,t)),a=[];return this.iterateCursor(e,function(o,t){a.push(t)}).next(function(){return a})},e.prototype.deleteAll=function(o,t){Ro("SimpleDb","DELETE ALL",this.store.name);var e=this.options(o,t);e.keysOnly=!1;var a=this.cursor(e);return this.iterateCursor(a,function(o,t,e){return e.delete()})},e.prototype.iterate=function(o,t){var a;t?a=o:(a={},t=o);var i=this.cursor(a);return this.iterateCursor(i,t)},e.prototype.iterateSerial=function(o){var r=this.cursor({});return new xo(function(a,n){r.onerror=function(e){n(e.target.error)},r.onsuccess=function(r){var n=r.target.result;n?o(n.primaryKey,n.value).next(function(e){e?n.continue():a()}):a()}})},e.prototype.iterateCursor=function(r,t){var e=[];return new xo(function(a,o){r.onerror=function(e){o(e.target.error)},r.onsuccess=function(o){var s=o.target.result;if(s){var d=new Yo(s),n=t(s.primaryKey,s.value,d);if(n instanceof xo){var r=n.catch(function(e){return d.done(),xo.reject(e)});e.push(r)}d.isDone?a():null===d.skipToKey?s.continue():s.continue(d.skipToKey)}else a()}}).next(function(){return xo.waitFor(e)})},e.prototype.options=function(o,t){var r;return void 0!==o&&("string"==typeof o?r=o:(dn(void 0===t,"3rd argument must not be defined if 2nd is a range."),t=o)),{index:r,range:t}},e.prototype.cursor=function(o){var t="next";if(o.reverse&&(t="prev"),o.index){var r=this.store.index(o.index);return o.keysOnly?r.openKeyCursor(o.range,t):r.openCursor(o.range,t)}return this.store.openCursor(o.range,t)},e}(),$o=function(){function e(o,t){this.referenceDelegate=o,this.serializer=t,this.targetIdGenerator=Hd.forQueryCache()}return e.prototype.allocateTargetId=function(o){var e=this;return this.retrieveMetadata(o).next(function(r){return r.highestTargetId=e.targetIdGenerator.after(r.highestTargetId),e.saveMetadata(o,r).next(function(){return r.highestTargetId})})},e.prototype.getLastRemoteSnapshotVersion=function(e){return this.retrieveMetadata(e).next(function(e){return ii.fromTimestamp(new or(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))})},e.prototype.getHighestSequenceNumber=function(e){return na(e.simpleDbTransaction)},e.prototype.setTargetsMetadata=function(o,e,a){var r=this;return this.retrieveMetadata(o).next(function(n){return n.highestListenSequenceNumber=e,a&&(n.lastRemoteSnapshotVersion=a.toTimestamp()),e>n.highestListenSequenceNumber&&(n.highestListenSequenceNumber=e),r.saveMetadata(o,n)})},e.prototype.addQueryData=function(o,e){var a=this;return this.saveQueryData(o,e).next(function(){return a.retrieveMetadata(o).next(function(r){return r.targetCount+=1,a.updateMetadataFromQueryData(e,r),a.saveMetadata(o,r)})})},e.prototype.updateQueryData=function(o,t){return this.saveQueryData(o,t)},e.prototype.removeQueryData=function(o,e){var r=this;return this.removeMatchingKeysForTargetId(o,e.targetId).next(function(){return Zo(o).delete(e.targetId)}).next(function(){return r.retrieveMetadata(o)}).next(function(e){return dn(0<e.targetCount,"Removing from an empty query cache"),e.targetCount-=1,r.saveMetadata(o,e)})},e.prototype.removeTargets=function(d,r,i){var o=this,a=0,l=[];return Zo(d).iterate(function(s,t){var e=o.serializer.fromDbTarget(t);e.sequenceNumber<=r&&void 0===i[e.targetId]&&(a++,l.push(o.removeQueryData(d,e)))}).next(function(){return xo.waitFor(l)}).next(function(){return a})},e.prototype.forEachTarget=function(e,o){var r=this;return Zo(e).iterate(function(a,t){var e=r.serializer.fromDbTarget(t);o(e)})},e.prototype.retrieveMetadata=function(e){return ea(e.simpleDbTransaction)},e.prototype.saveMetadata=function(o,t){return(e=o,Ha.getStore(e,ka.store)).put(ka.key,t);var e},e.prototype.saveQueryData=function(o,t){return Zo(o).put(this.serializer.toDbTarget(t))},e.prototype.updateMetadataFromQueryData=function(o,t){var e=!1;return o.targetId>t.highestTargetId&&(t.highestTargetId=o.targetId,e=!0),o.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=o.sequenceNumber,e=!0),e},e.prototype.getQueryCount=function(e){return this.retrieveMetadata(e).next(function(e){return e.targetCount})},e.prototype.getQueryData=function(r,s){var i=this,t=s.canonicalId(),e=IDBKeyRange.bound([t,id],[t,nd]),o=null;return Zo(r).iterate({range:e,index:Na.queryTargetsIndexName},function(a,t,e){var n=i.serializer.fromDbTarget(t);s.isEqual(n.query)&&(o=n,e.done())}).next(function(){return o})},e.prototype.addMatchingKeys=function(s,e,n){var r=this,i=[],o=ra(s);return e.forEach(function(a){var t=po(a.path);i.push(o.put(new Aa(n,t))),i.push(r.referenceDelegate.addReference(s,a))}),xo.waitFor(i)},e.prototype.removeMatchingKeys=function(a,e,n){var r=this,i=ra(a);return xo.forEach(e,function(o){var t=po(o.path);return xo.waitFor([i.delete([n,t]),r.referenceDelegate.removeReference(a,o)])})},e.prototype.removeMatchingKeysForTargetId=function(o,t){var e=ra(o),a=IDBKeyRange.bound([t],[t+1],!1,!0);return e.delete(a)},e.prototype.getMatchingKeysForTargetId=function(a,t){var e=IDBKeyRange.bound([t],[t+1],!1,!0),n=ra(a),s=Ai();return n.iterate({range:e,keysOnly:!0},function(e){var t=Oo(e[1]),o=new dr(t);s=s.add(o)}).next(function(){return s})},e.prototype.containsKey=function(o,t){var e=po(t.path),a=IDBKeyRange.bound([e],[Kn(e)],!1,!0),s=0;return ra(o).iterate({index:Aa.documentTargetsIndex,keysOnly:!0,range:a},function(o,t,e){var a=o[0];o[1],0!==a&&(s++,e.done())}).next(function(){return 0<s})},e.prototype.getQueryDataForTarget=function(o,t){var e=this;return Zo(o).get(t).next(function(o){return o?e.serializer.fromDbTarget(o):null})},e}(),ta=function(){function e(e){this.mapKeyFn=e,this.inner={}}return e.prototype.get=function(d){var t=this.mapKeyFn(d),e=this.inner[t];if(void 0!==e)for(var n=0,l=e;n<l.length;n++){var i=l[n],o=i[0],a=i[1];if(o.isEqual(d))return a}},e.prototype.has=function(e){return void 0!==this.get(e)},e.prototype.set=function(o,t){var e=this.mapKeyFn(o),a=this.inner[e];if(void 0!==a){for(var r=0;r<a.length;r++)if(a[r][0].isEqual(o))return void(a[r]=[o,t]);a.push([o,t])}else this.inner[e]=[[o,t]]},e.prototype.delete=function(o){var t=this.mapKeyFn(o),e=this.inner[t];if(void 0===e)return!1;for(var a=0;a<e.length;a++)if(e[a][0].isEqual(o))return 1===e.length?delete this.inner[t]:e.splice(a,1),!0;return!1},e.prototype.forEach=function(e){Tn(this.inner,function(s,t){for(var d=0,l=t;d<l.length;d++){var r=l[d],i=r[0],o=r[1];e(i,o)}})},e.prototype.isEmpty=function(){return In(this.inner)},e}(),oa=function(){function e(){this.changes=Xn(),this.documentSizes=new ta(function(e){return e.toString()})}return e.prototype.addEntry=function(o){var t=this.assertChanges();this.changes=t.insert(o.key,o)},e.prototype.getEntry=function(o,a){var e=this,t=this.assertChanges().get(a);return t?xo.resolve(t):this.getFromCache(o,a).next(function(o){return null===o?(e.documentSizes.set(a,0),null):(e.documentSizes.set(a,o.size),o.maybeDocument)})},e.prototype.getEntries=function(o,t){var r=this;return this.getAllFromCache(o,t).next(function(o){var t=o.maybeDocuments;return o.sizeMap.forEach(function(o,t){r.documentSizes.set(o,t)}),t})},e.prototype.apply=function(o){var t=this.applyChanges(o);return this.changes=null,t},e.prototype.assertChanges=function(){return dn(null!==this.changes,"Changes have already been applied."),this.changes},e}(),aa="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",sa=function(){function e(o,t,e){this.serializer=o,this.indexManager=t,this.keepDocumentChangeLog=e,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(e.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),e.prototype.start=function(o){var t=zo.getStore(o,Ma.store);return this.synchronizeLastDocumentChangeId(t)},e.prototype.addEntries=function(d,t,e){var n=[];if(0<t.length){for(var r=ca(d),i=Ai(),l=0,p=t;l<p.length;l++){var s=p[l],u=s.key,c=s.doc;n.push(r.put(fa(u),c)),i=i.add(u),n.push(this.indexManager.addToCollectionParentIndex(d,u.path.popLast()))}this.keepDocumentChangeLog&&n.push(la(d).put({changes:this.serializer.toDbResourcePaths(i)})),n.push(this.updateSize(d,e))}return xo.waitFor(n)},e.prototype.removeEntry=function(o,t){var e=ca(o),a=fa(t);return e.get(a).next(function(o){return o?e.delete(a).next(function(){return pa(o)}):xo.resolve(0)})},e.prototype.getEntry=function(o,t){var e=this;return ca(o).get(fa(t)).next(function(o){return o?e.serializer.fromDbRemoteDocument(o):null})},e.prototype.getSizedEntry=function(o,t){var e=this;return ca(o).get(fa(t)).next(function(o){return o?{maybeDocument:e.serializer.fromDbRemoteDocument(o),size:pa(o)}:null})},e.prototype.getEntries=function(o,t){var a=this,n=Jn();return this.forEachDbEntry(o,t,function(o,t){n=t?n.insert(o,a.serializer.fromDbRemoteDocument(t)):n.insert(o,null)}).next(function(){return n})},e.prototype.getSizedEntries=function(o,t){var a=this,n=Jn(),s=new br(dr.comparator);return this.forEachDbEntry(o,t,function(o,t){s=t?(n=n.insert(o,a.serializer.fromDbRemoteDocument(t)),s.insert(o,pa(t))):(n=n.insert(o,null),s.insert(o,0))}).next(function(){return{maybeDocuments:n,sizeMap:s}})},e.prototype.forEachDbEntry=function(r,t,s){if(t.isEmpty())return xo.resolve();var e=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),i=t.getIterator(),o=i.getNext();return ca(r).iterate({range:e},function(a,t,e){for(var n=dr.fromSegments(a);o&&0>dr.comparator(o,n);)s(o,null),o=i.getNext();o&&o.isEqual(n)&&(s(o,t),o=i.hasNext()?i.getNext():null),o?e.skip(o.path.toArray()):e.done()}).next(function(){for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})},e.prototype.getDocumentsMatchingQuery=function(r,t){var i=this;dn(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var o=$n(),d=t.path.length+1,s=t.path.toArray(),e=IDBKeyRange.lowerBound(s);return ca(r).iterate({range:e},function(a,s,e){if(a.length===d){var n=i.serializer.fromDbRemoteDocument(s);t.path.isPrefixOf(n.key.path)?n instanceof yr&&t.matches(n)&&(o=o.insert(n.key,n)):e.done()}}).next(function(){return o})},e.prototype.getNewDocumentChanges=function(s){var d=this;dn(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var r=Ai(),l=Xn(),e=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),c=!0,p=la(s);return p.iterate({range:e},function(o,t){return c&&(c=!1,d._lastProcessedDocumentChangeId+1!==t.id)?d.synchronizeLastDocumentChangeId(p).next(function(){return xo.reject(new En(bn.DATA_LOSS,aa))}):void(r=r.unionWith(d.serializer.fromDbResourcePaths(t.changes)),d._lastProcessedDocumentChangeId=t.id)}).next(function(){var e=[];return r.forEach(function(o){e.push(d.getEntry(s,o).next(function(r){var t=r||new gr(o,ii.forDeletedDoc());l=l.insert(o,t)}))}),xo.waitFor(e)}).next(function(){return l})},e.prototype.removeDocumentChangesThroughChangeId=function(o,t){var e=IDBKeyRange.upperBound(t);return la(o).delete(e)},e.prototype.synchronizeLastDocumentChangeId=function(e){var o=this;return this._lastProcessedDocumentChangeId=0,e.iterate({keysOnly:!0,reverse:!0},function(r,t,e){o._lastProcessedDocumentChangeId=r,e.done()})},e.prototype.newChangeBuffer=function(){return new ua(this)},e.prototype.getSize=function(e){return this.getMetadata(e).next(function(e){return e.byteSize})},e.prototype.getMetadata=function(e){return ia(e).get(Da.key).next(function(e){return dn(!!e,"Missing document cache metadata"),e})},e.prototype.setMetadata=function(o,t){return ia(o).put(Da.key,t)},e.prototype.updateSize=function(o,e){var a=this;return this.getMetadata(o).next(function(r){return r.byteSize+=e,a.setMetadata(o,r)})},e}(),ua=function(o){function e(r){var t=o.call(this)||this;return t.documentCache=r,t}return Ao(e,o),e.prototype.applyChanges=function(r){var d=this,t=this.assertChanges(),o=0,l=[];return t.forEach(function(a,t){var e=d.documentCache.serializer.toDbRemoteDocument(t),n=d.documentSizes.get(a);dn(void 0!==n,"Attempting to change document "+a.toString()+" without having read it first");var r=pa(e);o+=r-n,l.push({key:a,doc:e})}),this.documentCache.addEntries(r,l,o)},e.prototype.getFromCache=function(o,t){return this.documentCache.getSizedEntry(o,t)},e.prototype.getAllFromCache=function(o,t){return this.documentCache.getSizedEntries(o,t)},e}(oa),ha=function(){function e(){this.collectionParentIndex=new ma}return e.prototype.addToCollectionParentIndex=function(o,t){return this.collectionParentIndex.add(t),xo.resolve()},e.prototype.getCollectionParents=function(o,t){return xo.resolve(this.collectionParentIndex.getEntries(t))},e}(),ma=function(){function e(){this.index={}}return e.prototype.add=function(o){dn(1==o.length%2,"Expected a collection path.");var t=o.lastSegment(),e=o.popLast(),a=this.index[t]||new ui(lr.comparator),r=!a.has(e);return this.index[t]=a.add(e),r},e.prototype.getEntries=function(e){return(this.index[e]||new ui(lr.comparator)).toArray()},e}(),ya=8,ga=function(){function e(e){this.serializer=e}return e.prototype.createOrUpgrade=function(d,l,t,e){var r=this,o;dn(t<e&&0<=t&&e<=ya,"Unexpected schema upgrade from v"+t+" to v{toVersion}."),1>t&&1<=e&&(d.createObjectStore(ba.store),(o=d).createObjectStore(wa.store,{keyPath:wa.keyPath}),o.createObjectStore(Ea.store,{keyPath:Ea.keyPath,autoIncrement:!0}).createIndex(Ea.userMutationsIndex,Ea.userMutationsKeyPath,{unique:!0}),o.createObjectStore(Sa.store),da(d),d.createObjectStore(Ca.store));var n=xo.resolve(),c;return 3>t&&3<=e&&(0!==t&&((c=d).deleteObjectStore(Aa.store),c.deleteObjectStore(Na.store),c.deleteObjectStore(ka.store),da(d)),n=n.next(function(){return o=l.store(ka.store),r=new ka(0,0,ii.MIN.toTimestamp(),0),o.put(ka.key,r);var o,r})),4>t&&4<=e&&(0!==t&&(n=n.next(function(){return a=d,(s=l).store(Ea.store).loadAll().next(function(o){a.deleteObjectStore(Ea.store);var t=a.createObjectStore(Ea.store,{keyPath:Ea.keyPath,autoIncrement:!0});t.createIndex(Ea.userMutationsIndex,Ea.userMutationsKeyPath,{unique:!0});var e=s.store(Ea.store),n=o.map(function(o){return e.put(o)});return xo.waitFor(n)});var a,s})),n=n.next(function(){d.createObjectStore(Oa.store,{keyPath:Oa.keyPath}),d.createObjectStore(Ma.store,{keyPath:"id",autoIncrement:!0})})),5>t&&5<=e&&(n=n.next(function(){return r.removeAcknowledgedMutations(l)})),6>t&&6<=e&&(n=n.next(function(){return d.createObjectStore(Da.store),r.addDocumentGlobal(l)})),7>t&&7<=e&&(n=n.next(function(){return r.ensureSequenceNumbers(l)})),8>t&&8<=e&&(n=n.next(function(){return r.createCollectionParentIndex(d,l)})),n},e.prototype.addDocumentGlobal=function(o){var r=0;return o.store(Ca.store).iterate(function(o,t){r+=pa(t)}).next(function(){var e=new Da(r);return o.store(Da.store).put(Da.key,e)})},e.prototype.removeAcknowledgedMutations=function(o){var r=this,a=o.store(wa.store),i=o.store(Ea.store);return a.loadAll().next(function(e){return xo.forEach(e,function(a){var e=IDBKeyRange.bound([a.userId,-1],[a.userId,a.lastAcknowledgedBatchId]);return i.loadAll(Ea.userMutationsIndex,e).next(function(e){return xo.forEach(e,function(n){dn(n.userId===a.userId,"Cannot process batch "+n.batchId+" from unexpected user");var t=r.serializer.fromDbMutationBatch(n);return Vo(o,a.userId,t).next(function(){})})})})})},e.prototype.ensureSequenceNumbers=function(o){var s=o.store(Aa.store),t=o.store(Ca.store);return na(o).next(function(r){var e=[];return t.iterate(function(o){var a=new lr(o),t=[0,po(a)];e.push(s.get(t).next(function(o){return o?xo.resolve():(t=a,s.put(new Aa(0,po(t),r)));var t}))}).next(function(){return xo.waitFor(e)})})},e.prototype.createCollectionParentIndex=function(a,t){a.createObjectStore(Ra.store,{keyPath:Ra.keyPath});var s=t.store(Ra.store),r=new ma,e=function(o){if(r.add(o)){var t=o.lastSegment(),e=o.popLast();return s.put({collectionId:t,parent:po(e)})}};return t.store(Ca.store).iterate({keysOnly:!0},function(o){var t=new lr(o);return e(t.popLast())}).next(function(){return t.store(Sa.store).iterate({keysOnly:!0},function(o){o[0];var t=o[1],a=(o[2],Oo(t));return e(a.popLast())})})},e}(),va=function(o,t){this.seconds=o,this.nanoseconds=t},ba=function(){function e(o,t,e){this.ownerId=o,this.allowTabSynchronization=t,this.leaseTimestampMs=e}return e.store="owner",e.key="owner",e}(),wa=function(){function e(o,t,e){this.userId=o,this.lastAcknowledgedBatchId=t,this.lastStreamToken=e}return e.store="mutationQueues",e.keyPath="userId",e}(),Ea=function(){function e(o,t,e,a,r){this.userId=o,this.batchId=t,this.localWriteTimeMs=e,this.baseMutations=a,this.mutations=r}return e.store="mutations",e.keyPath="batchId",e.userMutationsIndex="userMutationsIndex",e.userMutationsKeyPath=["userId","batchId"],e}(),Sa=function(){function e(){}return e.prefixForUser=function(e){return[e]},e.prefixForPath=function(o,t){return[o,po(t)]},e.key=function(o,t,e){return[o,po(t),e]},e.store="documentMutations",e.PLACEHOLDER=new e,e}(),Ta=function(o,t){this.path=o,this.readTime=t},Ia=function(o,t){this.path=o,this.version=t},Ca=function(){function e(o,t,e,a){this.unknownDocument=o,this.noDocument=t,this.document=e,this.hasCommittedMutations=a}return e.store="remoteDocuments",e}(),Da=function(){function e(e){this.byteSize=e}return e.store="remoteDocumentGlobal",e.key="remoteDocumentGlobalKey",e}(),Na=function(){function e(a,t,e,n,r,i){this.targetId=a,this.canonicalId=t,this.readTime=e,this.resumeToken=n,this.lastListenSequenceNumber=r,this.query=i}return e.store="targets",e.keyPath="targetId",e.queryTargetsIndexName="queryTargetsIndex",e.queryTargetsKeyPath=["canonicalId","targetId"],e}(),Aa=function(){function e(o,t,e){this.targetId=o,this.path=t,dn(0===o==(void 0!==(this.sequenceNumber=e)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return e.store="targetDocuments",e.keyPath=["targetId","path"],e.documentTargetsIndex="documentTargetsIndex",e.documentTargetsKeyPath=["path","targetId"],e}(),ka=function(){function e(o,t,e,a){this.highestTargetId=o,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=e,this.targetCount=a}return e.key="targetGlobalKey",e.store="targetGlobal",e}(),Ra=function(){function e(o,t){this.collectionId=o,this.parent=t}return e.store="collectionParents",e.keyPath=["collectionId","parent"],e}(),Ma=function(){function e(e){this.changes=e}return e.store="remoteDocumentChanges",e.keyPath="id",e}(),Oa=function(){function e(o,t,e,a,r){this.clientId=o,this.updateTimeMs=t,this.networkEnabled=e,this.inForeground=a,this.lastProcessedDocumentChangeId=r}return e.store="clientMetadata",e.keyPath="clientId",e}(),Pa=[wa.store,Ea.store,Sa.store,Ca.store,Na.store,ba.store,ka.store,Aa.store].concat([Oa.store,Ma.store]).concat([Da.store]).concat([Ra.store]),La=function(){function e(){this.collectionParentsCache=new ma}return e.prototype.addToCollectionParentIndex=function(o,t){if(dn(1==t.length%2,"Expected a collection path."),this.collectionParentsCache.add(t)){dn(1<=t.length,"Invalid collection path.");var e=t.lastSegment(),a=t.popLast();return _a(o).put({collectionId:e,parent:po(a)})}return xo.resolve()},e.prototype.getCollectionParents=function(r,a){var i=[],t=IDBKeyRange.bound([a,""],[Kn(a),""],!1,!0);return _a(r).loadAll(t).next(function(o){for(var t=0,s=o,n;t<s.length&&(n=s[t],n.collectionId===a);t++)i.push(Oo(n.parent));return i})},e}(),xa=function(){function e(e){this.remoteSerializer=e}return e.prototype.fromDbRemoteDocument=function(o){if(o.document)return this.remoteSerializer.fromDocument(o.document,!!o.hasCommittedMutations);if(o.noDocument){var t=dr.fromSegments(o.noDocument.path),r=this.fromDbTimestamp(o.noDocument.readTime);return new gr(t,r,{hasCommittedMutations:!!o.hasCommittedMutations})}return o.unknownDocument?(t=dr.fromSegments(o.unknownDocument.path),r=this.fromDbTimestamp(o.unknownDocument.version),new vr(t,r)):rn("Unexpected DbRemoteDocument")},e.prototype.toDbRemoteDocument=function(o){if(o instanceof yr){var t=o.proto?o.proto:this.remoteSerializer.toDocument(o),e=o.hasCommittedMutations;return new Ca(null,null,t,e)}if(o instanceof gr){var a=o.key.path.toArray(),s=this.toDbTimestamp(o.version);return e=o.hasCommittedMutations,new Ca(null,new Ta(a,s),null,e)}return o instanceof vr?(a=o.key.path.toArray(),s=this.toDbTimestamp(o.version),new Ca(new Ia(a,s),null,null,!0)):rn("Unexpected MaybeDocumment")},e.prototype.toDbTimestamp=function(o){var t=o.toTimestamp();return new va(t.seconds,t.nanoseconds)},e.prototype.fromDbTimestamp=function(o){var t=new or(o.seconds,o.nanoseconds);return ii.fromTimestamp(t)},e.prototype.toDbMutationBatch=function(o,t){var e=this,a=t.baseMutations.map(function(o){return e.remoteSerializer.toMutation(o)}),r=t.mutations.map(function(o){return e.remoteSerializer.toMutation(o)});return new Ea(o,t.batchId,t.localWriteTime.toMillis(),a,r)},e.prototype.fromDbMutationBatch=function(o){var a=this,e=(o.baseMutations||[]).map(function(e){return a.remoteSerializer.fromMutation(e)}),t=o.mutations.map(function(e){return a.remoteSerializer.fromMutation(e)}),r=or.fromMillis(o.localWriteTimeMs);return new Do(o.batchId,r,e,t)},e.prototype.toDbResourcePaths=function(o){var r=[];return o.forEach(function(e){r.push(po(e.path))}),r},e.prototype.fromDbResourcePaths=function(o){for(var t=Ai(),a=0,s=o,r;a<s.length;a++)r=s[a],t=t.add(new dr(Oo(r)));return t},e.prototype.fromDbTarget=function(o){var t=this.fromDbTimestamp(o.readTime),r;return r=void 0===o.query.documents?this.remoteSerializer.fromQueryTarget(o.query):this.remoteSerializer.fromDocumentsTarget(o.query),new _d(r,o.targetId,oi.Listen,o.lastListenSequenceNumber,t,o.resumeToken)},e.prototype.toDbTarget=function(o){dn(oi.Listen===o.purpose,"Only queries with purpose "+oi.Listen+" may be stored, got "+o.purpose);var t=this.toDbTimestamp(o.snapshotVersion),r,a;return r=o.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(o.query):this.remoteSerializer.toQueryTarget(o.query),a=o.resumeToken instanceof Uint8Array?(dn("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),o.resumeToken.toString()):o.resumeToken,new Na(o.targetId,o.query.canonicalId(),t,a,o.sequenceNumber,r)},e}(),Fa=function(){function e(e){this.maxElements=e,this.buffer=new ui(qa),this.previousIndex=0}return e.prototype.nextIndex=function(){return++this.previousIndex},e.prototype.addElement=function(o){var t=[o,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(t);else{var e=this.buffer.last();0>qa(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}},Object.defineProperty(e.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),e}(),Ba={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Ua=function(){function o(o,t,e){this.cacheSizeCollectionThreshold=o,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=e}return o.withCacheSize=function(e){return new o(e,o.DEFAULT_COLLECTION_PERCENTILE,o.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},o.COLLECTION_DISABLED=-1,o.MINIMUM_CACHE_SIZE_BYTES=1048576,o.DEFAULT=new o(o.DEFAULT_CACHE_SIZE_BYTES=41943040,o.DEFAULT_COLLECTION_PERCENTILE=10,o.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),o.DISABLED=new o(o.COLLECTION_DISABLED,0,0),o}(),Qa=function(){function e(o,t,e){this.garbageCollector=o,this.asyncQueue=t,this.localStore=e,this.gcTask=null}return e.prototype.start=function(){dn(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==Ua.COLLECTION_DISABLED&&this.scheduleGC()},e.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(e.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),e.prototype.scheduleGC=function(){var o=this;dn(null===this.gcTask,"Cannot schedule GC while a task is pending");var t=this.hasRun?3e5:6e4;Ro("LruGarbageCollector","Garbage collection scheduled in "+t+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Io.LruGarbageCollection,t,function(){return o.gcTask=null,o.hasRun=!0,o.localStore.collectGarbage(o.garbageCollector).then(function(){return o.scheduleGC()}).catch(Va)})},e}(),Ka=function(){function e(o,t){this.delegate=o,this.params=t}return e.prototype.calculateTargetCount=function(o,r){return this.delegate.getSequenceNumberCount(o).next(function(e){return dd(r/100*e)})},e.prototype.nthSequenceNumber=function(o,t){var e=this;if(0===t)return xo.resolve(Wd.INVALID);var a=new Fa(t);return this.delegate.forEachTarget(o,function(e){return a.addElement(e.sequenceNumber)}).next(function(){return e.delegate.forEachOrphanedDocumentSequenceNumber(o,function(e){return a.addElement(e)})}).next(function(){return a.maxValue})},e.prototype.removeTargets=function(o,t,e){return this.delegate.removeTargets(o,t,e)},e.prototype.removeOrphanedDocuments=function(o,t){return this.delegate.removeOrphanedDocuments(o,t)},e.prototype.collect=function(o,e){var a=this;return this.params.cacheSizeCollectionThreshold===Ua.COLLECTION_DISABLED?(Ro("LruGarbageCollector","Garbage collection skipped; disabled"),xo.resolve(Ba)):this.getCacheSize(o).next(function(r){return r<a.params.cacheSizeCollectionThreshold?(Ro("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+a.params.cacheSizeCollectionThreshold),Ba):a.runGarbageCollection(o,e)})},e.prototype.getCacheSize=function(e){return this.delegate.getCacheSize(e)},e.prototype.runGarbageCollection=function(d,e){var n=this,l,p,m,y,g,f,b,E;return y=Date.now(),this.calculateTargetCount(d,this.params.percentileToCollect).next(function(e){return p=e>n.params.maximumSequenceNumbersToCollect?(Ro("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+n.params.maximumSequenceNumbersToCollect+" from "+e),n.params.maximumSequenceNumbersToCollect):e,g=Date.now(),n.nthSequenceNumber(d,p)}).next(function(o){return l=o,f=Date.now(),n.removeTargets(d,l,e)}).next(function(e){return m=e,b=Date.now(),n.removeOrphanedDocuments(d,l)}).next(function(e){return(E=Date.now(),Ye()<=ln.DEBUG)&&Ro("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(g-y)+"ms\n\tDetermined least recently used "+p+" in "+(f-g)+"ms\n\tRemoved "+m+" targets in "+(b-f)+"ms\n\tRemoved "+e+" documents in "+(E-b)+"ms\nTotal Duration: "+(E-y)+"ms"),xo.resolve({didRun:!0,sequenceNumbersCollected:p,targetsRemoved:m,documentsRemoved:e})})},e}(),ja="IndexedDbPersistence",Wa="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.",za=function(o){function e(r,t){var e=o.call(this)||this;return e.simpleDbTransaction=r,e.currentSequenceNumber=t,e}return Ao(e,o),e}(function(){}),Ha=function(){function d(s,t,e,n,r,i,o){if(this.persistenceKey=s,this.clientId=t,this.queue=n,this.multiClientParams=o,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=id,this.primaryStateListener=function(){return Promise.resolve()},!d.isAvailable())throw new En(bn.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");if(this.referenceDelegate=new Ya(this,i),this.dbName=s+d.MAIN_DATABASE,this.serializer=new xa(r),this.document=e.document,this.allowTabSynchronization=void 0!==o,this.queryCache=new $o(this.referenceDelegate,this.serializer),this.indexManager=new La,this.remoteDocumentCache=new sa(this.serializer,this.indexManager,this.allowTabSynchronization),!e.window||!e.window.localStorage)throw new En(bn.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=e.window,this.webStorage=this.window.localStorage}return d.getStore=function(o,t){if(o instanceof za)return zo.getStore(o.simpleDbTransaction,t);throw rn("IndexedDbPersistence must use instances of IndexedDbTransaction")},d.createIndexedDbPersistence=function(l,n,r,i,o,a){return No(this,void 0,void 0,function(){var s;return ko(this,function(e){switch(e.label){case 0:return[4,(s=new d(l,n,r,i,o,a)).start()];case 1:return e.sent(),[2,s];}})})},d.createMultiClientIndexedDbPersistence=function(l,n,r,i,o,a,s){return No(this,void 0,void 0,function(){var c;return ko(this,function(e){switch(e.label){case 0:return[4,(c=new d(l,n,r,i,o,a,s)).start()];case 1:return e.sent(),[2,c];}})})},d.prototype.start=function(){var o=this;return dn(!this.started,"IndexedDbPersistence double-started!"),dn(null!==this.window,"Expected 'window' to be defined"),zo.openOrCreate(this.dbName,ya,new ga(this.serializer)).then(function(e){return o.simpleDb=e,o.updateClientMetadataAndTryBecomePrimary()}).then(function(){return o.attachVisibilityHandler(),o.attachWindowUnloadHook(),o.scheduleClientMetadataAndPrimaryLeaseRefreshes(),o.startRemoteDocumentCache()}).then(function(){return o.simpleDb.runTransaction("readonly",[ka.store],function(e){return na(e).next(function(r){var t=o.multiClientParams?o.multiClientParams.sequenceNumberSyncer:void 0;o.listenSequence=new Wd(r,t)})})}).then(function(){o._started=!0}).catch(function(e){return o.simpleDb&&o.simpleDb.close(),Promise.reject(e)})},d.prototype.startRemoteDocumentCache=function(){var o=this;return this.simpleDb.runTransaction("readonly",Pa,function(e){return o.remoteDocumentCache.start(e)})},d.prototype.setPrimaryStateListener=function(o){var r=this;return this.primaryStateListener=function(t){return No(r,void 0,void 0,function(){return ko(this,function(){return this.started?[2,o(t)]:[2]})})},o(this.isPrimary)},d.prototype.setNetworkEnabled=function(o){var t=this;this.networkEnabled!==o&&(this.networkEnabled=o,this.queue.enqueueAndForget(function(){return No(t,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2];}})})}))},d.prototype.updateClientMetadataAndTryBecomePrimary=function(){var o=this;return this.simpleDb.runTransaction("readwrite",Pa,function(r){return Ja(r).put(new Oa(o.clientId,Date.now(),o.networkEnabled,o.inForeground,o.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(o.isPrimary)return o.verifyPrimaryLease(r).next(function(e){e||(o.isPrimary=!1,o.queue.enqueueAndForget(function(){return o.primaryStateListener(!1)}))})}).next(function(){return o.canActAsPrimary(r)}).next(function(a){var t=o.isPrimary;return o.isPrimary=a,t!==o.isPrimary&&o.queue.enqueueAndForget(function(){return o.primaryStateListener(o.isPrimary)}),t&&!o.isPrimary?o.releasePrimaryLeaseIfHeld(r):o.isPrimary?o.acquireOrExtendPrimaryLease(r):void 0})})},d.prototype.verifyPrimaryLease=function(o){var r=this;return Xa(o).get(ba.key).next(function(e){return xo.resolve(r.isLocalClient(e))})},d.prototype.removeClientMetadata=function(e){return Ja(e).delete(this.clientId)},d.prototype.maybeGarbageCollectMultiClientState=function(){return No(this,void 0,void 0,function(){var a=this,o,n;return ko(this,function(e){switch(e.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),n=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(r){var i=d.getStore(r,Oa.store);return i.loadAll().next(function(e){o=a.filterActiveClients(e,18e5),n=e.filter(function(e){return-1===o.indexOf(e)})}).next(function(){return xo.forEach(n,function(e){return i.delete(e.clientId)})}).next(function(){if(0<(o=o.filter(function(e){return e.clientId!==a.clientId})).length){var n=o.map(function(e){return e.lastProcessedDocumentChangeId||0}),t=sd.apply(Math,n);return a.remoteDocumentCache.removeDocumentChangesThroughChangeId(r,t)}})})]);case 1:e.sent(),n.forEach(function(e){a.window.localStorage.removeItem(a.zombiedClientLocalStorageKey(e.clientId))}),e.label=2;case 2:return[2];}})})},d.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var e=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Io.ClientMetadataRefresh,4e3,function(){return e.updateClientMetadataAndTryBecomePrimary().then(function(){return e.maybeGarbageCollectMultiClientState()}).then(function(){return e.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},d.prototype.isLocalClient=function(e){return!!e&&e.ownerId===this.clientId},d.prototype.canActAsPrimary=function(o){var a=this;return Xa(o).get(ba.key).next(function(e){if(null!==e&&a.isWithinAge(e.leaseTimestampMs,5e3)&&!a.isClientZombied(e.ownerId)){if(a.isLocalClient(e)&&a.networkEnabled)return!0;if(!a.isLocalClient(e)){if(!e.allowTabSynchronization)throw new En(bn.FAILED_PRECONDITION,Wa);return!1}}return a.networkEnabled&&a.inForeground||Ja(o).loadAll().next(function(e){return void 0===a.filterActiveClients(e,5e3).find(function(o){if(a.clientId!==o.clientId){var t=!a.networkEnabled&&o.networkEnabled,e=!a.inForeground&&o.inForeground,n=a.networkEnabled===o.networkEnabled;if(t||e&&n)return!0}return!1})})}).next(function(e){return a.isPrimary!==e&&Ro(ja,"Client "+(e?"is":"is not")+" eligible for a primary lease."),e})},d.prototype.shutdown=function(o){return No(this,void 0,void 0,function(){var r=this;return ko(this,function(e){switch(e.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[ba.store,Oa.store],function(e){return r.releasePrimaryLeaseIfHeld(e).next(function(){return r.removeClientMetadata(e)})})];case 1:return e.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),o?[4,zo.delete(this.dbName)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2];}})})},d.prototype.filterActiveClients=function(o,r){var e=this;return o.filter(function(o){return e.isWithinAge(o.updateTimeMs,r)&&!e.isClientZombied(o.clientId)})},d.prototype.getActiveClients=function(){var o=this;return this.simpleDb.runTransaction("readonly",[Oa.store],function(e){return Ja(e).loadAll().next(function(e){return o.filterActiveClients(e,18e5).map(function(e){return e.clientId})})})},Object.defineProperty(d.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),d.prototype.getMutationQueue=function(e){return dn(this.started,"Cannot initialize MutationQueue before persistence is started."),qo.forUser(e,this.serializer,this.indexManager,this.referenceDelegate)},d.prototype.getQueryCache=function(){return dn(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},d.prototype.getRemoteDocumentCache=function(){return dn(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},d.prototype.getIndexManager=function(){return dn(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},d.prototype.runTransaction=function(o,a,n){var r=this;return Ro(ja,"Starting transaction:",o),this.simpleDb.runTransaction("readonly"===a?"readonly":"readwrite",Pa,function(i){return"readwrite-primary"===a?r.verifyPrimaryLease(i).next(function(e){if(!e)throw Ho("Failed to obtain primary lease for action '"+o+"'."),r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}),new En(bn.FAILED_PRECONDITION,"The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.");return n(new za(i,r.listenSequence.next()))}).next(function(e){return r.acquireOrExtendPrimaryLease(i).next(function(){return e})}):r.verifyAllowTabSynchronization(i).next(function(){return n(new za(i,r.listenSequence.next()))})})},d.prototype.verifyAllowTabSynchronization=function(o){var r=this;return Xa(o).get(ba.key).next(function(e){if(null!==e&&r.isWithinAge(e.leaseTimestampMs,5e3)&&!r.isClientZombied(e.ownerId)&&!r.isLocalClient(e)&&!e.allowTabSynchronization)throw new En(bn.FAILED_PRECONDITION,Wa)})},d.prototype.acquireOrExtendPrimaryLease=function(o){var t=new ba(this.clientId,this.allowTabSynchronization,Date.now());return Xa(o).put(ba.key,t)},d.isAvailable=function(){return zo.isAvailable()},d.buildStoragePrefix=function(o){var t=o.databaseId.projectId;return o.databaseId.isDefaultDatabase||(t+="."+o.databaseId.database),"firestore/"+o.persistenceKey+"/"+t+"/"},d.prototype.releasePrimaryLeaseIfHeld=function(o){var r=this,e=Xa(o);return e.get(ba.key).next(function(o){return r.isLocalClient(o)?(Ro(ja,"Releasing primary lease."),e.delete(ba.key)):xo.resolve()})},d.prototype.isWithinAge=function(o,t){var e=Date.now();return!(o<e-t)&&(!(e<o)||(Ho("Detected an update time that is in the future: "+o+" > "+e),!1))},d.prototype.attachVisibilityHandler=function(){var e=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){e.queue.enqueueAndForget(function(){return e.inForeground="visible"===e.document.visibilityState,e.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},d.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(dn(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},d.prototype.attachWindowUnloadHook=function(){var e=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){e.markClientZombied(),e.queue.enqueueAndForget(function(){return e.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},d.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(dn("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},d.prototype.isClientZombied=function(o){try{var t=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(o));return Ro(ja,"Client '"+o+"' "+(t?"is":"is not")+" zombied in LocalStorage"),t}catch(e){return Ho(ja,"Failed to get zombied client id.",e),!1}},d.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),Date.now()+"")}catch(e){Ho("Failed to set zombie client id.",e)}},d.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}},d.prototype.zombiedClientLocalStorageKey=function(e){return"firestore_zombie_"+this.persistenceKey+"_"+e},d.MAIN_DATABASE="main",d}(),Ya=function(){function e(o,t){this.db=o,this.garbageCollector=new Ka(this,t)}return e.prototype.getSequenceNumberCount=function(e){var t=this.orphanedDocmentCount(e);return this.db.getQueryCache().getQueryCount(e).next(function(o){return t.next(function(e){return o+e})})},e.prototype.orphanedDocmentCount=function(o){var t=0;return this.forEachOrphanedDocumentSequenceNumber(o,function(){t++}).next(function(){return t})},e.prototype.forEachTarget=function(o,t){return this.db.getQueryCache().forEachTarget(o,t)},e.prototype.forEachOrphanedDocumentSequenceNumber=function(e,o){return this.forEachOrphanedDocument(e,function(r,t){return o(t)})},e.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},e.prototype.addReference=function(o,t){return $a(o,t)},e.prototype.removeReference=function(o,t){return $a(o,t)},e.prototype.removeTargets=function(o,t,e){return this.db.getQueryCache().removeTargets(o,t,e)},e.prototype.removeMutationReference=function(o,t){return $a(o,t)},e.prototype.isPinned=function(o,t){return this.inMemoryPins.containsKey(t)?xo.resolve(!0):(a=t,s=!1,Ko(e=o).iterateSerial(function(o){return Po(e,o,a).next(function(e){return e&&(s=!0),xo.resolve(!e)})}).next(function(){return s}));var e,a,s},e.prototype.removeOrphanedDocuments=function(d,r){var i=this,o=0,e=0,t=[];return this.forEachOrphanedDocument(d,function(a,s){if(s<=r){var l=i.isPinned(d,a).next(function(r){if(!r)return o++,i.removeOrphanedDocument(d,a).next(function(o){e+=o})});t.push(l)}}).next(function(){return xo.waitFor(t)}).next(function(){return i.db.getRemoteDocumentCache().updateSize(d,-e)}).next(function(){return o})},e.prototype.removeOrphanedDocument=function(o,t){var e=0,a=this.db.getRemoteDocumentCache(),i;return xo.waitFor([ra(o).delete((i=t,[0,po(i.path)])),a.removeEntry(o,t).next(function(o){e+=o})]).next(function(){return e})},e.prototype.removeTarget=function(o,t){var e=t.copy({sequenceNumber:o.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(o,e)},e.prototype.updateLimboDocument=function(o,t){return $a(o,t)},e.prototype.forEachOrphanedDocument=function(r,d){var t=ra(r),o=Wd.INVALID,l;return t.iterate({index:Aa.documentTargetsIndex},function(a,t){var e=a[0],n=(a[1],t.path),r=t.sequenceNumber;0===e?(o!==Wd.INVALID&&d(new dr(Oo(l)),o),o=r,l=n):o=Wd.INVALID}).next(function(){o!==Wd.INVALID&&d(new dr(Oo(l)),o)})},e.prototype.getCacheSize=function(e){return this.db.getRemoteDocumentCache().getSize(e)},e}(),Za=function(){function e(o,t,e){this.remoteDocumentCache=o,this.mutationQueue=t,this.indexManager=e}return e.prototype.getDocument=function(o,e){var a=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(o,e).next(function(r){return a.getDocumentInternal(o,e,r)})},e.prototype.getDocumentInternal=function(e,o,r){return this.remoteDocumentCache.getEntry(e,o).next(function(a){for(var i=0,s=r;i<s.length;i++)a=s[i].applyToLocalView(o,a);return a})},e.prototype.applyLocalMutationsToDocuments=function(r,t,a){var i=Jn();return t.forEach(function(o,t){for(var s=0,d=a;s<d.length;s++)t=d[s].applyToLocalView(o,t);i=i.insert(o,t)}),i},e.prototype.getDocuments=function(o,e){var r=this;return this.remoteDocumentCache.getEntries(o,e).next(function(e){return r.getLocalViewOfDocuments(o,e)})},e.prototype.getLocalViewOfDocuments=function(a,r){var i=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(a,r).next(function(o){var t=i.applyLocalMutationsToDocuments(a,r,o),s=Xn();return t.forEach(function(o,t){t||(t=new gr(o,ii.forDeletedDoc())),s=s.insert(o,t)}),s})},e.prototype.getDocumentsMatchingQuery=function(o,t){return t.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(o,t.path):t.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(o,t):this.getDocumentsMatchingCollectionQuery(o,t)},e.prototype.getDocumentsMatchingDocumentQuery=function(o,t){return this.getDocument(o,new dr(t)).next(function(o){var t=$n();return o instanceof yr&&(t=t.insert(o.key,o)),t})},e.prototype.getDocumentsMatchingCollectionGroupQuery=function(s,n){var r=this;dn(n.path.isEmpty(),"Currently we only support collection group queries at the root.");var i=n.collectionGroup,o=$n();return this.indexManager.getCollectionParents(s,i).next(function(e){return xo.forEach(e,function(a){var t=n.asCollectionQueryAtPath(a.child(i));return r.getDocumentsMatchingCollectionQuery(s,t).next(function(e){e.forEach(function(r,t){o=o.insert(r,t)})})}).next(function(){return o})})},e.prototype.getDocumentsMatchingCollectionQuery=function(o,d){var e=this,n;return this.remoteDocumentCache.getDocumentsMatchingQuery(o,d).next(function(r){return n=r,e.mutationQueue.getAllMutationBatchesAffectingQuery(o,d)}).next(function(l){for(var t=0,p=l;t<p.length;t++)for(var m=p[t],r=0,y=m.mutations;r<y.length;r++){var o=y[r],a=o.key;if(d.path.isImmediateParentOf(a.path)){var s=n.get(a),u=o.applyToLocalView(s,s,m.localWriteTime);n=u instanceof yr?n.insert(a,u):n.remove(a)}}}).next(function(){return n.forEach(function(o,t){d.matches(t)||(n=n.remove(o))}),n})},e}(),es=function(){function e(){this.refsByKey=new ui(ns.compareByKey),this.refsByTarget=new ui(ns.compareByTargetId)}return e.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},e.prototype.addReference=function(o,t){var e=new ns(o,t);this.refsByKey=this.refsByKey.add(e),this.refsByTarget=this.refsByTarget.add(e)},e.prototype.addReferences=function(o,r){var e=this;o.forEach(function(o){return e.addReference(o,r)})},e.prototype.removeReference=function(o,t){this.removeRef(new ns(o,t))},e.prototype.removeReferences=function(o,r){var e=this;o.forEach(function(o){return e.removeReference(o,r)})},e.prototype.removeReferencesForId=function(a){var s=this,e=dr.EMPTY,t=new ns(e,a),r=new ns(e,a+1),n=[];return this.refsByTarget.forEachInRange([t,r],function(e){s.removeRef(e),n.push(e.key)}),n},e.prototype.removeAllReferences=function(){var o=this;this.refsByKey.forEach(function(e){return o.removeRef(e)})},e.prototype.removeRef=function(e){this.refsByKey=this.refsByKey.delete(e),this.refsByTarget=this.refsByTarget.delete(e)},e.prototype.referencesForId=function(o){var t=dr.EMPTY,e=new ns(t,o),a=new ns(t,o+1),r=Ai();return this.refsByTarget.forEachInRange([e,a],function(e){r=r.add(e.key)}),r},e.prototype.containsKey=function(o){var t=new ns(o,0),e=this.refsByKey.firstAfterOrEqual(t);return null!==e&&o.isEqual(e.key)},e}(),ns=function(){function e(o,t){this.key=o,this.targetOrBatchId=t}return e.compareByKey=function(o,t){return dr.comparator(o.key,t.key)||Un(o.targetOrBatchId,t.targetOrBatchId)},e.compareByTargetId=function(o,t){return Un(o.targetOrBatchId,t.targetOrBatchId)||dr.comparator(o.key,t.key)},e}(),rs=function(){function s(o,t){this.persistence=o,this.localViewReferences=new es,this.queryDataByTarget={},dn(o.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=o.getMutationQueue(t),this.remoteDocuments=o.getRemoteDocumentCache(),this.queryCache=o.getQueryCache(),this.localDocuments=new Za(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}return s.prototype.handleUserChange=function(o){var g=this;return this.persistence.runTransaction("Handle user change","readonly",function(y){var n;return g.mutationQueue.getAllMutationBatches(y).next(function(e){return n=e,g.mutationQueue=g.persistence.getMutationQueue(o),g.localDocuments=new Za(g.remoteDocuments,g.mutationQueue,g.persistence.getIndexManager()),g.mutationQueue.getAllMutationBatches(y)}).next(function(d){for(var m=[],e=[],t=Ai(),b=0,E=n,o;b<E.length;b++){o=E[b],m.push(o.batchId);for(var T=0,S=o.mutations,u;T<S.length;T++)u=S[T],t=t.add(u.key)}for(var I=0,C=d;I<C.length;I++){o=C[I],e.push(o.batchId);for(var l=0,D=o.mutations;l<D.length;l++)u=D[l],t=t.add(u.key)}return g.localDocuments.getDocuments(y,t).next(function(o){return{affectedDocuments:o,removedBatchIds:m,addedBatchIds:e}})})})},s.prototype.localWrite=function(d){var c=this,p=or.now(),e=d.reduce(function(o,t){return o.add(t.key)},Ai());return this.persistence.runTransaction("Locally write mutations","readwrite",function(l){return c.localDocuments.getDocuments(l,e).next(function(u){for(var n=[],t=0,m=d;t<m.length;t++){var r=m[t],i=u.get(r.key);if(!r.isIdempotent){var o=r.fieldMask;if(o){var a=i instanceof yr?o.applyTo(i.data):qr.EMPTY;n.push(new yi(r.key,a,o,Ld.exists(!0)))}}}return c.mutationQueue.addMutationBatch(l,p,n,d).next(function(o){var t=o.applyToLocalDocumentSet(u);return{batchId:o.batchId,changes:t}})})})},s.prototype.lookupMutationDocuments=function(o){var r=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(a){return r.mutationQueue.lookupMutationKeys(a,o).next(function(e){return e?r.localDocuments.getDocuments(a,e):xo.resolve(null)})})},s.prototype.acknowledgeBatch=function(o){var r=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(a){var t=o.batch.keys(),e=r.remoteDocuments.newChangeBuffer();return r.mutationQueue.acknowledgeBatch(a,o.batch,o.streamToken).next(function(){return r.applyWriteToRemoteDocuments(a,o,e)}).next(function(){return e.apply(a)}).next(function(){return r.mutationQueue.performConsistencyCheck(a)}).next(function(){return r.localDocuments.getDocuments(a,t)})})},s.prototype.rejectBatch=function(o){var a=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(r){var e;return a.mutationQueue.lookupMutationBatch(r,o).next(function(o){return dn(null!==o,"Attempt to reject nonexistent batch!"),e=o.keys(),a.mutationQueue.removeMutationBatch(r,o)}).next(function(){return a.mutationQueue.performConsistencyCheck(r)}).next(function(){return a.localDocuments.getDocuments(r,e)})})},s.prototype.getLastStreamToken=function(){var o=this;return this.persistence.runTransaction("Get last stream token","readonly",function(e){return o.mutationQueue.getLastStreamToken(e)})},s.prototype.setLastStreamToken=function(o){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(r){return e.mutationQueue.setLastStreamToken(r,o)})},s.prototype.getLastRemoteSnapshotVersion=function(){var o=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(e){return o.queryCache.getLastRemoteSnapshotVersion(e)})},s.prototype.applyRemoteEvent=function(d){var l=this,c=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(p){var o=[],a=Ai();fn(d.targetChanges,function(c,t){var e=l.queryDataByTarget[c];if(e){t.addedDocuments.forEach(function(e){a=a.add(e)}),t.modifiedDocuments.forEach(function(e){a=a.add(e)}),o.push(l.queryCache.removeMatchingKeys(p,t.removedDocuments,c).next(function(){return l.queryCache.addMatchingKeys(p,t.addedDocuments,c)}));var u=t.resumeToken;if(0<u.length){var r=e;e=e.copy({resumeToken:u,snapshotVersion:d.snapshotVersion}),l.queryDataByTarget[c]=e,s.shouldPersistQueryData(r,e,t)&&o.push(l.queryCache.updateQueryData(p,e))}}});var u=Xn(),r=Ai();d.documentUpdates.forEach(function(e){r=r.add(e)}),o.push(c.getEntries(p,r).next(function(i){d.documentUpdates.forEach(function(r,t){var e=i.get(r);null==e||t.version.isEqual(ii.MIN)||a.has(t.key)&&!e.hasPendingWrites||0<=t.version.compareTo(e.version)?(c.addEntry(t),u=u.insert(r,t)):Ro("LocalStore","Ignoring outdated watch update for ",r,". Current version:",e.version," Watch version:",t.version),d.resolvedLimboDocuments.has(r)&&o.push(l.persistence.referenceDelegate.updateLimboDocument(p,r))})}));var m=d.snapshotVersion;if(!m.isEqual(ii.MIN)){var e=l.queryCache.getLastRemoteSnapshotVersion(p).next(function(e){return dn(0<=m.compareTo(e),"Watch stream reverted to previous snapshot?? "+m+" < "+e),l.queryCache.setTargetsMetadata(p,p.currentSequenceNumber,m)});o.push(e)}return xo.waitFor(o).next(function(){return c.apply(p)}).next(function(){return l.localDocuments.getLocalViewOfDocuments(p,u)})})},s.shouldPersistQueryData=function(o,t,e){return 0!==t.resumeToken.length&&(0===o.resumeToken.length||t.snapshotVersion.toMicroseconds()-o.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size)},s.prototype.notifyLocalViewChanges=function(o){var r=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(a){return xo.forEach(o,function(e){return r.localViewReferences.addReferences(e.addedKeys,e.targetId),r.localViewReferences.removeReferences(e.removedKeys,e.targetId),xo.forEach(e.removedKeys,function(e){return r.persistence.referenceDelegate.removeReference(a,e)})})})},s.prototype.nextMutationBatch=function(o){var r=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(e){return void 0===o&&(o=-1),r.mutationQueue.getNextMutationBatchAfterBatchId(e,o)})},s.prototype.readDocument=function(o){var e=this;return this.persistence.runTransaction("read document","readonly",function(r){return e.localDocuments.getDocument(r,o)})},s.prototype.allocateQuery=function(o){var r=this;return this.persistence.runTransaction("Allocate query","readwrite",function(a){var e;return r.queryCache.getQueryData(a,o).next(function(n){return n?(e=n,xo.resolve()):r.queryCache.allocateTargetId(a).next(function(n){return e=new _d(o,n,oi.Listen,a.currentSequenceNumber),r.queryCache.addQueryData(a,e)})}).next(function(){return dn(!r.queryDataByTarget[e.targetId],"Tried to allocate an already allocated query: "+o),r.queryDataByTarget[e.targetId]=e})})},s.prototype.releaseQuery=function(d,o){var a=this,e=o?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",e,function(e){return a.queryCache.getQueryData(e,d).next(function(i){dn(null!=i,"Tried to release nonexistent query: "+d);var t=i.targetId,s=a.queryDataByTarget[t],n=a.localViewReferences.removeReferencesForId(t);return delete a.queryDataByTarget[t],o?xo.resolve():xo.forEach(n,function(o){return a.persistence.referenceDelegate.removeReference(e,o)}).next(function(){return a.persistence.referenceDelegate.removeTarget(e,s)})})})},s.prototype.executeQuery=function(o){var e=this;return this.persistence.runTransaction("Execute query","readonly",function(r){return e.localDocuments.getDocumentsMatchingQuery(r,o)})},s.prototype.remoteDocumentKeys=function(o){var e=this;return this.persistence.runTransaction("Remote document keys","readonly",function(r){return e.queryCache.getMatchingKeysForTargetId(r,o)})},s.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},s.prototype.removeCachedMutationBatchMetadata=function(e){this.mutationQueue.removeCachedMutationKeys(e)},s.prototype.setNetworkEnabled=function(e){this.persistence.setNetworkEnabled(e)},s.prototype.applyWriteToRemoteDocuments=function(d,l,i){var t=this,o=l.batch,e=o.keys(),a=xo.resolve();return e.forEach(function(s){a=a.next(function(){return i.getEntry(d,s)}).next(function(r){var t=r,a=l.docVersions.get(s);dn(null!==a,"ackVersions should contain every doc in the write."),(!t||0>t.version.compareTo(a))&&((t=o.applyToRemoteDocument(s,t,l))?i.addEntry(t):dn(!r,"Mutation batch "+o+" applied to document "+r+" resulted in null"))})}),a.next(function(){return t.mutationQueue.removeMutationBatch(d,o)})},s.prototype.collectGarbage=function(o){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(r){return o.collect(r,e.queryDataByTarget)})},s.prototype.getQueryForTarget=function(o){var e=this;return this.queryDataByTarget[o]?Promise.resolve(this.queryDataByTarget[o].query):this.persistence.runTransaction("Get query data","readonly",function(r){return e.queryCache.getQueryDataForTarget(r,o).next(function(e){return e?e.query:null})})},s.prototype.getNewDocumentChanges=function(){var o=this;return this.persistence.runTransaction("Get new document changes","readonly",function(e){return o.remoteDocuments.getNewDocumentChanges(e)})},s.RESUME_TOKEN_MAX_AGE_MICROS=3e8,s}(),is=function(){function e(o,t){this.indexManager=o,this.referenceDelegate=t,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=pn(),this.batchesByDocumentKey=new ui(ns.compareByKey)}return e.prototype.checkEmpty=function(){return xo.resolve(0===this.mutationQueue.length)},e.prototype.acknowledgeBatch=function(a,t,e){var n=t.batchId,r=this.indexOfExistingBatchId(n,"acknowledged");dn(0===r,"Can only acknowledge the first batch in the mutation queue");var i=this.mutationQueue[r];return dn(n===i.batchId,"Queue ordering failure: expected batch "+n+", got batch "+i.batchId),this.lastStreamToken=e,xo.resolve()},e.prototype.getLastStreamToken=function(){return xo.resolve(this.lastStreamToken)},e.prototype.setLastStreamToken=function(o,t){return this.lastStreamToken=t,xo.resolve()},e.prototype.addMutationBatch=function(d,t,e,n){dn(0!==n.length,"Mutation batches should not be empty");var r=this.nextBatchId;(this.nextBatchId++,0<this.mutationQueue.length)&&dn(this.mutationQueue[this.mutationQueue.length-1].batchId<r,"Mutation batchIDs must be monotonically increasing order");var i=new Do(r,t,e,n);this.mutationQueue.push(i);for(var o=0,l=n,s;o<l.length;o++)s=l[o],this.batchesByDocumentKey=this.batchesByDocumentKey.add(new ns(s.key,r)),this.indexManager.addToCollectionParentIndex(d,s.key.path.popLast());return xo.resolve(i)},e.prototype.lookupMutationBatch=function(o,t){return xo.resolve(this.findMutationBatch(t))},e.prototype.lookupMutationKeys=function(o,t){var e=this.findMutationBatch(t);return dn(null!=e,"Failed to find local mutation batch."),xo.resolve(e.keys())},e.prototype.getNextMutationBatchAfterBatchId=function(o,t){var e=this.indexOfBatchId(t+1),r=0>e?0:e;return xo.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)},e.prototype.getAllMutationBatches=function(){return xo.resolve(this.mutationQueue.slice())},e.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,s){var n=this,t=new ns(s,0),e=new ns(s,nd),r=[];return this.batchesByDocumentKey.forEachInRange([t,e],function(o){dn(s.isEqual(o.key),"Should only iterate over a single key's batches");var t=n.findMutationBatch(o.targetOrBatchId);dn(null!==t,"Batches in the index must exist in the main table"),r.push(t)}),xo.resolve(r)},e.prototype.getAllMutationBatchesAffectingDocumentKeys=function(o,t){var a=this,r=new ui(Un);return t.forEach(function(o){var e=new ns(o,0),t=new ns(o,nd);a.batchesByDocumentKey.forEachInRange([e,t],function(e){dn(o.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.targetOrBatchId)})}),xo.resolve(this.findMutationBatches(r))},e.prototype.getAllMutationBatchesAffectingQuery=function(s,t){dn(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var d=t.path,n=d.length+1,e=d;dr.isDocumentKey(e)||(e=e.child(""));var r=new ns(new dr(e),0),o=new ui(Un);return this.batchesByDocumentKey.forEachWhile(function(r){var t=r.key.path;return!!d.isPrefixOf(t)&&(t.length===n&&(o=o.add(r.targetOrBatchId)),!0)},r),xo.resolve(this.findMutationBatches(o))},e.prototype.findMutationBatches=function(e){var o=this,a=[];return e.forEach(function(r){var t=o.findMutationBatch(r);null!==t&&a.push(t)}),a},e.prototype.removeMutationBatch=function(a,n){var r=this;dn(0===this.indexOfExistingBatchId(n.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var i=this.batchesByDocumentKey;return xo.forEach(n.mutations,function(o){var t=new ns(o.key,n.batchId);return i=i.delete(t),r.referenceDelegate.removeMutationReference(a,o.key)}).next(function(){r.batchesByDocumentKey=i})},e.prototype.removeCachedMutationKeys=function(){},e.prototype.containsKey=function(o,t){var e=new ns(t,0),a=this.batchesByDocumentKey.firstAfterOrEqual(e);return xo.resolve(t.isEqual(a&&a.key))},e.prototype.performConsistencyCheck=function(){return 0===this.mutationQueue.length&&dn(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),xo.resolve()},e.prototype.indexOfExistingBatchId=function(o,t){var e=this.indexOfBatchId(o);return dn(0<=e&&e<this.mutationQueue.length,"Batches must exist to be "+t),e},e.prototype.indexOfBatchId=function(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId},e.prototype.findMutationBatch=function(o){var t=this.indexOfBatchId(o);if(0>t||t>=this.mutationQueue.length)return null;var e=this.mutationQueue[t];return dn(e.batchId===o,"If found batch must match"),e},e}(),os=function(){function e(e){this.persistence=e,this.queries=new ta(function(e){return e.canonicalId()}),this.lastRemoteSnapshotVersion=ii.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new es,this.targetCount=0,this.targetIdGenerator=Hd.forQueryCache()}return e.prototype.getTargetCount=function(){return xo.resolve(this.targetCount)},e.prototype.forEachTarget=function(e,o){return this.queries.forEach(function(r,t){return o(t)}),xo.resolve()},e.prototype.getLastRemoteSnapshotVersion=function(){return xo.resolve(this.lastRemoteSnapshotVersion)},e.prototype.getHighestSequenceNumber=function(){return xo.resolve(this.highestSequenceNumber)},e.prototype.allocateTargetId=function(){var t=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=t,xo.resolve(t)},e.prototype.setTargetsMetadata=function(o,t,e){return e&&(this.lastRemoteSnapshotVersion=e),t>this.highestSequenceNumber&&(this.highestSequenceNumber=t),xo.resolve()},e.prototype.saveQueryData=function(o){this.queries.set(o.query,o);var t=o.targetId;t>this.highestTargetId&&(this.highestTargetId=t),o.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=o.sequenceNumber)},e.prototype.addQueryData=function(o,t){return dn(!this.queries.has(t.query),"Adding a query that already exists"),this.saveQueryData(t),this.targetCount+=1,xo.resolve()},e.prototype.updateQueryData=function(o,t){return dn(this.queries.has(t.query),"Updating a non-existent query"),this.saveQueryData(t),xo.resolve()},e.prototype.removeQueryData=function(o,t){return dn(0<this.targetCount,"Removing a target from an empty cache"),dn(this.queries.has(t.query),"Removing a non-existent target from the cache"),this.queries.delete(t.query),this.references.removeReferencesForId(t.targetId),this.targetCount-=1,xo.resolve()},e.prototype.removeTargets=function(d,n,r){var i=this,o=0,l=[];return this.queries.forEach(function(a,t){t.sequenceNumber<=n&&!r[t.targetId]&&(i.queries.delete(a),l.push(i.removeMatchingKeysForTargetId(d,t.targetId)),o++)}),xo.waitFor(l).next(function(){return o})},e.prototype.getQueryCount=function(){return xo.resolve(this.targetCount)},e.prototype.getQueryData=function(o,t){var e=this.queries.get(t)||null;return xo.resolve(e)},e.prototype.getQueryDataForTarget=function(){return rn("Not yet implemented.")},e.prototype.addMatchingKeys=function(o,e,t){this.references.addReferences(e,t);var a=this.persistence.referenceDelegate,r=[];return a&&e.forEach(function(e){r.push(a.addReference(o,e))}),xo.waitFor(r)},e.prototype.removeMatchingKeys=function(o,e,t){this.references.removeReferences(e,t);var a=this.persistence.referenceDelegate,r=[];return a&&e.forEach(function(e){r.push(a.removeReference(o,e))}),xo.waitFor(r)},e.prototype.removeMatchingKeysForTargetId=function(o,t){return this.references.removeReferencesForId(t),xo.resolve()},e.prototype.getMatchingKeysForTargetId=function(o,t){var e=this.references.referencesForId(t);return xo.resolve(e)},e.prototype.containsKey=function(o,t){return xo.resolve(this.references.containsKey(t))},e}(),as=function(){function e(o,t){this.indexManager=o,this.sizer=t,this.docs=new br(dr.comparator),this.newDocumentChanges=Ai(),this.size=0}return e.prototype.addEntries=function(d,t,e){for(var n=[],r=0,l=t;r<l.length;r++){var o=l[r],a=o.maybeDocument.key;this.docs=this.docs.insert(a,o),this.newDocumentChanges=this.newDocumentChanges.add(a),n.push(this.indexManager.addToCollectionParentIndex(d,a.path.popLast()))}return this.size+=e,xo.waitFor(n)},e.prototype.removeEntry=function(o,t){var e=this.docs.get(t);return e?(this.docs=this.docs.remove(t),this.size-=e.size,xo.resolve(e.size)):xo.resolve(0)},e.prototype.getEntry=function(o,t){var e=this.docs.get(t);return xo.resolve(e?e.maybeDocument:null)},e.prototype.getSizedEntry=function(o,t){return xo.resolve(this.docs.get(t))},e.prototype.getEntries=function(o,t){var a=this,n=Jn();return t.forEach(function(o){var t=a.docs.get(o);n=n.insert(o,t?t.maybeDocument:null)}),xo.resolve(n)},e.prototype.getSizedEntries=function(o,t){var a=this,n=Jn(),s=new br(dr.comparator);return t.forEach(function(o){var t=a.docs.get(o);n=n.insert(o,t?t.maybeDocument:null),s=s.insert(o,t?t.size:0)}),xo.resolve({maybeDocuments:n,sizeMap:s})},e.prototype.getDocumentsMatchingQuery=function(d,t){dn(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var e=$n(),l=new dr(t.path.child("")),r=this.docs.getIteratorFrom(l);r.hasNext();){var i=r.getNext(),o=i.key,a=i.value.maybeDocument;if(!t.path.isPrefixOf(o.path))break;a instanceof yr&&t.matches(a)&&(e=e.insert(a.key,a))}return xo.resolve(e)},e.prototype.forEachDocumentKey=function(o,r){return xo.forEach(this.docs,function(e){return r(e)})},e.prototype.getNewDocumentChanges=function(){var o=this,r=Xn();return this.newDocumentChanges.forEach(function(a){var t=o.docs.get(a),e=t?t.maybeDocument:new gr(a,ii.forDeletedDoc());r=r.insert(a,e)}),this.newDocumentChanges=Ai(),xo.resolve(r)},e.prototype.newChangeBuffer=function(){return new cs(this.sizer,this)},e.prototype.getSize=function(){return xo.resolve(this.size)},e}(),cs=function(o){function e(r,t){var e=o.call(this)||this;return e.sizer=r,e.documentCache=t,e}return Ao(e,o),e.prototype.applyChanges=function(r){var s=this,t=this.assertChanges(),i=0,d=[];return t.forEach(function(o,t){var e=s.documentSizes.get(o);dn(void 0!==e,"Attempting to change document "+o.toString()+" without having read it first");var a=s.sizer(t);i+=a-e,d.push({maybeDocument:t,size:a})}),this.documentCache.addEntries(r,d,i)},e.prototype.getFromCache=function(o,t){return this.documentCache.getSizedEntry(o,t)},e.prototype.getAllFromCache=function(o,t){return this.documentCache.getSizedEntries(o,t)},e}(oa),hs=function(){function o(o,t){var e=this;this.clientId=o,this.mutationQueues={},this.listenSequence=new Wd(0),this._started=!1,this._started=!0,this.referenceDelegate=t(this),this.queryCache=new os(this),this.indexManager=new ha,this.remoteDocumentCache=new as(this.indexManager,function(o){return e.referenceDelegate.documentSize(o)})}return o.createLruPersistence=function(r,a,e){return new o(r,function(o){return new ps(o,new xa(a),e)})},o.createEagerPersistence=function(e){return new o(e,function(e){return new fs(e)})},o.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(o.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),o.prototype.getActiveClients=function(){return No(this,void 0,void 0,function(){return ko(this,function(){return[2,[this.clientId]]})})},o.prototype.setPrimaryStateListener=function(e){return e(!0)},o.prototype.setNetworkEnabled=function(){},o.prototype.getIndexManager=function(){return this.indexManager},o.prototype.getMutationQueue=function(o){var t=this.mutationQueues[o.toKey()];return t||(t=new is(this.indexManager,this.referenceDelegate),this.mutationQueues[o.toKey()]=t),t},o.prototype.getQueryCache=function(){return this.queryCache},o.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},o.prototype.runTransaction=function(o,t,e){var a=this;Ro("MemoryPersistence","Starting transaction:",o);var r=new ls(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),e(r).next(function(e){return a.referenceDelegate.onTransactionCommitted(r).next(function(){return e})}).toPromise()},o.prototype.mutationQueuesContainKey=function(o,e){return xo.or((a=this.mutationQueues,n=[],Tn(a,function(o,t){return n.push(t)}),n).map(function(r){return function(){return r.containsKey(o,e)}}));var a,n},o}(),ls=function(e){this.currentSequenceNumber=e},fs=function(){function e(e){this.persistence=e}return e.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},e.prototype.addReference=function(o,t){return this.orphanedDocuments.delete(t),xo.resolve()},e.prototype.removeReference=function(o,t){return this.orphanedDocuments.add(t),xo.resolve()},e.prototype.removeMutationReference=function(o,t){return this.orphanedDocuments.add(t),xo.resolve()},e.prototype.removeTarget=function(o,t){var e=this,a=this.persistence.getQueryCache();return a.getMatchingKeysForTargetId(o,t.targetId).next(function(o){o.forEach(function(o){return e.orphanedDocuments.add(o)})}).next(function(){return a.removeQueryData(o,t)})},e.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},e.prototype.onTransactionCommitted=function(o){var a=this,n=this.persistence.getRemoteDocumentCache();return xo.forEach(this.orphanedDocuments,function(r){return a.isReferenced(o,r).next(function(e){return e?xo.resolve():n.removeEntry(o,r).next(function(){})})})},e.prototype.updateLimboDocument=function(o,r){var e=this;return this.isReferenced(o,r).next(function(o){o?e.orphanedDocuments.delete(r):e.orphanedDocuments.add(r)})},e.prototype.documentSize=function(){return 0},e.prototype.isReferenced=function(o,t){var e=this;return xo.or([function(){return e.persistence.getQueryCache().containsKey(o,t)},function(){return e.persistence.mutationQueuesContainKey(o,t)},function(){return xo.resolve(e.inMemoryPins.containsKey(t))}])},e}(),ps=function(){function e(o,t,e){this.persistence=o,this.serializer=t,this.orphanedSequenceNumbers=new ta(function(e){return po(e.path)}),this.garbageCollector=new Ka(this,e)}return e.prototype.onTransactionStarted=function(){},e.prototype.onTransactionCommitted=function(){return xo.resolve()},e.prototype.forEachTarget=function(o,t){return this.persistence.getQueryCache().forEachTarget(o,t)},e.prototype.getSequenceNumberCount=function(e){var t=this.orphanedDocumentCount(e);return this.persistence.getQueryCache().getTargetCount(e).next(function(o){return t.next(function(e){return o+e})})},e.prototype.orphanedDocumentCount=function(o){var t=0;return this.forEachOrphanedDocumentSequenceNumber(o,function(){t++}).next(function(){return t})},e.prototype.forEachOrphanedDocumentSequenceNumber=function(o,a){var r=this;return xo.forEach(this.orphanedSequenceNumbers,function(n,i){return r.isPinned(o,n,i).next(function(e){return e?xo.resolve():a(i)})})},e.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},e.prototype.removeTargets=function(o,t,e){return this.persistence.getQueryCache().removeTargets(o,t,e)},e.prototype.removeOrphanedDocuments=function(a,n){var t=this,r=0,s=this.persistence.getRemoteDocumentCache();return s.forEachDocumentKey(a,function(o){return t.isPinned(a,o,n).next(function(e){return e?xo.resolve():(r++,s.removeEntry(a,o).next())})}).next(function(){return r})},e.prototype.removeMutationReference=function(o,t){return this.orphanedSequenceNumbers.set(t,o.currentSequenceNumber),xo.resolve()},e.prototype.removeTarget=function(o,t){var e=t.copy({sequenceNumber:o.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(o,e)},e.prototype.addReference=function(o,t){return this.orphanedSequenceNumbers.set(t,o.currentSequenceNumber),xo.resolve()},e.prototype.removeReference=function(o,t){return this.orphanedSequenceNumbers.set(t,o.currentSequenceNumber),xo.resolve()},e.prototype.updateLimboDocument=function(o,t){return this.orphanedSequenceNumbers.set(t,o.currentSequenceNumber),xo.resolve()},e.prototype.documentSize=function(o){var t=this.serializer.toDbRemoteDocument(o),r;if(t.document)r=t.document;else if(t.unknownDocument)r=t.unknownDocument;else{if(!t.noDocument)throw rn("Unknown remote document type");r=t.noDocument}return JSON.stringify(r).length},e.prototype.isPinned=function(o,a,e){var n=this;return xo.or([function(){return n.persistence.mutationQueuesContainKey(o,a)},function(){return xo.resolve(n.inMemoryPins.containsKey(a))},function(){return n.persistence.getQueryCache().containsKey(o,a)},function(){var o=n.orphanedSequenceNumbers.get(a);return xo.resolve(void 0!==o&&e<o)}])},e.prototype.getCacheSize=function(e){return this.persistence.getRemoteDocumentCache().getSize(e)},e}(),ds=function(){function e(o,t,e,a,r){this.queue=o,this.timerId=t,this.initialDelayMs=e,this.backoffFactor=a,this.maxDelayMs=r,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return e.prototype.reset=function(){this.currentBaseMs=0},e.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},e.prototype.backoffAndRun=function(o){var t=this;this.cancel();var e=dd(this.currentBaseMs+this.jitterDelayMs()),a=ld(0,Date.now()-this.lastAttemptTime),r=ld(0,e-a);0<this.currentBaseMs&&Ro("ExponentialBackoff","Backing off for "+r+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+e+" ms, last attempt: "+a+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,r,function(){return t.lastAttemptTime=Date.now(),o()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},e.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},e.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},e}(),ms="PersistentStream",ys,Yd;(Yd=ys||(ys={}))[Yd.Initial=0]="Initial",Yd[Yd.Starting=1]="Starting",Yd[Yd.Open=2]="Open",Yd[Yd.Error=3]="Error",Yd[Yd.Backoff=4]="Backoff";var Xd=function(){function e(a,t,e,n,r,i){this.queue=a,this.idleTimerId=e,this.connection=n,this.credentialsProvider=r,this.listener=i,this.state=ys.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new ds(a,t,1e3,1.5,6e4)}return e.prototype.isStarted=function(){return this.state===ys.Starting||this.state===ys.Open||this.state===ys.Backoff},e.prototype.isOpen=function(){return this.state===ys.Open},e.prototype.start=function(){this.state===ys.Error?this.performBackoff():(dn(this.state===ys.Initial,"Already started"),this.auth())},e.prototype.stop=function(){return No(this,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return this.isStarted()?[4,this.close(ys.Initial)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2];}})})},e.prototype.inhibitBackoff=function(){dn(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=ys.Initial,this.backoff.reset()},e.prototype.markIdle=function(){var e=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return e.handleIdleCloseTimer()}))},e.prototype.sendRequest=function(e){this.cancelIdleCheck(),this.stream.send(e)},e.prototype.handleIdleCloseTimer=function(){return No(this,void 0,void 0,function(){return ko(this,function(){return this.isOpen()?[2,this.close(ys.Initial)]:[2]})})},e.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},e.prototype.close=function(o,e){return No(this,void 0,void 0,function(){return ko(this,function(r){switch(r.label){case 0:return dn(this.isStarted(),"Only started streams should be closed."),dn(o===ys.Error||kr(e),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,o===ys.Error?e&&e.code===bn.RESOURCE_EXHAUSTED?(Ho(e.toString()),Ho("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):e&&e.code===bn.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken():this.backoff.reset(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=o,[4,this.listener.onClose(e)];case 1:return r.sent(),[2];}})})},e.prototype.tearDown=function(){},e.prototype.auth=function(){var o=this;dn(this.state===ys.Initial,"Must be in initial state to auth"),this.state=ys.Starting;var r=this.getCloseGuardedDispatcher(this.closeCount),a=this.closeCount;this.credentialsProvider.getToken().then(function(e){o.closeCount===a&&o.startStream(e)},function(a){r(function(){var e=new En(bn.UNKNOWN,"Fetching auth token failed: "+a.message);return o.handleStreamClose(e)})})},e.prototype.startStream=function(o){var r=this;dn(this.state===ys.Starting,"Trying to start stream in a non-starting state");var e=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(o),this.stream.onOpen(function(){e(function(){return dn(r.state===ys.Starting,"Expected stream to be in state Starting, but was "+r.state),r.state=ys.Open,r.listener.onOpen()})}),this.stream.onClose(function(o){e(function(){return r.handleStreamClose(o)})}),this.stream.onMessage(function(o){e(function(){return r.onMessage(o)})})},e.prototype.performBackoff=function(){var e=this;dn(this.state===ys.Error,"Should only perform backoff when in Error state"),this.state=ys.Backoff,this.backoff.backoffAndRun(function(){return No(e,void 0,void 0,function(){return ko(this,function(){return dn(this.state===ys.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=ys.Initial,this.start(),dn(this.isStarted(),"PersistentStream should have started"),[2]})})})},e.prototype.handleStreamClose=function(e){return dn(this.isStarted(),"Can't handle server close on non-started stream"),Ro(ms,"close with error: "+e),this.stream=null,this.close(ys.Error,e)},e.prototype.getCloseGuardedDispatcher=function(o){var e=this;return function(r){e.queue.enqueueAndForget(function(){return e.closeCount===o?r():(Ro(ms,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},e}(),Es=function(s){function e(a,t,e,n,r){var i=s.call(this,a,Io.ListenStreamConnectionBackoff,Io.ListenStreamIdle,t,e,r)||this;return i.serializer=n,i}return Ao(e,s),e.prototype.startRpc=function(e){return this.connection.openStream("Listen",e)},e.prototype.onMessage=function(o){this.backoff.reset();var t=this.serializer.fromWatchChange(o),e=this.serializer.versionFromListenResponse(o);return this.listener.onWatchChange(t,e)},e.prototype.watch=function(o){var t={database:this.serializer.encodedDatabaseId,addTarget:this.serializer.toTarget(o)},e=this.serializer.toListenRequestLabels(o);e&&(t.labels=e),this.sendRequest(t)},e.prototype.unwatch=function(o){var t={};t.database=this.serializer.encodedDatabaseId,t.removeTarget=o,this.sendRequest(t)},e}(Xd),Ss=function(s){function e(a,t,e,n,r){var i=s.call(this,a,Io.WriteStreamConnectionBackoff,Io.WriteStreamIdle,t,e,r)||this;return i.serializer=n,i.handshakeComplete_=!1,i}return Ao(e,s),Object.defineProperty(e.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.handshakeComplete_=!1,s.prototype.start.call(this)},e.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},e.prototype.startRpc=function(e){return this.connection.openStream("Write",e)},e.prototype.onMessage=function(o){if(dn(!!o.streamToken,"Got a write response without a stream token"),this.lastStreamToken=o.streamToken,this.handshakeComplete_){this.backoff.reset();var t=this.serializer.fromWriteResults(o.writeResults,o.commitTime),e=this.serializer.fromVersion(o.commitTime);return this.listener.onMutationResult(e,t)}return dn(!o.writeResults||0===o.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},e.prototype.writeHandshake=function(){dn(this.isOpen(),"Writing handshake requires an opened stream"),dn(!this.handshakeComplete_,"Handshake already completed");var e={};e.database=this.serializer.encodedDatabaseId,this.sendRequest(e)},e.prototype.writeMutations=function(o){var r=this;dn(this.isOpen(),"Writing mutations requires an opened stream"),dn(this.handshakeComplete_,"Handshake must be complete before writing mutations"),dn(0<this.lastStreamToken.length,"Trying to write mutation without a token");var e={streamToken:this.lastStreamToken,writes:o.map(function(e){return r.serializer.toMutation(e)})};this.sendRequest(e)},e}(Xd),Ts=function(){function e(o,t,e,a){this.queue=o,this.connection=t,this.credentials=e,this.serializer=a}return e.prototype.newPersistentWriteStream=function(e){return new Ss(this.queue,this.connection,this.credentials,this.serializer,e)},e.prototype.newPersistentWatchStream=function(e){return new Es(this.queue,this.connection,this.credentials,this.serializer,e)},e.prototype.commit=function(o){var r=this,e={database:this.serializer.encodedDatabaseId,writes:o.map(function(e){return r.serializer.toMutation(e)})};return this.invokeRPC("Commit",e).then(function(e){return r.serializer.fromWriteResults(e.writeResults,e.commitTime)})},e.prototype.lookup=function(o){var r=this,e={database:this.serializer.encodedDatabaseId,documents:o.map(function(e){return r.serializer.toName(e)})};return this.invokeStreamingRPC("BatchGetDocuments",e).then(function(e){var a=Xn();e.forEach(function(o){var t=r.serializer.fromMaybeDocument(o);a=a.insert(t.key,t)});var i=[];return o.forEach(function(o){var t=a.get(o);dn(!!t,"Missing entity in write response for "+o),i.push(t)}),i})},e.prototype.invokeRPC=function(o,e){var a=this;return this.credentials.getToken().then(function(r){return a.connection.invokeRPC(o,e,r)}).catch(function(e){throw e.code===bn.UNAUTHENTICATED&&a.credentials.invalidateToken(),e})},e.prototype.invokeStreamingRPC=function(o,e){var a=this;return this.credentials.getToken().then(function(r){return a.connection.invokeStreamingRPC(o,e,r)}).catch(function(e){throw e.code===bn.UNAUTHENTICATED&&a.credentials.invalidateToken(),e})},e}(),Is=function(){function e(e){this.datastore=e,this.readVersions=Ii(),this.mutations=[],this.committed=!1}return e.prototype.recordVersion=function(o){var t;if(o instanceof yr)t=o.version;else{if(!(o instanceof gr))throw rn("Document in a transaction was a "+o.constructor.name);t=ii.forDeletedDoc()}var r=this.readVersions.get(o.key);if(!(null!==r))this.readVersions=this.readVersions.insert(o.key,t);else if(!t.isEqual(r))throw new En(bn.ABORTED,"Document version changed between two reads.")},e.prototype.lookup=function(o){var r=this;return this.committed?Promise.reject("Transaction has already completed."):0<this.mutations.length?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(o).then(function(e){return e.forEach(function(e){e instanceof gr||e instanceof yr?r.recordVersion(e):rn("Document in a transaction was a "+e.constructor.name)}),e})},e.prototype.write=function(e){if(this.committed)throw new En(bn.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(e)},e.prototype.precondition=function(o){var t=this.readVersions.get(o);return t?Ld.updateTime(t):Ld.NONE},e.prototype.preconditionForUpdate=function(o){var t=this.readVersions.get(o);if(t&&t.isEqual(ii.forDeletedDoc()))throw new En(bn.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return t?Ld.updateTime(t):Ld.exists(!0)},e.prototype.set=function(o,t){this.write(t.toMutations(o,this.precondition(o)))},e.prototype.update=function(o,t){this.write(t.toMutations(o,this.preconditionForUpdate(o)))},e.prototype.delete=function(e){this.write([new vi(e,this.precondition(e))]),this.readVersions=this.readVersions.insert(e,ii.forDeletedDoc())},e.prototype.commit=function(){var o=this,r=this.readVersions;return this.mutations.forEach(function(e){r=r.remove(e.key)}),r.isEmpty()?this.datastore.commit(this.mutations).then(function(){o.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},e}(),Cs,Jd,Zd,$d;(Jd=Cs||(Cs={}))[Jd.Unknown=0]="Unknown",Jd[Jd.Online=1]="Online",Jd[Jd.Offline=2]="Offline",($d=Zd||(Zd={}))[$d.RemoteStore=0]="RemoteStore",$d[$d.SharedClientState=1]="SharedClientState";var el=function(){function e(o,t){this.asyncQueue=o,this.onlineStateHandler=t,this.state=Cs.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return e.prototype.handleWatchStreamStart=function(){var e=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Cs.Unknown),dn(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Io.OnlineStateTimeout,1e4,function(){return e.onlineStateTimer=null,dn(e.state===Cs.Unknown,"Timer should be canceled if we transitioned to a different state."),e.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),e.setAndBroadcast(Cs.Offline),Promise.resolve()}))},e.prototype.handleWatchStreamFailure=function(e){this.state===Cs.Online?(this.setAndBroadcast(Cs.Unknown),dn(0===this.watchStreamFailures,"watchStreamFailures must be 0"),dn(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+e.toString()),this.setAndBroadcast(Cs.Offline)))},e.prototype.set=function(e){this.clearOnlineStateTimer(),this.watchStreamFailures=0,e===Cs.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(e)},e.prototype.setAndBroadcast=function(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))},e.prototype.logClientOfflineWarningIfNecessary=function(o){var t="Could not reach Cloud Firestore backend. "+o+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Ho(t),this.shouldWarnClientIsOffline=!1):Ro("OnlineStateTracker",t)},e.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},e}(),Ds=function(){function e(o,t,e,a){this.localStore=o,this.datastore=t,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.onlineStateTracker=new el(e,a),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return e.prototype.start=function(){return this.enableNetwork()},e.prototype.enableNetwork=function(){return No(this,void 0,void 0,function(){var o;return ko(this,function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(o=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return o.lastStreamToken=e.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Cs.Unknown),[4,this.fillWritePipeline()];case 2:e.sent(),e.label=3;case 3:return[2];}})})},e.prototype.disableNetwork=function(){return No(this,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.onlineStateTracker.set(Cs.Offline),[2];}})})},e.prototype.disableNetworkInternal=function(){return No(this,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return[4,this.writeStream.stop()];case 1:return e.sent(),[4,this.watchStream.stop()];case 2:return e.sent(),0<this.writePipeline.length&&(Ro("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2];}})})},e.prototype.shutdown=function(){return No(this,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return Ro("RemoteStore","RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.onlineStateTracker.set(Cs.Unknown),[2];}})})},e.prototype.listen=function(e){dn(!yn(this.listenTargets,e.targetId),"listen called with duplicate targetId!"),this.listenTargets[e.targetId]=e,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(e)},e.prototype.unlisten=function(e){dn(yn(this.listenTargets,e),"unlisten called without assigned target ID!"),delete this.listenTargets[e],this.watchStream.isOpen()&&this.sendUnwatchRequest(e),In(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Cs.Unknown))},e.prototype.getQueryDataForTarget=function(e){return this.listenTargets[e]||null},e.prototype.getRemoteKeysForTarget=function(e){return this.syncEngine.getRemoteKeysForTarget(e)},e.prototype.sendWatchRequest=function(e){this.watchChangeAggregator.recordPendingTargetRequest(e.targetId),this.watchStream.watch(e)},e.prototype.sendUnwatchRequest=function(e){this.watchChangeAggregator.recordPendingTargetRequest(e),this.watchStream.unwatch(e)},e.prototype.startWatchStream=function(){dn(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new eo(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},e.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!In(this.listenTargets)},e.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},e.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},e.prototype.onWatchStreamOpen=function(){return No(this,void 0,void 0,function(){var o=this;return ko(this,function(){return fn(this.listenTargets,function(r,t){o.sendWatchRequest(t)}),[2]})})},e.prototype.onWatchStreamClose=function(t){return No(this,void 0,void 0,function(){return ko(this,function(){return void 0===t&&dn(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(Cs.Unknown),[2]})})},e.prototype.onWatchStreamChange=function(o,a){return No(this,void 0,void 0,function(){var r;return ko(this,function(e){switch(e.label){case 0:return this.onlineStateTracker.set(Cs.Online),o instanceof Qd&&o.state===Zi.Removed&&o.cause?[2,this.handleTargetError(o)]:(o instanceof Ji?this.watchChangeAggregator.handleDocumentChange(o):o instanceof $i?this.watchChangeAggregator.handleExistenceFilter(o):(dn(o instanceof Qd,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(o)),a.isEqual(ii.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return r=e.sent(),0<=a.compareTo(r)?[4,this.raiseWatchSnapshot(a)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2];}})})},e.prototype.raiseWatchSnapshot=function(o){var r=this;dn(!o.isEqual(ii.MIN),"Can't raise event for unknown SnapshotVersion");var e=this.watchChangeAggregator.createRemoteEvent(o);return fn(e.targetChanges,function(a,t){if(0<t.resumeToken.length){var e=r.listenTargets[a];e&&(r.listenTargets[a]=e.copy({resumeToken:t.resumeToken,snapshotVersion:o}))}}),e.targetMismatches.forEach(function(o){var t=r.listenTargets[o];if(t){r.listenTargets[o]=t.copy({resumeToken:pn()}),r.sendUnwatchRequest(o);var e=new _d(t.query,o,oi.ExistenceFilterMismatch,t.sequenceNumber);r.sendWatchRequest(e)}}),this.syncEngine.applyRemoteEvent(e)},e.prototype.handleTargetError=function(e){var t=this;dn(!!e.cause,"Handling target error without a cause");var o=e.cause,r=Promise.resolve();return e.targetIds.forEach(function(a){r=r.then(function(){return No(t,void 0,void 0,function(){return ko(this,function(){return yn(this.listenTargets,a)?(delete this.listenTargets[a],this.watchChangeAggregator.removeTarget(a),[2,this.syncEngine.rejectListen(a,o)]):[2]})})})}),r},e.prototype.fillWritePipeline=function(){return No(this,void 0,void 0,function(){var o,r;return ko(this,function(e){switch(e.label){case 0:return this.canAddToWritePipeline()?(o=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(o)]):[3,4];case 1:return null===(r=e.sent())?(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]):[3,2];case 2:return this.addToWritePipeline(r),[4,this.fillWritePipeline()];case 3:e.sent(),e.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2];}})})},e.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&10>this.writePipeline.length},e.prototype.outstandingWrites=function(){return this.writePipeline.length},e.prototype.addToWritePipeline=function(e){dn(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(e),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(e.mutations)},e.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},e.prototype.startWriteStream=function(){dn(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},e.prototype.onWriteStreamOpen=function(){return No(this,void 0,void 0,function(){return ko(this,function(){return this.writeStream.writeHandshake(),[2]})})},e.prototype.onWriteHandshakeComplete=function(){var o=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var r=0,a=o.writePipeline,e;r<a.length;r++)e=a[r],o.writeStream.writeMutations(e.mutations)}).catch(Va)},e.prototype.onMutationResult=function(o,t){var e=this;dn(0<this.writePipeline.length,"Got result for empty write pipeline");var a=this.writePipeline.shift(),r=Lo.from(a,o,t,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(r).then(function(){return e.fillWritePipeline()})},e.prototype.onWriteStreamClose=function(t){return No(this,void 0,void 0,function(){var o=this;return ko(this,function(){return void 0===t&&dn(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&0<this.writePipeline.length?([2,(this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t)).then(function(){o.shouldStartWriteStream()&&o.startWriteStream()})]):[2]})})},e.prototype.handleHandshakeError=function(t){return No(this,void 0,void 0,function(){return ko(this,function(){return Hn(t.code)?(Ro("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=pn(),[2,this.localStore.setLastStreamToken(pn()).catch(Va)]):[2]})})},e.prototype.handleWriteError=function(t){return No(this,void 0,void 0,function(){var e=this,o;return ko(this,function(){return Hn(r=t.code)&&r!==bn.ABORTED?(o=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(o.batchId,t).then(function(){return e.fillWritePipeline()})]):[2];var r})})},e.prototype.createTransaction=function(){return new Is(this.datastore)},e.prototype.handleCredentialChange=function(){return No(this,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return this.canUseNetwork()?(Ro("RemoteStore","RemoteStore restarting streams for new credential"),this.networkEnabled=!1,[4,this.disableNetworkInternal()]):[3,3];case 1:return e.sent(),this.onlineStateTracker.set(Cs.Unknown),[4,this.enableNetwork()];case 2:e.sent(),e.label=3;case 3:return[2];}})})},e.prototype.applyPrimaryState=function(o){return No(this,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return(this.isPrimary=o)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return o?[3,4]:[4,this.disableNetworkInternal()];case 3:e.sent(),this.onlineStateTracker.set(Cs.Unknown),e.label=4;case 4:return[2];}})})},e}(),As=function(){this.listeners=[]},ks=function(){function e(e){this.syncEngine=e,this.queries=new ta(function(e){return e.canonicalId()}),this.onlineState=Cs.Unknown,this.syncEngine.subscribe(this)}return e.prototype.listen=function(o){var t=o.query,e=!1,a=this.queries.get(t);return a||(e=!0,a=new As,this.queries.set(t,a)),a.listeners.push(o),o.applyOnlineStateChange(this.onlineState),a.viewSnap&&o.onViewSnapshot(a.viewSnap),e?this.syncEngine.listen(t).then(function(e){return a.targetId=e}):Promise.resolve(a.targetId)},e.prototype.unlisten=function(t){return No(this,void 0,void 0,function(){var o,a,s,d;return ko(this,function(){return o=t.query,a=!1,(s=this.queries.get(o))&&0<=(d=s.listeners.indexOf(t))&&(s.listeners.splice(d,1),a=0===s.listeners.length),a?(this.queries.delete(o),[2,this.syncEngine.unlisten(o)]):[2]})})},e.prototype.onWatchChange=function(d){for(var t=0,l=d;t<l.length;t++){var n=l[t],r=n.query,i=this.queries.get(r);if(i){for(var o=0,c=i.listeners;o<c.length;o++)c[o].onViewSnapshot(n);i.viewSnap=n}}},e.prototype.onWatchError=function(o,t){var e=this.queries.get(o);if(e)for(var a=0,n=e.listeners;a<n.length;a++)n[a].onError(t);this.queries.delete(o)},e.prototype.onOnlineStateChange=function(t){this.onlineState=t,this.queries.forEach(function(o,a){for(var e=0,i=a.listeners;e<i.length;e++)i[e].applyOnlineStateChange(t)})},e}(),Rs=function(){function e(o,t,e){this.query=o,this.queryObserver=t,this.raisedInitialEvent=!1,this.onlineState=Cs.Unknown,this.options=e||{}}return e.prototype.onViewSnapshot=function(o){if(dn(0<o.docChanges.length||o.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var a=[],e=0,s=o.docChanges,r;e<s.length;e++)r=s[e],r.type!==Wi.Metadata&&a.push(r);o=new Hi(o.query,o.docs,o.oldDocs,a,o.mutatedKeys,o.fromCache,o.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(o)&&this.queryObserver.next(o):this.shouldRaiseInitialEvent(o,this.onlineState)&&this.raiseInitialEvent(o),this.snap=o},e.prototype.onError=function(e){this.queryObserver.error(e)},e.prototype.applyOnlineStateChange=function(e){this.onlineState=e,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,e)&&this.raiseInitialEvent(this.snap)},e.prototype.shouldRaiseInitialEvent=function(o,t){if(dn(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!o.fromCache)return!0;var e=t!==Cs.Offline;return this.options.waitForSyncWhenOnline&&e?(dn(o.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!o.docs.isEmpty()||t===Cs.Offline},e.prototype.shouldRaiseEvent=function(o){if(0<o.docChanges.length)return!0;var t=this.snap&&this.snap.hasPendingWrites!==o.hasPendingWrites;return(o.syncStateChanged||t)&&!0===this.options.includeMetadataChanges},e.prototype.raiseInitialEvent=function(e){dn(!this.raisedInitialEvent,"Trying to raise initial events for second time"),e=Hi.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(e)},e}(),Ms=function(){function d(o,t,e){this.targetId=o,this.addedKeys=t,this.removedKeys=e}return d.fromSnapshot=function(s,t){for(var e=Ai(),l=Ai(),c=0,p=t.docChanges,o;c<p.length;c++)switch(o=p[c],o.type){case Wi.Added:e=e.add(o.doc.key);break;case Wi.Removed:l=l.add(o.doc.key);}return new d(s,e,l)},d}(),_s=function(e){this.key=e},Os=function(e){this.key=e},Ps=function(){function e(o,t){this.query=o,this._syncedDocuments=t,this.syncState=null,this.current=!1,this.limboDocuments=Ai(),this.mutatedKeys=Ai(),this.documentSet=new Vi(o.docComparator.bind(o))}return Object.defineProperty(e.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),e.prototype.computeDocChanges=function(o,t){var d=this,s=t?t.changeSet:new Bd,u=t?t.documentSet:this.documentSet,c=t?t.mutatedKeys:this.mutatedKeys,m=u,y=!1,g=this.query.hasLimit()&&u.size===this.query.limit?u.last():null;if(o.inorderTraversal(function(l,t){var e=u.get(l),n=t instanceof yr?t:null;n&&(dn(l.isEqual(n.key),"Mismatching keys found in document changes: "+l+" != "+n.key),n=d.query.matches(n)?n:null);var p=!!e&&d.mutatedKeys.has(e.key),i=!!n&&(n.hasLocalMutations||d.mutatedKeys.has(n.key)&&n.hasCommittedMutations),o=!1;e&&n?e.data.isEqual(n.data)?p!==i&&(s.track({type:Wi.Metadata,doc:n}),o=!0):d.shouldWaitForSyncedDocument(e,n)||(s.track({type:Wi.Modified,doc:n}),o=!0,g&&0<d.query.docComparator(n,g)&&(y=!0)):!e&&n?(s.track({type:Wi.Added,doc:n}),o=!0):e&&!n&&(s.track({type:Wi.Removed,doc:e}),o=!0,g&&(y=!0)),o&&(c=n?(m=m.add(n),i?c.add(l):c.delete(l)):(m=m.delete(l),c.delete(l)))}),this.query.hasLimit())for(;m.size>this.query.limit;){var e=m.last();m=m.delete(e.key),c=c.delete(e.key),s.track({type:Wi.Removed,doc:e})}return dn(!y||!t,"View was refilled using docs that themselves needed refilling."),{documentSet:m,changeSet:s,needsRefill:y,mutatedKeys:c}},e.prototype.shouldWaitForSyncedDocument=function(o,t){return o.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations},e.prototype.applyChanges=function(d,t,e){var l=this;dn(!d.needsRefill,"Cannot apply changes that need a refill");var o=this.documentSet;this.documentSet=d.documentSet,this.mutatedKeys=d.mutatedKeys;var r=d.changeSet.getChanges();r.sort(function(o,t){return e=o.type,a=t.type,(s=function(e){return e===Wi.Added?1:e===Wi.Modified||e===Wi.Metadata?2:e===Wi.Removed?0:rn("Unknown ChangeType: "+e)})(e)-s(a)||l.query.docComparator(o.doc,t.doc);var e,a,s}),this.applyTargetChange(e);var n=t?this.updateLimboDocuments():[],a=0===this.limboDocuments.size&&this.current?Fd.Synced:Fd.Local,i=a!==this.syncState;return this.syncState=a,0!==r.length||i?{snapshot:new Hi(this.query,d.documentSet,o,r,d.mutatedKeys,a===Fd.Local,i,!1),limboChanges:n}:{limboChanges:n}},e.prototype.applyOnlineStateChange=function(e){return this.current&&e===Cs.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Bd,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},e.prototype.shouldBeInLimbo=function(e){return!this._syncedDocuments.has(e)&&!!this.documentSet.has(e)&&!this.documentSet.get(e).hasLocalMutations},e.prototype.applyTargetChange=function(o){var r=this;o&&(o.addedDocuments.forEach(function(e){return r._syncedDocuments=r._syncedDocuments.add(e)}),o.modifiedDocuments.forEach(function(e){return dn(r._syncedDocuments.has(e),"Modified document "+e+" not found in view.")}),o.removedDocuments.forEach(function(e){return r._syncedDocuments=r._syncedDocuments.delete(e)}),this.current=o.current)},e.prototype.updateLimboDocuments=function(){var o=this;if(!this.current)return[];var e=this.limboDocuments;this.limboDocuments=Ai(),this.documentSet.forEach(function(e){o.shouldBeInLimbo(e.key)&&(o.limboDocuments=o.limboDocuments.add(e.key))});var a=[];return e.forEach(function(e){o.limboDocuments.has(e)||a.push(new Os(e))}),this.limboDocuments.forEach(function(o){e.has(o)||a.push(new _s(o))}),a},e.prototype.synchronizeWithPersistedState=function(o,t){this._syncedDocuments=t,this.limboDocuments=Ai();var e=this.computeDocChanges(o);return this.applyChanges(e,!0)},e.prototype.computeInitialSnapshot=function(){return Hi.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Fd.Local)},e}(),Ls="SyncEngine",xs=function(o,t,e){this.query=o,this.targetId=t,this.view=e},qs=function(e){this.key=e},Fs=function(){function e(o,t,e,a){this.localStore=o,this.remoteStore=t,this.sharedClientState=e,this.currentUser=a,this.syncEngineListener=null,this.queryViewsByQuery=new ta(function(e){return e.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new br(dr.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new es,this.mutationUserCallbacks={},this.limboTargetIdGenerator=Hd.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Cs.Unknown}return Object.defineProperty(e.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(e){dn(null!==e,"SyncEngine listener cannot be null"),dn(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=e},e.prototype.listen=function(s){return No(this,void 0,void 0,function(){var a,d,l,c,p;return ko(this,function(e){switch(e.label){case 0:return this.assertSubscribed("listen()"),(l=this.queryViewsByQuery.get(s))?(a=l.targetId,this.sharedClientState.addLocalQueryTarget(a),d=l.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(s)];case 2:return c=e.sent(),p=this.sharedClientState.addLocalQueryTarget(c.targetId),a=c.targetId,[4,this.initializeViewAndComputeSnapshot(c,"current"===p)];case 3:d=e.sent(),this.isPrimary&&this.remoteStore.listen(c),e.label=4;case 4:return this.syncEngineListener.onWatchChange([d]),[2,a];}})})},e.prototype.initializeViewAndComputeSnapshot=function(d,s){var l=this,c=d.query;return this.localStore.executeQuery(c).then(function(p){return l.localStore.remoteDocumentKeys(d.targetId).then(function(a){var t=new Ps(c,a),e=t.computeDocChanges(p),n=Xi.createSynthesizedTargetChangeForCurrentChange(d.targetId,s&&l.onlineState!==Cs.Offline),r=t.applyChanges(e,!0===l.isPrimary,n);dn(0===r.limboChanges.length,"View returned limbo docs before target ack from the server."),dn(!!r.snapshot,"applyChanges for new view should always return a snapshot");var i=new xs(c,d.targetId,t);return l.queryViewsByQuery.set(c,i),l.queryViewsByTarget[d.targetId]=i,r.snapshot})})},e.prototype.synchronizeViewAndComputeSnapshot=function(o){var e=this;return this.localStore.executeQuery(o.query).then(function(t){return e.localStore.remoteDocumentKeys(o.targetId).then(function(r){return No(e,void 0,void 0,function(){var a;return ko(this,function(){return a=o.view.synchronizeWithPersistedState(t,r),this.isPrimary&&this.updateTrackedLimbos(o.targetId,a.limboChanges),[2,a]})})})})},e.prototype.unlisten=function(o){return No(this,void 0,void 0,function(){var t=this,r;return ko(this,function(e){switch(e.label){case 0:return this.assertSubscribed("unlisten()"),dn(!!(r=this.queryViewsByQuery.get(o)),"Trying to unlisten on query not found:"+o),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(r.targetId),this.sharedClientState.isActiveQueryTarget(r.targetId)?[3,2]:[4,this.localStore.releaseQuery(o,!1).then(function(){t.sharedClientState.clearQueryState(r.targetId),t.remoteStore.unlisten(r.targetId),t.removeAndCleanupQuery(r)}).catch(Va)]):[3,3];case 1:e.sent(),e.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(r),[4,this.localStore.releaseQuery(o,!0)];case 4:e.sent(),e.label=5;case 5:return[2];}})})},e.prototype.write=function(o,r){var e=this;return this.assertSubscribed("write()"),this.localStore.localWrite(o).then(function(o){return e.sharedClientState.addPendingMutation(o.batchId),e.addMutationCallback(o.batchId,r),e.emitNewSnapsAndNotifyLocalStore(o.changes)}).then(function(){return e.remoteStore.fillWritePipeline()})},e.prototype.wrapUpdateFunctionError=function(e){return e},e.prototype.runTransaction=function(o,e){var a=this;void 0===e&&(e=5),dn(0<=e,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var e=o(r);return!kr(e)&&e.catch&&e.then?e.catch(function(e){return Promise.reject(a.wrapUpdateFunctionError(e))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(e){return Promise.reject(a.wrapUpdateFunctionError(e))}}().then(function(n){return r.commit().then(function(){return n}).catch(function(r){return 0===e?Promise.reject(r):a.runTransaction(o,e-1)})})},e.prototype.applyRemoteEvent=function(o){var a=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(o).then(function(e){return Tn(o.targetChanges,function(o,t){var e=a.limboResolutionsByTarget[o];e&&(dn(1>=t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size,"Limbo resolution for single document contains multiple changes."),0<t.addedDocuments.size?e.receivedDocument=!0:0<t.modifiedDocuments.size?dn(e.receivedDocument,"Received change for limbo target document without add."):0<t.removedDocuments.size&&(dn(e.receivedDocument,"Received remove for limbo target document without add."),e.receivedDocument=!1))}),a.emitNewSnapsAndNotifyLocalStore(e,o)}).catch(Va)},e.prototype.applyOnlineStateChange=function(o,e){if(this.isPrimary&&e===Zd.RemoteStore||!this.isPrimary&&e===Zd.SharedClientState){var r=[];this.queryViewsByQuery.forEach(function(a,t){var e=t.view.applyOnlineStateChange(o);dn(0===e.limboChanges.length,"OnlineState should not affect limbo documents."),e.snapshot&&r.push(e.snapshot)}),this.syncEngineListener.onOnlineStateChange(o),this.syncEngineListener.onWatchChange(r),this.onlineState=o,this.isPrimary&&this.sharedClientState.setOnlineState(o)}},e.prototype.rejectListen=function(d,l){return No(this,void 0,void 0,function(){var t=this,s,c,p,u,m,y;return ko(this,function(e){switch(e.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(d,"rejected",l),s=this.limboResolutionsByTarget[d],(c=s&&s.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(c),delete this.limboResolutionsByTarget[d],p=(p=new br(dr.comparator)).insert(c,new gr(c,ii.forDeletedDoc())),u=Ai().add(c),m=new Yi(ii.MIN,{},new ui(Un),p,u),[2,this.applyRemoteEvent(m)]):[3,1];case 1:return dn(!!(y=this.queryViewsByTarget[d]),"Unknown targetId: "+d),[4,this.localStore.releaseQuery(y.query,!1).then(function(){return t.removeAndCleanupQuery(y)}).catch(Va)];case 2:e.sent(),this.syncEngineListener.onWatchError(y.query,l),e.label=3;case 3:return[2];}})})},e.prototype.applyBatchState=function(o,a,r){return No(this,void 0,void 0,function(){var n;return ko(this,function(e){switch(e.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(o)];case 1:return null===(n=e.sent())?(Ro(Ls,"Cannot apply mutation batch with id: "+o),[2]):"pending"===a?[4,this.remoteStore.fillWritePipeline()]:[3,3];case 2:return e.sent(),[3,4];case 3:"acknowledged"===a||"rejected"===a?(this.processUserCallback(o,r||null),this.localStore.removeCachedMutationBatchMetadata(o)):rn("Unknown batchState: "+a),e.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 5:return e.sent(),[2];}})})},e.prototype.applySuccessfulWrite=function(o){var r=this;this.assertSubscribed("applySuccessfulWrite()");var e=o.batch.batchId;return this.processUserCallback(e,null),this.localStore.acknowledgeBatch(o).then(function(o){return r.sharedClientState.updateMutationState(e,"acknowledged"),r.emitNewSnapsAndNotifyLocalStore(o)}).catch(Va)},e.prototype.rejectFailedWrite=function(o,e){var a=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(o,e),this.localStore.rejectBatch(o).then(function(r){return a.sharedClientState.updateMutationState(o,"rejected",e),a.emitNewSnapsAndNotifyLocalStore(r)}).catch(Va)},e.prototype.addMutationCallback=function(o,t){var e=this.mutationUserCallbacks[this.currentUser.toKey()];e||(e=new br(Un)),e=e.insert(o,t),this.mutationUserCallbacks[this.currentUser.toKey()]=e},e.prototype.processUserCallback=function(o,t){var e=this.mutationUserCallbacks[this.currentUser.toKey()];if(e){var a=e.get(o);a&&(dn(o===e.minKey(),"Mutation callbacks processed out-of-order?"),t?a.reject(t):a.resolve(),e=e.remove(o)),this.mutationUserCallbacks[this.currentUser.toKey()]=e}},e.prototype.removeAndCleanupQuery=function(o){var r=this;if(this.sharedClientState.removeLocalQueryTarget(o.targetId),this.queryViewsByQuery.delete(o.query),delete this.queryViewsByTarget[o.targetId],this.isPrimary){var e=this.limboDocumentRefs.referencesForId(o.targetId);this.limboDocumentRefs.removeReferencesForId(o.targetId),e.forEach(function(e){r.limboDocumentRefs.containsKey(e)||r.removeLimboTarget(e)})}},e.prototype.removeLimboTarget=function(o){var t=this.limboTargetsByKey.get(o);null!==t&&(this.remoteStore.unlisten(t),this.limboTargetsByKey=this.limboTargetsByKey.remove(o),delete this.limboResolutionsByTarget[t])},e.prototype.updateTrackedLimbos=function(o,t){for(var e=0,a=t,r;e<a.length;e++)r=a[e],r instanceof _s?(this.limboDocumentRefs.addReference(r.key,o),this.trackLimboChange(r)):r instanceof Os?(Ro(Ls,"Document no longer in limbo: "+r.key),this.limboDocumentRefs.removeReference(r.key,o),this.limboDocumentRefs.containsKey(r.key)||this.removeLimboTarget(r.key)):rn("Unknown limbo change: "+JSON.stringify(r))},e.prototype.trackLimboChange=function(o){var t=o.key;if(!this.limboTargetsByKey.get(t)){Ro(Ls,"New document in limbo: "+t);var e=this.limboTargetIdGenerator.next(),a=Kr.atPath(t.path);this.limboResolutionsByTarget[e]=new qs(t),this.remoteStore.listen(new _d(a,e,oi.LimboResolution,Wd.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(t,e)}},e.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},e.prototype.emitNewSnapsAndNotifyLocalStore=function(t,d){return No(this,void 0,void 0,function(){var l=this,s,c,r;return ko(this,function(e){switch(e.label){case 0:return s=[],c=[],r=[],this.queryViewsByQuery.forEach(function(e,o){r.push(Promise.resolve().then(function(){var r=o.view.computeDocChanges(t);return r.needsRefill?l.localStore.executeQuery(o.query).then(function(e){return o.view.computeDocChanges(e,r)}):r}).then(function(a){var t=d&&d.targetChanges[o.targetId],e=o.view.applyChanges(a,!0===l.isPrimary,t);if(l.updateTrackedLimbos(o.targetId,e.limboChanges),e.snapshot){l.isPrimary&&l.sharedClientState.updateQueryState(o.targetId,e.snapshot.fromCache?"not-current":"current"),s.push(e.snapshot);var n=Ms.fromSnapshot(o.targetId,e.snapshot);c.push(n)}}))}),[4,Promise.all(r)];case 1:return e.sent(),this.syncEngineListener.onWatchChange(s),[4,this.localStore.notifyLocalViewChanges(c)];case 2:return e.sent(),[2];}})})},e.prototype.assertSubscribed=function(e){dn(null!==this.syncEngineListener,"Trying to call "+e+" before calling subscribe().")},e.prototype.handleCredentialChange=function(o){return No(this,void 0,void 0,function(){var r,a;return ko(this,function(e){switch(e.label){case 0:return r=!this.currentUser.isEqual(o),this.currentUser=o,r?[4,this.localStore.handleUserChange(o)]:[3,3];case 1:return a=e.sent(),this.sharedClientState.handleUserChange(o,a.removedBatchIds,a.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(a.affectedDocuments)];case 2:e.sent(),e.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return e.sent(),[2];}})})},e.prototype.applyPrimaryState=function(d){return No(this,void 0,void 0,function(){var l=this,c,p,u,m,y,h,g;return ko(this,function(e){switch(e.label){case 0:return!0!==d||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return e.sent(),c=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(c.toArray())];case 2:for(p=e.sent(),u=0,m=p;u<m.length;u++)y=m[u],this.remoteStore.listen(y);return[3,7];case 3:return!1!==d||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,h=[],g=Promise.resolve(),fn(this.queryViewsByTarget,function(o,t){l.sharedClientState.isLocalQueryTarget(o)?h.push(o):g=g.then(function(){return l.unlisten(t.query)}),l.remoteStore.unlisten(t.targetId)}),[4,g]);case 4:return e.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(h)];case 5:return e.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:e.sent(),e.label=7;case 7:return[2];}})})},e.prototype.resetLimboDocuments=function(){var o=this;fn(this.limboResolutionsByTarget,function(e){o.remoteStore.unlisten(e)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new br(dr.comparator)},e.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(d){for(var t=this,e=Promise.resolve(),l=[],a=[],s=function(s){e=e.then(function(){return No(t,void 0,void 0,function(){var o,d,c,p;return ko(this,function(e){switch(e.label){case 0:return(d=this.queryViewsByTarget[s])?[4,this.localStore.releaseQuery(d.query,!0)]:[3,4];case 1:return e.sent(),[4,this.localStore.allocateQuery(d.query)];case 2:return o=e.sent(),[4,this.synchronizeViewAndComputeSnapshot(d)];case 3:return(c=e.sent()).snapshot&&a.push(c.snapshot),[3,8];case 4:return dn(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(s)];case 5:return dn(!!(p=e.sent()),"Query data for target "+s+" not found"),[4,this.localStore.allocateQuery(p)];case 6:return o=e.sent(),[4,this.initializeViewAndComputeSnapshot(o,!1)];case 7:e.sent(),e.label=8;case 8:return l.push(o),[2];}})})})},r=0,c=d;r<c.length;r++)s(c[r]);return e.then(function(){return t.syncEngineListener.onWatchChange(a),l})},e.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},e.prototype.applyTargetState=function(a,r,o){return No(this,void 0,void 0,function(){var t=this,n;return ko(this,function(e){switch(e.label){case 0:if(this.isPrimary)return Ro(Ls,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[a])return[3,5];return"current"===r||"not-current"===r?[3,1]:"rejected"===r?[3,2]:[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(o){return No(t,void 0,void 0,function(){var n;return ko(this,function(e){switch(e.label){case 0:return n=Yi.createSynthesizedRemoteEventForCurrentChange(a,"current"===r),[4,this.emitNewSnapsAndNotifyLocalStore(o,n)];case 1:return e.sent(),[2];}})})},function(o){return No(t,void 0,void 0,function(){var r;return ko(this,function(a){switch(a.label){case 0:return(t=o).code!==bn.DATA_LOSS||t.message!==aa?[3,2]:(r=[],fn(this.queryViewsByTarget,function(e){return r.push(e)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(r)]);case 1:return a.sent(),[3,3];case 2:throw o;case 3:return[2];}var t})})})];case 2:return n=this.queryViewsByTarget[a],this.removeAndCleanupQuery(n),[4,this.localStore.releaseQuery(n.query,!0)];case 3:return e.sent(),this.syncEngineListener.onWatchError(n.query,o),[3,5];case 4:rn("Unexpected target state: "+r),e.label=5;case 5:return[2];}})})},e.prototype.applyActiveTargetsChange=function(d,l){return No(this,void 0,void 0,function(){var t=this,p,m,y,h,g,f,b,E,T;return ko(this,function(e){switch(e.label){case 0:if(!this.isPrimary)return[2];p=0,m=d,e.label=1;case 1:return p<m.length?(T=m[p],dn(!this.queryViewsByTarget[T],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(T)]):[3,6];case 2:return dn(!!(y=e.sent()),"Query data for active target "+T+" not found"),[4,this.localStore.allocateQuery(y)];case 3:return h=e.sent(),[4,this.initializeViewAndComputeSnapshot(h,!1)];case 4:e.sent(),this.remoteStore.listen(h),e.label=5;case 5:return p++,[3,1];case 6:g=function(o){var e;return ko(this,function(r){switch(r.label){case 0:return(e=f.queryViewsByTarget[o])?[4,f.localStore.releaseQuery(e.query,!1).then(function(){t.remoteStore.unlisten(o),t.removeAndCleanupQuery(e)}).catch(Va)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2];}})},f=this,b=0,E=l,e.label=7;case 7:return b<E.length?(T=E[b],[5,g(T)]):[3,10];case 8:e.sent(),e.label=9;case 9:return b++,[3,7];case 10:return[2];}})})},e.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},e.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},e.prototype.getRemoteKeysForTarget=function(o){var t=this.limboResolutionsByTarget[o];return t&&t.receivedDocument?Ai().add(t.key):this.queryViewsByTarget[o]?this.queryViewsByTarget[o].view.syncedDocuments:Ai()},e}(),Vs=function(){function e(e){this.uid=e}return e.prototype.isAuthenticated=function(){return null!=this.uid},e.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},e.prototype.isEqual=function(e){return e.uid===this.uid},e.UNAUTHENTICATED=new e(null),e.GOOGLE_CREDENTIALS=new e("google-credentials-uid"),e.FIRST_PARTY=new e("first-party-uid"),e}(),Bs="SharedClientState",Us="firestore_clients",Qs="firestore_mutations",Ks="firestore_targets",js=function(){function s(o,t,e,a){this.user=o,this.batchId=t,this.state=e,dn(void 0!==(this.error=a)==("rejected"===e),"MutationMetadata must contain an error iff state is 'rejected'")}return s.fromWebStorageEntry=function(a,t,e){var n=JSON.parse(e),r="object"==typeof n&&-1!==["pending","acknowledged","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),d;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(d=new En(n.error.code,n.error.message)),r?new s(a,t,n.state,d):(Ho(Bs,"Failed to parse mutation state for ID '"+t+"': "+e),null)},s.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},s}(),Ws=function(){function a(o,t,e){this.targetId=o,this.state=t,dn(void 0!==(this.error=e)==("rejected"===t),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return a.fromWebStorageEntry=function(o,t){var e=JSON.parse(t),n="object"==typeof e&&-1!==["not-current","current","rejected"].indexOf(e.state)&&(void 0===e.error||"object"==typeof e.error),s;return n&&e.error&&(n="string"==typeof e.error.message&&"string"==typeof e.error.code)&&(s=new En(e.error.code,e.error.message)),n?new a(o,e.state,s):(Ho(Bs,"Failed to parse target state for ID '"+o+"': "+t),null)},a.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},a}(),Gs=function(){function s(o,t){this.clientId=o,this.activeTargetIds=t}return s.fromWebStorageEntry=function(a,t){for(var e=JSON.parse(t),n="object"==typeof e&&e.activeTargetIds instanceof Array,d=ki(),l=0;n&&l<e.activeTargetIds.length;++l)n=jr(e.activeTargetIds[l]),d=d.add(e.activeTargetIds[l]);return n?new s(a,d):(Ho(Bs,"Failed to parse client data for instance '"+a+"': "+t),null)},s}(),zs=function(){function o(o,t){this.clientId=o,this.onlineState=t}return o.fromWebStorageEntry=function(r){var t=JSON.parse(r);return"object"==typeof t&&void 0!==Cs[t.onlineState]&&"string"==typeof t.clientId?new o(t.clientId,Cs[t.onlineState]):(Ho(Bs,"Failed to parse online state: "+r),null)},o}(),Hs=function(){function e(){this.activeTargetIds=ki()}return e.prototype.addQueryTarget=function(e){dn(!this.activeTargetIds.has(e),"Target with ID '"+e+"' already active."),this.activeTargetIds=this.activeTargetIds.add(e)},e.prototype.removeQueryTarget=function(e){this.activeTargetIds=this.activeTargetIds.delete(e)},e.prototype.toWebStorageJSON=function(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)},e}(),Ys=function(){function s(a,t,e,n,r){if(this.queue=a,this.platform=t,this.persistenceKey=e,this.localClientId=n,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!s.isAvailable(this.platform))throw new En(bn.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var i=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=r,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+e,this.activeClients[this.localClientId]=new Hs,this.clientStateKeyRe=new RegExp("^"+Us+"_"+i+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Qs+"_"+i+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+Ks+"_"+i+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+e,this.platform.window.addEventListener("storage",this.storageListener)}return s.isAvailable=function(e){return e.window&&null!=e.window.localStorage},s.prototype.start=function(){return No(this,void 0,void 0,function(){var t=this,d,p,m,y,g,f,b,E,T,S,I;return ko(this,function(e){switch(e.label){case 0:return dn(!this.started,"WebStorageSharedClientState already started"),dn(null!==this.syncEngine,"syncEngine property must be set before calling start()"),dn(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(d=e.sent(),p=0,m=d;p<m.length;p++)(y=m[p])!==this.localClientId&&(g=this.getItem(this.toWebStorageClientStateKey(y)))&&(f=Gs.fromWebStorageEntry(y,g))&&(this.activeClients[f.clientId]=f);for(this.persistClientState(),(b=this.storage.getItem(this.onlineStateKey))&&(E=this.fromWebStorageOnlineState(b))&&this.handleOnlineStateEvent(E),T=0,S=this.earlyEvents;T<S.length;T++)I=S[T],this.handleWebStorageEvent(I);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return t.shutdown()}),this.started=!0,[2];}})})},s.prototype.writeSequenceNumber=function(e){this.setItem(this.sequenceNumberKey,JSON.stringify(e))},s.prototype.getAllActiveQueryTargets=function(){var o=ki();return Tn(this.activeClients,function(r,t){o=o.unionWith(t.activeTargetIds)}),o},s.prototype.isActiveQueryTarget=function(o){for(var t in this.activeClients)if(this.activeClients.hasOwnProperty(t)&&this.activeClients[t].activeTargetIds.has(o))return!0;return!1},s.prototype.addPendingMutation=function(e){this.persistMutationState(e,"pending")},s.prototype.updateMutationState=function(o,t,e){this.persistMutationState(o,t,e),this.removeMutationState(o)},s.prototype.addLocalQueryTarget=function(o){var t="not-current";if(this.isActiveQueryTarget(o)){var a=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(o));if(a){var n=Ws.fromWebStorageEntry(o,a);n&&(t=n.state)}}return this.localClientState.addQueryTarget(o),this.persistClientState(),t},s.prototype.removeLocalQueryTarget=function(e){this.localClientState.removeQueryTarget(e),this.persistClientState()},s.prototype.isLocalQueryTarget=function(e){return this.localClientState.activeTargetIds.has(e)},s.prototype.clearQueryState=function(e){this.removeItem(this.toWebStorageQueryTargetMetadataKey(e))},s.prototype.updateQueryState=function(o,t,e){this.persistQueryTargetState(o,t,e)},s.prototype.handleUserChange=function(o,t,e){var a=this;t.forEach(function(e){a.removeMutationState(e)}),this.currentUser=o,e.forEach(function(e){a.addPendingMutation(e)})},s.prototype.setOnlineState=function(e){this.persistOnlineState(e)},s.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},s.prototype.getItem=function(o){var t=this.storage.getItem(o);return Ro(Bs,"READ",o,t),t},s.prototype.setItem=function(o,t){Ro(Bs,"SET",o,t),this.storage.setItem(o,t)},s.prototype.removeItem=function(e){Ro(Bs,"REMOVE",e),this.storage.removeItem(e)},s.prototype.handleWebStorageEvent=function(d){var e=this;if(d.storageArea===this.storage){if(Ro(Bs,"EVENT",d.key,d.newValue),d.key===this.localClientStorageKey)return void Ho("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return No(e,void 0,void 0,function(){var t,s,l,c,p,u;return ko(this,function(){if(!this.started)return this.earlyEvents.push(d),[2];if(null===d.key)return[2];if(this.clientStateKeyRe.test(d.key)){if(null==d.newValue)return s=this.fromWebStorageClientStateKey(d.key),[2,this.handleClientStateEvent(s,null)];if(t=this.fromWebStorageClientState(d.key,d.newValue))return[2,this.handleClientStateEvent(t.clientId,t)]}else if(this.mutationBatchKeyRe.test(d.key)){if(null!==d.newValue&&(l=this.fromWebStorageMutationMetadata(d.key,d.newValue)))return[2,this.handleMutationBatchEvent(l)];}else if(this.queryTargetKeyRe.test(d.key)){if(null!==d.newValue&&(c=this.fromWebStorageQueryTargetMetadata(d.key,d.newValue)))return[2,this.handleQueryTargetEvent(c)];}else if(d.key!==this.onlineStateKey)d.key===this.sequenceNumberKey&&(dn(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(u=function(o){var t=Wd.INVALID;if(null!=o)try{var r=JSON.parse(o);dn("number"==typeof r,"Found non-numeric sequence number"),t=r}catch(e){Ho(Bs,"Failed to read sequence number from WebStorage",e)}return t}(d.newValue))!==Wd.INVALID&&this.sequenceNumberHandler(u));else if(null!==d.newValue&&(p=this.fromWebStorageOnlineState(d.newValue)))return[2,this.handleOnlineStateEvent(p)];return[2]})})})}},Object.defineProperty(s.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),s.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},s.prototype.persistMutationState=function(o,t,e){var a=new js(this.currentUser,o,t,e),r=this.toWebStorageMutationBatchKey(o);this.setItem(r,a.toWebStorageJSON())},s.prototype.removeMutationState=function(o){var t=this.toWebStorageMutationBatchKey(o);this.removeItem(t)},s.prototype.persistOnlineState=function(o){var t={clientId:this.localClientId,onlineState:Cs[o]};this.storage.setItem(this.onlineStateKey,JSON.stringify(t))},s.prototype.persistQueryTargetState=function(o,t,e){var a=this.toWebStorageQueryTargetMetadataKey(o),r=new Ws(o,t,e);this.setItem(a,r.toWebStorageJSON())},s.prototype.toWebStorageClientStateKey=function(e){return dn(-1===e.indexOf("_"),"Client key cannot contain '_', but was '"+e+"'"),Us+"_"+this.persistenceKey+"_"+e},s.prototype.toWebStorageQueryTargetMetadataKey=function(e){return Ks+"_"+this.persistenceKey+"_"+e},s.prototype.toWebStorageMutationBatchKey=function(o){var t=Qs+"_"+this.persistenceKey+"_"+o;return this.currentUser.isAuthenticated()&&(t+="_"+this.currentUser.uid),t},s.prototype.fromWebStorageClientStateKey=function(o){var t=this.clientStateKeyRe.exec(o);return t?t[1]:null},s.prototype.fromWebStorageClientState=function(o,t){var e=this.fromWebStorageClientStateKey(o);return dn(null!==e,"Cannot parse client state key '"+o+"'"),Gs.fromWebStorageEntry(e,t)},s.prototype.fromWebStorageMutationMetadata=function(o,t){var e=this.mutationBatchKeyRe.exec(o);dn(null!==e,"Cannot parse mutation batch key '"+o+"'");var a=+e[1],r=void 0===e[2]?null:e[2];return js.fromWebStorageEntry(new Vs(r),a,t)},s.prototype.fromWebStorageQueryTargetMetadata=function(o,t){var e=this.queryTargetKeyRe.exec(o);dn(null!==e,"Cannot parse query target key '"+o+"'");var a=+e[1];return Ws.fromWebStorageEntry(a,t)},s.prototype.fromWebStorageOnlineState=function(e){return zs.fromWebStorageEntry(e)},s.prototype.handleMutationBatchEvent=function(t){return No(this,void 0,void 0,function(){return ko(this,function(){return t.user.uid===this.currentUser.uid?[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]:(Ro(Bs,"Ignoring mutation for non-active user "+t.user.uid),[2])})})},s.prototype.handleQueryTargetEvent=function(e){return this.syncEngine.applyTargetState(e.targetId,e.state,e.error)},s.prototype.handleClientStateEvent=function(s,t){var d=this,n=this.getAllActiveQueryTargets();t?this.activeClients[s]=t:delete this.activeClients[s];var r=this.getAllActiveQueryTargets(),i=[],o=[];return r.forEach(function(t){return No(d,void 0,void 0,function(){return ko(this,function(){return n.has(t)||i.push(t),[2]})})}),n.forEach(function(t){return No(d,void 0,void 0,function(){return ko(this,function(){return r.has(t)||o.push(t),[2]})})}),this.syncEngine.applyActiveTargetsChange(i,o)},s.prototype.handleOnlineStateEvent=function(e){this.activeClients[e.clientId]&&this.onlineStateHandler(e.onlineState)},s}(),Xs=function(){function e(){this.localState=new Hs,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return e.prototype.addPendingMutation=function(){},e.prototype.updateMutationState=function(){},e.prototype.addLocalQueryTarget=function(e){return this.localState.addQueryTarget(e),this.queryState[e]||"not-current"},e.prototype.updateQueryState=function(o,t){this.queryState[o]=t},e.prototype.removeLocalQueryTarget=function(e){this.localState.removeQueryTarget(e)},e.prototype.isLocalQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},e.prototype.clearQueryState=function(e){delete this.queryState[e]},e.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},e.prototype.isActiveQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},e.prototype.start=function(){return this.localState=new Hs,Promise.resolve()},e.prototype.handleUserChange=function(){},e.prototype.setOnlineState=function(){},e.prototype.shutdown=function(){},e.prototype.writeSequenceNumber=function(){},e}(),Js="FirestoreClient",$s=function(){function e(o,t){this.cacheSizeBytes=o,this.experimentalTabSynchronization=t}return e.prototype.lruParams=function(){return Ua.withCacheSize(this.cacheSizeBytes)},e}(),Zs=function(){},tl=function(){function e(o,t,e,a){this.platform=o,this.databaseInfo=t,this.credentials=e,this.asyncQueue=a,this.clientId=Sn.newId()}return e.prototype.start=function(a){var s=this,t=new To,r=new To,n=!1;return this.credentials.setChangeListener(function(o){n?s.asyncQueue.enqueueAndForget(function(){return s.handleCredentialChange(o)}):(n=!0,s.initializePersistence(a,r,o).then(function(e){return s.initializeRest(o,e)}).then(t.resolve,t.reject))}),this.asyncQueue.enqueueAndForget(function(){return t.promise}),r.promise},e.prototype.enableNetwork=function(){var e=this;return this.asyncQueue.enqueue(function(){return e.syncEngine.enableNetwork()})},e.prototype.initializePersistence=function(o,a,e){var n=this;return o instanceof $s?this.startIndexedDbPersistence(e,o).then(function(e){return a.resolve(),e}).catch(function(e){if(a.reject(e),!n.canFallback(e))throw e;return console.warn("Error enabling offline storage. Falling back to storage disabled: "+e),n.startMemoryPersistence()}):(a.resolve(),this.startMemoryPersistence())},e.prototype.canFallback=function(e){return e instanceof En?e.code===bn.FAILED_PRECONDITION||e.code===bn.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code},e.prototype.startIndexedDbPersistence=function(s,r){var e=this,i=Ha.buildStoragePrefix(this.databaseInfo),o=new co(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return No(e,void 0,void 0,function(){var a,d;return ko(this,function(e){switch(e.label){case 0:if(r.experimentalTabSynchronization&&!Ys.isAvailable(this.platform))throw new En(bn.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return d=r.lruParams(),r.experimentalTabSynchronization?(this.sharedClientState=new Ys(this.asyncQueue,this.platform,i,this.clientId,s),[4,Ha.createMultiClientIndexedDbPersistence(i,this.clientId,this.platform,this.asyncQueue,o,d,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return a=e.sent(),[3,4];case 2:return this.sharedClientState=new Xs,[4,Ha.createIndexedDbPersistence(i,this.clientId,this.platform,this.asyncQueue,o,d)];case 3:a=e.sent(),e.label=4;case 4:return[2,(this.persistence=a).referenceDelegate.garbageCollector];}})})})},e.prototype.startMemoryPersistence=function(){return this.persistence=hs.createEagerPersistence(this.clientId),this.sharedClientState=new Xs,Promise.resolve(null)},e.prototype.initializeRest=function(d,s){var e=this;return Ro(Js,"Initializing. user=",d.uid),this.platform.loadConnection(this.databaseInfo).then(function(l){return No(e,void 0,void 0,function(){var a=this,o,c,p,u;return ko(this,function(e){switch(e.label){case 0:return this.localStore=new rs(this.persistence,d),s&&(this.lruScheduler=new Qa(s,this.asyncQueue,this.localStore)),o=this.platform.newSerializer(this.databaseInfo.databaseId),c=new Ts(this.asyncQueue,l,this.credentials,o),p=function(e){return a.syncEngine.applyOnlineStateChange(e,Zd.RemoteStore)},u=function(e){return a.syncEngine.applyOnlineStateChange(e,Zd.SharedClientState)},this.remoteStore=new Ds(this.localStore,c,this.asyncQueue,p),this.syncEngine=new Fs(this.localStore,this.remoteStore,this.sharedClientState,d),this.sharedClientState.onlineStateHandler=u,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new ks(this.syncEngine),[4,this.sharedClientState.start()];case 1:return e.sent(),[4,this.remoteStore.start()];case 2:return e.sent(),[4,this.persistence.setPrimaryStateListener(function(o){return No(a,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return[4,this.syncEngine.applyPrimaryState(o)];case 1:return e.sent(),this.lruScheduler&&(o&&!this.lruScheduler.started?this.lruScheduler.start():o||this.lruScheduler.stop()),[2];}})})})];case 3:return e.sent(),[2];}})})})},e.prototype.handleCredentialChange=function(e){return this.asyncQueue.verifyOperationInProgress(),Ro(Js,"Credential Changed. Current user: "+e.uid),this.syncEngine.handleCredentialChange(e)},e.prototype.disableNetwork=function(){var e=this;return this.asyncQueue.enqueue(function(){return e.syncEngine.disableNetwork()})},e.prototype.shutdown=function(o){var e=this;return this.asyncQueue.enqueue(function(){return No(e,void 0,void 0,function(){return ko(this,function(e){switch(e.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return e.sent(),[4,this.sharedClientState.shutdown()];case 2:return e.sent(),[4,this.persistence.shutdown(o&&o.purgePersistenceWithDataLoss)];case 3:return e.sent(),this.credentials.removeChangeListener(),[2];}})})})},e.prototype.listen=function(o,t,e){var a=this,r=new Rs(o,t,e);return this.asyncQueue.enqueueAndForget(function(){return a.eventMgr.listen(r)}),r},e.prototype.unlisten=function(o){var t=this;this.asyncQueue.enqueueAndForget(function(){return t.eventMgr.unlisten(o)})},e.prototype.getDocumentFromLocalCache=function(o){var t=this;return this.asyncQueue.enqueue(function(){return t.localStore.readDocument(o)}).then(function(e){if(e instanceof yr)return e;if(e instanceof gr)return null;throw new En(bn.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},e.prototype.getDocumentsFromLocalCache=function(o){var e=this;return this.asyncQueue.enqueue(function(){return e.localStore.executeQuery(o)}).then(function(a){var t=Ai(),e=new Ps(o,t),n=e.computeDocChanges(a);return e.applyChanges(n,!1).snapshot})},e.prototype.write=function(o){var t=this,e=new To;return this.asyncQueue.enqueueAndForget(function(){return t.syncEngine.write(o,e)}),e.promise},e.prototype.databaseId=function(){return this.databaseInfo.databaseId},e.prototype.transaction=function(o){var t=this;return this.asyncQueue.enqueue(function(){return No(t,void 0,void 0,function(){return ko(this,function(){return[2]})})}).then(function(){return t.syncEngine.runTransaction(o)})},e}(),ol=function(){function e(e){this.observer=e,this.muted=!1}return e.prototype.next=function(e){this.scheduleEvent(this.observer.next,e)},e.prototype.error=function(e){this.scheduleEvent(this.observer.error,e)},e.prototype.mute=function(){this.muted=!0},e.prototype.scheduleEvent=function(o,t){var e=this;this.muted||setTimeout(function(){e.muted||o(t)},0)},e}(),rl=function(){function o(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];!function(o,t,e,a){if(!(t instanceof Array)||t.length<a)throw new En(bn.INVALID_ARGUMENT,"Function "+o+"() requires its "+e+" argument to be an array with at least "+Bn(a,"element")+".")}("FieldPath",o,"fieldNames",1);for(var r=0;r<o.length;++r)if(Nn("FieldPath","string",r,o[r]),0===o[r].length)throw new En(bn.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new pr(o)}return o.documentId=function(){return o._DOCUMENT_ID},o.prototype.isEqual=function(e){if(!(e instanceof o))throw Fn("isEqual","FieldPath",1,e);return this._internalPath.isEqual(e._internalPath)},o._DOCUMENT_ID=new o(pr.keyField().canonicalString()),o}(),al=/[~\*\/\[\]]/,nl=function(o,t){this.user=t,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+o}},il=function(){function e(){this.changeListener=null}return e.prototype.getToken=function(){return Promise.resolve(null)},e.prototype.invalidateToken=function(){},e.prototype.setChangeListener=function(e){dn(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=e)(Vs.UNAUTHENTICATED)},e.prototype.removeChangeListener=function(){dn(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},e}(),sl=function(){function e(o){var t=this;this.app=o,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){t.tokenCounter++,t.currentUser=t.getUser(),t.changeListener&&t.changeListener(t.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return e.prototype.getToken=function(){var o=this;dn(null!=this.tokenListener,"getToken cannot be called after listener removed.");var e=this.tokenCounter,r=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(r).then(function(r){if(o.tokenCounter!==e)throw new En(bn.ABORTED,"getToken aborted due to token change.");return r?(dn("string"==typeof r.accessToken,"Invalid tokenData returned from getToken():"+r),new nl(r.accessToken,o.currentUser)):null})},e.prototype.invalidateToken=function(){this.forceRefresh=!0},e.prototype.setChangeListener=function(e){dn(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=e,this.currentUser&&e(this.currentUser)},e.prototype.removeChangeListener=function(){dn(null!=this.tokenListener,"removeChangeListener() called twice"),dn(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},e.prototype.getUser=function(){var e=this.app.INTERNAL.getUid();return dn(null===e||"string"==typeof e,"Received invalid UID: "+e),new Vs(e)},e}(),dl=function(){function e(o,t){this.gapi=o,this.sessionIndex=t,this.type="FirstParty",this.user=Vs.FIRST_PARTY,dn(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return Object.defineProperty(e.prototype,"authHeaders",{get:function(){return{Authorization:this.gapi.auth.getAuthHeaderValueForFirstParty([]),"X-Goog-AuthUser":this.sessionIndex}},enumerable:!0,configurable:!0}),e}(),ll=function(){function e(o,t){this.gapi=o,this.sessionIndex=t,dn(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return e.prototype.getToken=function(){return Promise.resolve(new dl(this.gapi,this.sessionIndex))},e.prototype.setChangeListener=function(e){e(Vs.FIRST_PARTY)},e.prototype.removeChangeListener=function(){},e.prototype.invalidateToken=function(){},e}(),cl=function(){function e(e){this._methodName=e}return e.delete=function(){return Cn("FieldValue.delete",arguments),pl.instance},e.serverTimestamp=function(){return Cn("FieldValue.serverTimestamp",arguments),ul.instance},e.arrayUnion=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return vn("FieldValue.arrayUnion",arguments,1),new ml(o)},e.arrayRemove=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return vn("FieldValue.arrayRemove",arguments,1),new yl(o)},e.increment=function(e){return Nn("FieldValue.increment","number",1,e),Dn("FieldValue.increment",arguments,1),new hl(e)},e.prototype.isEqual=function(e){return this===e},e}(),pl=function(o){function t(){return o.call(this,"FieldValue.delete")||this}return Ao(t,o),t.instance=new t,t}(cl),ul=function(o){function t(){return o.call(this,"FieldValue.serverTimestamp")||this}return Ao(t,o),t.instance=new t,t}(cl),ml=function(o){function e(r){var t=o.call(this,"FieldValue.arrayUnion")||this;return t._elements=r,t}return Ao(e,o),e}(cl),yl=function(o){function e(r){var t=o.call(this,"FieldValue.arrayRemove")||this;return t._elements=r,t}return Ao(e,o),e}(cl),hl=function(o){function e(r){var t=o.call(this,"FieldValue.increment")||this;return t._operand=r,t}return Ao(e,o),e}(cl),gl=mn(cl,"Use FieldValue.<field>() instead."),fl=/^__.*__$/,bl=function(){function e(o,t,e){this.data=o,this.fieldMask=t,this.fieldTransforms=e}return e.prototype.toMutations=function(o,t){var e=[];return null===this.fieldMask?e.push(new mi(o,this.data,t)):e.push(new yi(o,this.data,this.fieldMask,t)),0<this.fieldTransforms.length&&e.push(new gi(o,this.fieldTransforms)),e},e}(),El=function(){function e(o,t,e){this.data=o,this.fieldMask=t,this.fieldTransforms=e}return e.prototype.toMutations=function(o,t){var e=[new yi(o,this.data,this.fieldMask,t)];return 0<this.fieldTransforms.length&&e.push(new gi(o,this.fieldTransforms)),e},e}(),Tl,Sl;(Sl=Tl||(Tl={}))[Sl.Set=0]="Set",Sl[Sl.Update=1]="Update",Sl[Sl.MergeSet=2]="MergeSet",Sl[Sl.Argument=3]="Argument";var Il=function(){function o(a,t,e,n,r,i){this.dataSource=a,this.methodName=t,this.path=e,this.arrayElement=n,void 0===r&&this.validatePath(),this.arrayElement=void 0!==n&&n,this.fieldTransforms=r||[],this.fieldMask=i||[]}return o.prototype.childContextForField=function(r){var t=null==this.path?null:this.path.child(r),e=new o(this.dataSource,this.methodName,t,!1,this.fieldTransforms,this.fieldMask);return e.validatePathSegment(r),e},o.prototype.childContextForFieldPath=function(r){var t=null==this.path?null:this.path.child(r),e=new o(this.dataSource,this.methodName,t,!1,this.fieldTransforms,this.fieldMask);return e.validatePath(),e},o.prototype.childContextForArray=function(){return new o(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},o.prototype.createError=function(o){var t=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new En(bn.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+o+t)},o.prototype.contains=function(o){return void 0!==this.fieldMask.find(function(e){return o.isPrefixOf(e)})||void 0!==this.fieldTransforms.find(function(e){return o.isPrefixOf(e.field)})},o.prototype.validatePath=function(){if(null!==this.path)for(var e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))},o.prototype.validatePathSegment=function(e){if(Pi(this.dataSource)&&fl.test(e))throw this.createError("Document fields cannot begin and end with __")},o}(),Cl=function(o,t){this.databaseId=o,this.key=t},Dl=function(){function e(e){this.preConverter=e}return e.prototype.parseSetData=function(o,t){var e=new Il(Tl.Set,o,pr.EMPTY_PATH);Fi("Data must be an object, but it was:",e,t);var a=this.parseData(t,e);return new bl(a,null,e.fieldTransforms)},e.prototype.parseMergeData=function(d,t,e){var n=new Il(Tl.MergeSet,d,pr.EMPTY_PATH);Fi("Data must be an object, but it was:",n,t);var r=this.parseData(t,n),a,p;if(e){for(var m=new ui(pr.comparator),y=0,g=e;y<g.length;y++){var c=g[y],h=void 0;if(c instanceof rl)h=c._internalPath;else{if("string"!=typeof c)throw rn("Expected stringOrFieldPath to be a string or a FieldPath");h=ts(d,c)}if(!n.contains(h))throw new En(bn.INVALID_ARGUMENT,"Field '"+h+"' is specified in your field mask but missing from your input data.");m=m.add(h)}a=hi.fromSet(m),p=n.fieldTransforms.filter(function(e){return a.covers(e.field)})}else a=hi.fromArray(n.fieldMask),p=n.fieldTransforms;return new bl(r,a,p)},e.prototype.parseUpdateData=function(d,o){var l=this,a=new Il(Tl.Update,d,pr.EMPTY_PATH);Fi("Data must be an object, but it was:",a,o);var s=new ui(pr.comparator),t=qr.EMPTY;Tn(o,function(o,c){var p=ts(d,o),n=a.childContextForFieldPath(p);if((c=l.runPreConverter(c,n))instanceof pl)s=s.add(p);else{var r=l.parseData(c,n);null!=r&&(s=s.add(p),t=t.set(p,r))}});var r=hi.fromSet(s);return new El(t,r,a.fieldTransforms)},e.prototype.parseUpdateVarargs=function(m,t,e,n){var r=new Il(Tl.Update,m,pr.EMPTY_PATH),i=[Bi(m,t)],o=[e];if(0!=n.length%2)throw new En(bn.INVALID_ARGUMENT,"Function "+m+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var a=0;a<n.length;a+=2)i.push(Bi(m,n[a])),o.push(n[a+1]);var y=new ui(pr.comparator),g=qr.EMPTY;for(a=0;a<i.length;++a){var b=i[a],h=r.childContextForFieldPath(b),l=this.runPreConverter(o[a],h);if(l instanceof pl)y=y.add(b);else{var f=this.parseData(l,h);null!=f&&(y=y.add(b),g=g.set(b,f))}}var p=hi.fromSet(y);return new El(g,p,r.fieldTransforms)},e.prototype.parseQueryValue=function(o,t){var e=new Il(Tl.Argument,o,pr.EMPTY_PATH),a=this.parseData(t,e);return dn(null!=a,"Parsed data should not be null."),dn(0===e.fieldTransforms.length,"Field transforms should have been disallowed."),a},e.prototype.runPreConverter=function(o,r){try{return this.preConverter(o)}catch(o){var e=Ns(o);throw r.createError(e)}},e.prototype.parseData=function(o,r){if(xi(o=this.runPreConverter(o,r)))return Fi("Unsupported field value:",r,o),this.parseObject(o,r);if(o instanceof cl)return this.parseSentinelFieldValue(o,r),null;if(r.path&&r.fieldMask.push(r.path),o instanceof Array){if(r.arrayElement)throw r.createError("Nested arrays are not supported");return this.parseArray(o,r)}return this.parseScalarValue(o,r)},e.prototype.parseObject=function(e,a){var r=this,i=new br(Un);return In(e)?a.path&&0<a.path.length&&a.fieldMask.push(a.path):Tn(e,function(o,t){var e=r.parseData(t,a.childContextForField(o));null!=e&&(i=i.insert(o,e))}),new qr(i)},e.prototype.parseArray=function(d,t){for(var e=[],n=0,l=0,c=d;l<c.length;l++){var o=c[l],a=this.parseData(o,t.childContextForArray(n));null==a&&(a=Cr.INSTANCE),e.push(a),n++}return new Fr(e)},e.prototype.parseSentinelFieldValue=function(s,t){if(!Pi(t.dataSource))throw t.createError(s._methodName+"() can only be used with update() and set()");if(null===t.path)throw t.createError(s._methodName+"() is not currently supported inside arrays");if(s instanceof pl){if(t.dataSource!==Tl.MergeSet)throw t.dataSource===Tl.Update?(dn(0<t.path.length,"FieldValue.delete() at the top level should have already been handled."),t.createError("FieldValue.delete() can only appear at the top level of your update data")):t.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");t.fieldMask.push(t.path)}else if(s instanceof ul)t.fieldTransforms.push(new li(t.path,bi.instance));else if(s instanceof ml){var e=this.parseArrayTransformElements(s._methodName,s._elements),d=new wi(e);t.fieldTransforms.push(new li(t.path,d))}else if(s instanceof yl){e=this.parseArrayTransformElements(s._methodName,s._elements);var r=new Ei(e);t.fieldTransforms.push(new li(t.path,r))}else if(s instanceof hl){var i=this.parseQueryValue("FieldValue.increment",s._operand),o=new Si(i);t.fieldTransforms.push(new li(t.path,o))}else rn("Unknown FieldValue type: "+s)},e.prototype.parseScalarValue=function(o,t){if(null===o)return Cr.INSTANCE;if("number"==typeof o)return jr(o)?new Ar(o):new Rr(o);if("boolean"==typeof o)return Dr.of(o);if("string"==typeof o)return new Mr(o);if(o instanceof Date)return new _r(or.fromDate(o));if(o instanceof or)return new _r(new or(o.seconds,1e3*dd(o.nanoseconds/1e3)));if(o instanceof ir)return new xr(o);if(o instanceof zn)return new Pr(o);if(o instanceof Cl)return new Lr(o.databaseId,o.key);throw t.createError("Unsupported field value: "+On(o))},e.prototype.parseArrayTransformElements=function(o,e){var r=this;return e.map(function(a,t){var e=new Il(Tl.Argument,o,pr.EMPTY_PATH);return r.parseData(a,e.childContextForArray(t))})},e}(),vl=Ua.COLLECTION_DISABLED,Al=function(){function e(e){if(void 0===e.host){if(void 0!==e.ssl)throw new En(bn.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else wn("settings","non-empty string","host",e.host),this.host=e.host,Rn("settings","boolean","ssl",e.ssl),this.ssl=gn(e.ssl,!0);if(qn("settings",e,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes"]),Rn("settings","object","credentials",e.credentials),this.credentials=e.credentials,Rn("settings","boolean","timestampsInSnapshots",e.timestampsInSnapshots),!0===e.timestampsInSnapshots?Ho("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===e.timestampsInSnapshots&&Ho("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=gn(e.timestampsInSnapshots,!0),Rn("settings","number","cacheSizeBytes",e.cacheSizeBytes),void 0===e.cacheSizeBytes)this.cacheSizeBytes=Ua.DEFAULT_CACHE_SIZE_BYTES;else{if(e.cacheSizeBytes!==vl&&e.cacheSizeBytes<Ua.MINIMUM_CACHE_SIZE_BYTES)throw new En(bn.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+Ua.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=e.cacheSizeBytes}}return e.prototype.isEqual=function(e){return this.host===e.host&&this.ssl===e.ssl&&this.timestampsInSnapshots===e.timestampsInSnapshots&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes},e}(),Nl=function(){},kl=function(){function a(o){var t=this;this._queue=new Co,this.INTERNAL={delete:function(o){return No(t,void 0,void 0,function(){return ko(this,function(){return this._firestoreClient?[2,this._firestoreClient.shutdown(o)]:[2]})})}};var n=new Nl;if("object"==typeof o.options){var e=o;n.firebaseApp=e,n.databaseId=a.databaseIdFromApp(e),n.persistenceKey=n.firebaseApp.name,n.credentials=new sl(e)}else{var r=o;if(!r.projectId)throw new En(bn.INVALID_ARGUMENT,"Must provide projectId");n.databaseId=new ur(r.projectId,r.database),n.persistenceKey="[DEFAULT]",n.credentials=new il}n.settings=new Al({}),this._config=n,this._databaseId=n.databaseId}return a.prototype.settings=function(o){if(Dn("Firestore.settings",arguments,1),Nn("Firestore.settings","object",1,o),yn(o,"persistence"))throw new En(bn.INVALID_ARGUMENT,"\"persistence\" is now specified with a separate call to firestore.enablePersistence().");var t=new Al(o);if(this._firestoreClient&&!this._config.settings.isEqual(t))throw new En(bn.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._config.settings=t).credentials&&(this._config.credentials=function(e){if(!e)return new il;switch(e.type){case"gapi":return new ll(e.client,e.sessionIndex||"0");case"provider":return e.client;default:throw new En(bn.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type");}}(t.credentials))},a.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},a.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},a.prototype.enablePersistence=function(e){if(this._firestoreClient)throw new En(bn.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(new $s(this._config.settings.cacheSizeBytes,void 0!==e&&gn(e.experimentalTabSynchronization,!1)))},a.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Zs),this._firestoreClient},a.prototype.configureClient=function(o){var a=this;dn(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),dn(!this._firestoreClient,"configureClient() called multiple times");var t=new ar(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl);return this._dataConverter=new Dl(function(o){if(o instanceof Ml){var t=a._config.databaseId,e=o.firestore._config.databaseId;if(!e.isEqual(t))throw new En(bn.INVALID_ARGUMENT,"Document reference is for database "+e.projectId+"/"+e.database+" but should be for database "+t.projectId+"/"+t.database);return new Cl(a._config.databaseId,o._key)}return o}),this._firestoreClient=new tl(Ad.getPlatform(),t,this._config.credentials,this._queue),this._firestoreClient.start(o)},a.databaseIdFromApp=function(o){var t=o.options;if(!yn(t,"projectId"))throw new En(bn.INVALID_ARGUMENT,"\"projectId\" not provided in firebase.initializeApp.");var e=t.projectId;if(!e||"string"!=typeof e)throw new En(bn.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new ur(e)},Object.defineProperty(a.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new En(bn.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),a.prototype.collection=function(e){return Dn("Firestore.collection",arguments,1),Nn("Firestore.collection","non-empty string",1,e),this.ensureClientConfigured(),new ql(lr.fromString(e),this)},a.prototype.doc=function(e){return Dn("Firestore.doc",arguments,1),Nn("Firestore.doc","non-empty string",1,e),this.ensureClientConfigured(),Ml.forPath(lr.fromString(e),this)},a.prototype._collectionGroup=function(e){if(Dn("Firestore.collectionGroup",arguments,1),Nn("Firestore.collectionGroup","non-empty string",1,e),0<=e.indexOf("/"))throw new En(bn.INVALID_ARGUMENT,"Invalid collection ID '"+e+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new Ol(new Kr(lr.EMPTY_PATH,e),this)},a.prototype.runTransaction=function(o){var e=this;return Dn("Firestore.runTransaction",arguments,1),Nn("Firestore.runTransaction","function",1,o),this.ensureClientConfigured().transaction(function(r){return o(new wl(e,r))})},a.prototype.batch=function(){return this.ensureClientConfigured(),new Rl(this)},Object.defineProperty(a,"logLevel",{get:function(){switch(Ye()){case ln.DEBUG:return"debug";case ln.ERROR:return"error";case ln.SILENT:return"silent";default:return rn("Unknown log level: "+Ye());}},enumerable:!0,configurable:!0}),a.setLogLevel=function(e){switch(Dn("Firestore.setLogLevel",arguments,1),Nn("Firestore.setLogLevel","non-empty string",1,e),e){case"debug":$t(ln.DEBUG);break;case"error":$t(ln.ERROR);break;case"silent":$t(ln.SILENT);break;default:throw new En(bn.INVALID_ARGUMENT,"Invalid log level: "+e);}},a.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},a}(),wl=function(){function e(o,t){this._firestore=o,this._transaction=t}return e.prototype.get=function(e){var o=this;Dn("Transaction.get",arguments,1);var a=rd("Transaction.get",e,this._firestore);return this._transaction.lookup([a._key]).then(function(r){if(!r||1!==r.length)return rn("Mismatch in docs returned from document lookup.");var t=r[0];if(t instanceof gr)return new Pl(o._firestore,a._key,null,!1,!1);if(t instanceof yr)return new Pl(o._firestore,a._key,t,!1,!1);throw rn("BatchGetDocumentsRequest returned unexpected document type: "+t.constructor.name)})},e.prototype.set=function(o,t,e){An("Transaction.set",arguments,2,3);var a=rd("Transaction.set",o,this._firestore),r=(e=ed("Transaction.set",e)).merge||e.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",t,e.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",t);return this._transaction.set(a._key,r),this},e.prototype.update=function(s,t,e){for(var n=[],o=3,d,l;o<arguments.length;o++)n[o-3]=arguments[o];return l="string"==typeof t||t instanceof rl?(vn("Transaction.update",arguments,3),d=rd("Transaction.update",s,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",t,e,n)):(Dn("Transaction.update",arguments,2),d=rd("Transaction.update",s,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",t)),this._transaction.update(d._key,l),this},e.prototype.delete=function(o){Dn("Transaction.delete",arguments,1);var t=rd("Transaction.delete",o,this._firestore);return this._transaction.delete(t._key),this},e}(),Rl=function(){function e(e){this._firestore=e,this._mutations=[],this._committed=!1}return e.prototype.set=function(o,t,e){An("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var a=rd("WriteBatch.set",o,this._firestore),r=(e=ed("WriteBatch.set",e)).merge||e.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",t,e.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",t);return this._mutations=this._mutations.concat(r.toMutations(a._key,Ld.NONE)),this},e.prototype.update=function(s,t,e){for(var n=[],o=3,d,l;o<arguments.length;o++)n[o-3]=arguments[o];return this.verifyNotCommitted(),l="string"==typeof t||t instanceof rl?(vn("WriteBatch.update",arguments,3),d=rd("WriteBatch.update",s,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",t,e,n)):(Dn("WriteBatch.update",arguments,2),d=rd("WriteBatch.update",s,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",t)),this._mutations=this._mutations.concat(l.toMutations(d._key,Ld.exists(!0))),this},e.prototype.delete=function(o){Dn("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var t=rd("WriteBatch.delete",o,this._firestore);return this._mutations=this._mutations.concat(new vi(t._key,Ld.NONE)),this},e.prototype.commit=function(){return No(this,void 0,void 0,function(){return ko(this,function(){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},e.prototype.verifyNotCommitted=function(){if(this._committed)throw new En(bn.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},e}(),Ml=function(){function o(o,t){this._key=o,this.firestore=t,this._firestoreClient=this.firestore.ensureClientConfigured()}return o.forPath=function(r,t){if(0!=r.length%2)throw new En(bn.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+r.canonicalString()+" has "+r.length);return new o(new dr(r),t)},Object.defineProperty(o.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"parent",{get:function(){return new ql(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),o.prototype.collection=function(o){if(Dn("DocumentReference.collection",arguments,1),Nn("DocumentReference.collection","non-empty string",1,o),!o)throw new En(bn.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var t=lr.fromString(o);return new ql(this._key.path.child(t),this.firestore)},o.prototype.isEqual=function(e){if(!(e instanceof o))throw Fn("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this._key.isEqual(e._key)},o.prototype.set=function(o,t){An("DocumentReference.set",arguments,1,2);var r=(t=ed("DocumentReference.set",t)).merge||t.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",o,t.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",o);return this._firestoreClient.write(r.toMutations(this._key,Ld.NONE))},o.prototype.update=function(o,t){for(var e=[],r=2,a;r<arguments.length;r++)e[r-2]=arguments[r];return a="string"==typeof o||o instanceof rl?(vn("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",o,t,e)):(Dn("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",o)),this._firestoreClient.write(a.toMutations(this._key,Ld.exists(!0)))},o.prototype.delete=function(){return Dn("DocumentReference.delete",arguments,0),this._firestoreClient.write([new vi(this._key,Ld.NONE)])},o.prototype.onSnapshot=function(){for(var a=[],t=0;t<arguments.length;t++)a[t]=arguments[t];An("DocumentReference.onSnapshot",arguments,1,4);var s={includeMetadataChanges:!1},d=0,l;"object"!=typeof a[d]||_i(a[d])||(qn("DocumentReference.onSnapshot",s=a[d],["includeMetadataChanges"]),Rn("DocumentReference.onSnapshot","boolean","includeMetadataChanges",s.includeMetadataChanges),d++);var c={includeMetadataChanges:s.includeMetadataChanges};return l=_i(a[d])?a[d]:(Nn("DocumentReference.onSnapshot","function",d,a[d]),kn("DocumentReference.onSnapshot","function",d+1,a[d+1]),kn("DocumentReference.onSnapshot","function",d+2,a[d+2]),{next:a[d],error:a[d+1],complete:a[d+2]}),this.onSnapshotInternal(c,l)},o.prototype.onSnapshotInternal=function(a,s){var n=this,t=function(e){console.error("Uncaught Error in onSnapshot:",e)};s.error&&(t=s.error.bind(s));var r=new ol({next:function(o){if(s.next){dn(1>=o.docs.size,"Too many documents returned on a document query");var t=o.docs.get(n._key);s.next(new Pl(n.firestore,n._key,t,o.fromCache,o.hasPendingWrites))}},error:t}),i=this._firestoreClient.listen(Kr.atPath(this._key.path),r,a);return function(){r.mute(),n._firestoreClient.unlisten(i)}},o.prototype.get=function(o){var a=this;return An("DocumentReference.get",arguments,0,1),od("DocumentReference.get",o),new Promise(function(r,e){o&&"cache"===o.source?a.firestore.ensureClientConfigured().getDocumentFromLocalCache(a._key).then(function(e){r(new Pl(a.firestore,a._key,e,!0,e instanceof yr&&e.hasLocalMutations))},e):a.getViaSnapshotListener(r,e,o)})},o.prototype.getViaSnapshotListener=function(o,e,a){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(n){r(),!n.exists&&n.metadata.fromCache?e(new En(bn.UNAVAILABLE,"Failed to get document because the client is offline.")):n.exists&&n.metadata.fromCache&&a&&"server"===a.source?e(new En(bn.UNAVAILABLE,"Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to \"server\" to retrieve the cached document.)")):o(n)},error:e})},o}(),_l=function(){function e(o,t){this.hasPendingWrites=o,this.fromCache=t}return e.prototype.isEqual=function(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache},e}(),Pl=function(){function o(o,t,e,a,r){this._firestore=o,this._key=t,this._document=e,this._fromCache=a,this._hasPendingWrites=r}return o.prototype.data=function(e){return An("DocumentSnapshot.data",arguments,0,1),e=td("DocumentSnapshot.data",e),this._document?this.convertObject(this._document.data,Rd.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},o.prototype.get=function(o,t){if(An("DocumentSnapshot.get",arguments,1,2),t=td("DocumentSnapshot.get",t),this._document){var r=this._document.data.field(Bi("DocumentSnapshot.get",o));if(void 0!==r)return this.convertValue(r,Rd.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(o.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"ref",{get:function(){return new Ml(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"metadata",{get:function(){return new _l(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),o.prototype.isEqual=function(e){if(!(e instanceof o))throw Fn("isEqual","DocumentSnapshot",1,e);return this._firestore===e._firestore&&this._fromCache===e._fromCache&&this._key.isEqual(e._key)&&(null===this._document?null===e._document:this._document.isEqual(e._document))},o.prototype.convertObject=function(e,o){var a=this,r={};return e.forEach(function(n,t){r[n]=a.convertValue(t,o)}),r},o.prototype.convertValue=function(o,t){if(o instanceof qr)return this.convertObject(o,t);if(o instanceof Fr)return this.convertArray(o,t);if(o instanceof Lr){var e=o.value(t),a=this._firestore.ensureClientConfigured().databaseId();return o.databaseId.isEqual(a)||Ho("Document "+this._key.path+" contains a document reference within a different database ("+o.databaseId.projectId+"/"+o.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+a.projectId+"/"+a.database+") instead."),new Ml(e,this._firestore)}return o.value(t)},o.prototype.convertArray=function(o,r){var e=this;return o.internalValue.map(function(o){return e.convertValue(o,r)})},o}(),Ll=function(a){function e(o,t,e,n,r){return a.call(this,o,t,e,n,r)||this}return Ao(e,a),e.prototype.data=function(o){var t=a.prototype.data.call(this,o);return dn("object"==typeof t,"Document in a QueryDocumentSnapshot should exist"),t},e}(Pl),Ol=function(){function s(o,t){this._query=o,this.firestore=t}return s.prototype.where=function(d,t,e){var n;Dn("Query.where",arguments,3),Nn("Query.where","non-empty string",2,t),xn("Query.where",3,e);var l=Bi("Query.where",d),i=Yr.fromString(t);if(l.isKeyField()){if(i===Yr.ARRAY_CONTAINS)throw new En(bn.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof e){if(""===e)throw new En(bn.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==e.indexOf("/"))throw new En(bn.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by FieldPath.documentId(), the value provided must be a plain document ID, but '"+e+"' contains a slash.");var o=this._query.path.child(lr.fromString(e));if(!dr.isDocumentKey(o))throw new En(bn.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+o+"' is not because it has an odd number of segments ("+o.length+").");n=new Lr(this.firestore._databaseId,new dr(o))}else{if(!(e instanceof Ml))throw new En(bn.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+On(e)+".");n=new Lr(this.firestore._databaseId,e._key)}}else n=this.firestore._dataConverter.parseQueryValue("Query.where",e);var a=Hr.create(l,i,n);return this.validateNewFilter(a),new s(this._query.addFilter(a),this.firestore)},s.prototype.orderBy=function(o,t){var e;if(An("Query.orderBy",arguments,1,2),kn("Query.orderBy","non-empty string",2,t),void 0===t||"asc"===t)e=Zr.ASCENDING;else{if("desc"!==t)throw new En(bn.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+t+"', expected 'asc' or 'desc'.");e=Zr.DESCENDING}if(null!==this._query.startAt)throw new En(bn.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new En(bn.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var a=Bi("Query.orderBy",o),r=new ei(a,e);return this.validateNewOrderBy(r),new s(this._query.addOrderBy(r),this.firestore)},s.prototype.limit=function(e){if(Dn("Query.limit",arguments,1),Nn("Query.limit","number",1,e),0>=e)throw new En(bn.INVALID_ARGUMENT,"Invalid Query. Query limit ("+e+") is invalid. Limit must be positive.");return new s(this._query.withLimit(e),this.firestore)},s.prototype.startAt=function(o){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];vn("Query.startAt",arguments,1);var a=this.boundFromDocOrFields("Query.startAt",o,t,!0);return new s(this._query.withStartAt(a),this.firestore)},s.prototype.startAfter=function(o){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];vn("Query.startAfter",arguments,1);var a=this.boundFromDocOrFields("Query.startAfter",o,t,!1);return new s(this._query.withStartAt(a),this.firestore)},s.prototype.endBefore=function(o){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];vn("Query.endBefore",arguments,1);var a=this.boundFromDocOrFields("Query.endBefore",o,t,!0);return new s(this._query.withEndAt(a),this.firestore)},s.prototype.endAt=function(o){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];vn("Query.endAt",arguments,1);var a=this.boundFromDocOrFields("Query.endAt",o,t,!1);return new s(this._query.withEndAt(a),this.firestore)},s.prototype.isEqual=function(e){if(!(e instanceof s))throw Fn("isEqual","Query",1,e);return this.firestore===e.firestore&&this._query.isEqual(e._query)},s.prototype.boundFromDocOrFields=function(a,t,e,n){if(xn(a,1,t),t instanceof Pl){if(0<e.length)throw new En(bn.INVALID_ARGUMENT,"Too many arguments provided to "+a+"().");var r=t;if(!r.exists)throw new En(bn.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+a+"().");return this.boundFromDocument(a,r._document,n)}var i=[t].concat(e);return this.boundFromFields(a,i,n)},s.prototype.boundFromDocument=function(d,t,e){for(var n=[],r=0,l=this._query.orderBy,o;r<l.length;r++)if(o=l[r],o.field.isKeyField())n.push(new Lr(this.firestore._databaseId,t.key));else{var c=t.field(o.field);if(c instanceof Or)throw new En(bn.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field \""+o.field+"\" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)");if(void 0===c){var s=o.field.canonicalString();throw new En(bn.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+s+"' (used as the orderBy) does not exist.")}n.push(c)}return new ti(n,e)},s.prototype.boundFromFields=function(d,t,e){var n=this._query.explicitOrderBy;if(t.length>n.length)throw new En(bn.INVALID_ARGUMENT,"Too many arguments provided to "+d+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var r=[],i=0,l;i<t.length;i++)if(l=t[i],n[i].field.isKeyField()){if("string"!=typeof l)throw new En(bn.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+d+"(), but got a "+typeof l);if(!this._query.isCollectionGroupQuery()&&-1!==l.indexOf("/"))throw new En(bn.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+d+"() must be a plain document ID, but '"+l+"' contains a slash.");var p=this._query.path.child(lr.fromString(l));if(!dr.isDocumentKey(p))throw new En(bn.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+d+"() must result in a valid document path, but '"+p+"' is not because it contains an odd number of segments.");var s=new dr(p);r.push(new Lr(this.firestore._databaseId,s))}else{var u=this.firestore._dataConverter.parseQueryValue(d,l);r.push(u)}return new ti(r,e)},s.prototype.onSnapshot=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];An("Query.onSnapshot",arguments,1,4);var a={},s=0,d;return"object"!=typeof o[s]||_i(o[s])||(qn("Query.onSnapshot",a=o[s],["includeMetadataChanges"]),Rn("Query.onSnapshot","boolean","includeMetadataChanges",a.includeMetadataChanges),s++),d=_i(o[s])?o[s]:(Nn("Query.onSnapshot","function",s,o[s]),kn("Query.onSnapshot","function",s+1,o[s+1]),kn("Query.onSnapshot","function",s+2,o[s+2]),{next:o[s],error:o[s+1],complete:o[s+2]}),this.onSnapshotInternal(a,d)},s.prototype.onSnapshotInternal=function(s,d){var e=this,t=function(e){console.error("Uncaught Error in onSnapshot:",e)};d.error&&(t=d.error.bind(d));var n=new ol({next:function(o){d.next&&d.next(new xl(e.firestore,e._query,o))},error:t}),i=this.firestore.ensureClientConfigured(),o=i.listen(this._query,n,s);return function(){n.mute(),i.unlisten(o)}},s.prototype.get=function(o){var a=this;return An("Query.get",arguments,0,1),od("Query.get",o),new Promise(function(r,e){o&&"cache"===o.source?a.firestore.ensureClientConfigured().getDocumentsFromLocalCache(a._query).then(function(e){r(new xl(a.firestore,a._query,e))},e):a.getViaSnapshotListener(r,e,o)})},s.prototype.getViaSnapshotListener=function(o,e,a){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(n){r(),n.metadata.fromCache&&a&&"server"===a.source?e(new En(bn.UNAVAILABLE,"Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to \"server\" to retrieve the cached documents.)")):o(n)},error:e})},s.prototype.validateNewFilter=function(o){if(o instanceof Xr)if(o.isInequality()){var t=this._query.getInequalityFilterField();if(null!==t&&!t.isEqual(o.field))throw new En(bn.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+t.toString()+"' and '"+o.field.toString()+"'");var e=this._query.getFirstOrderByField();null!==e&&this.validateOrderByAndInequalityMatch(o.field,e)}else if(o.op===Yr.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new En(bn.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},s.prototype.validateNewOrderBy=function(o){if(null===this._query.getFirstOrderByField()){var t=this._query.getInequalityFilterField();null!==t&&this.validateOrderByAndInequalityMatch(t,o.field)}},s.prototype.validateOrderByAndInequalityMatch=function(o,t){if(!t.isEqual(o))throw new En(bn.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+o.toString()+"' and so you must also use '"+o.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+t.toString()+"' instead.")},s}(),xl=function(){function o(o,t,e){this._firestore=o,this._originalQuery=t,this._snapshot=e,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new _l(e.hasPendingWrites,e.fromCache)}return Object.defineProperty(o.prototype,"docs",{get:function(){var o=[];return this.forEach(function(e){return o.push(e)}),o},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),o.prototype.forEach=function(o,e){var a=this;An("QuerySnapshot.forEach",arguments,1,2),Nn("QuerySnapshot.forEach","function",1,o),this._snapshot.docs.forEach(function(r){o.call(e,a.convertToDocumentImpl(r))})},Object.defineProperty(o.prototype,"query",{get:function(){return new Ol(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),o.prototype.docChanges=function(o){o&&(qn("QuerySnapshot.docChanges",o,["includeMetadataChanges"]),Rn("QuerySnapshot.docChanges","boolean","includeMetadataChanges",o.includeMetadataChanges));var t=o&&o.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new En(bn.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(s,i,d){{if(d.oldDocs.isEmpty()){var o=0,l;return d.docChanges.map(function(r){var t=new Ll(s,r.doc.key,r.doc,d.fromCache,d.mutatedKeys.has(r.doc.key));return dn(r.type===Wi.Added,"Invalid event type for first snapshot"),dn(!l||0>d.query.docComparator(l,r.doc),"Got added events in wrong order"),l=r.doc,{type:"added",doc:t,oldIndex:-1,newIndex:o++}})}var c=d.oldDocs;return d.docChanges.filter(function(e){return i||e.type!==Wi.Metadata}).map(function(o){var t=new Ll(s,o.doc.key,o.doc,d.fromCache,d.mutatedKeys.has(o.doc.key)),e=-1,a=-1;return o.type!==Wi.Added&&(dn(0<=(e=c.indexOf(o.doc.key)),"Index for document not found"),c=c.delete(o.doc.key)),o.type!==Wi.Removed&&(c=c.add(o.doc),a=c.indexOf(o.doc.key)),{type:function(e){return e===Wi.Added?"added":e===Wi.Modified||e===Wi.Metadata?"modified":e===Wi.Removed?"removed":rn("Unknown change type: "+e)}(o.type),doc:t,oldIndex:e,newIndex:a}})}}(this._firestore,t,this._snapshot),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges},o.prototype.isEqual=function(e){if(!(e instanceof o))throw Fn("isEqual","QuerySnapshot",1,e);return this._firestore===e._firestore&&this._originalQuery.isEqual(e._originalQuery)&&this._snapshot.isEqual(e._snapshot)},o.prototype.convertToDocumentImpl=function(e){return new Ll(this._firestore,e.key,e,this.metadata.fromCache,this._snapshot.mutatedKeys.has(e.key))},o}();["length","forEach","map"].concat("undefined"==typeof Symbol?[]:[Symbol.iterator]).forEach(function(e){try{Object.defineProperty(xl.prototype.docChanges,e,{get:function(){return function(){throw new En(bn.INVALID_ARGUMENT,"QuerySnapshot.docChanges has been changed from a property into a method, so usages like \"querySnapshot.docChanges\" should become \"querySnapshot.docChanges()\"")}()}})}catch(e){}});var ql=function(o){function e(r,t){var e=o.call(this,Kr.atPath(r),t)||this;if(1!=r.length%2)throw new En(bn.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+r.canonicalString()+" has "+r.length);return e}return Ao(e,o),Object.defineProperty(e.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var e=this._query.path.popLast();return e.isEmpty()?null:new Ml(new dr(e),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.doc=function(o){if(An("CollectionReference.doc",arguments,0,1),0===arguments.length&&(o=Sn.newId()),Nn("CollectionReference.doc","non-empty string",1,o),""===o)throw new En(bn.INVALID_ARGUMENT,"Document path must be a non-empty string");var r=lr.fromString(o);return Ml.forPath(this._query.path.child(r),this.firestore)},e.prototype.add=function(o){Dn("CollectionReference.add",arguments,1),Nn("CollectionReference.add","object",1,o);var t=this.doc();return t.set(o).then(function(){return t})},e}(Ol),Fl=mn(kl,"Use firebase.firestore() instead."),Vl=mn(wl,"Use firebase.firestore().runTransaction() instead."),Bl=mn(Rl,"Use firebase.firestore().batch() instead."),Ul=mn(Ml,"Use firebase.firestore().doc() instead."),Ql=mn(Pl),Kl=mn(Ll),Wl=mn(Ol),Gl=mn(xl),zl=mn(ql,"Use firebase.firestore().collection() instead."),jl={Firestore:Fl,GeoPoint:ir,Timestamp:or,Blob:rr,Transaction:Vl,WriteBatch:Bl,DocumentReference:Ul,DocumentSnapshot:Ql,Query:Wl,QueryDocumentSnapshot:Kl,QuerySnapshot:Gl,CollectionReference:zl,FieldPath:rl,FieldValue:gl,setLogLevel:kl.setLogLevel,CACHE_SIZE_UNLIMITED:vl};ad(vo)}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}});